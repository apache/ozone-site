

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Apache Ozone Documentation">

    <title>Documentation for Apache Ozone</title>

    
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    
    <link href="../css/ozonedoc.css" rel="stylesheet">

    
    
    <link href="../swagger-resources/swagger-ui.css" rel="stylesheet">

    
    <script>
      var _paq = window._paq = window._paq || [];
      

       
      _paq.push(['disableCookies']);
      

      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '34']);
        var d=document, g=d.createElement('script'),
s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    

  </head>


  <body>

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="../index.html" class="navbar-left ozone-logo">
        <img src="../ozone-logo-small.png"/>
      </a>
      <a class="navbar-brand hidden-xs" href="../index.html">
        Apache Ozone/HDDS Documentation
      </a>
      <a class="navbar-brand visible-xs-inline" href="#">Apache Ozone</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/apache/ozone">Source</a></li>
        <li><a href="https://ozone.apache.org">Apache Ozone</a></li>
        <li><a href="https://apache.org">ASF</a></li>
      </ul>
    </div>
  </div>
</nav>

    <div class="container-fluid">
      <div class="row">
        
<div class="col-sm-2 col-md-2 sidebar" id="sidebar">
  <ul class="nav nav-sidebar">
    
    
        
            <li class="">
                
                   <a href="../index.html">
                

                    
                    <span>Overview</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../start.html">
                

                    
                    <span>Getting Started</span>
                </a>
            </li>
        
    
        
            <li class="">
                <a href="../concept.html">
                    
                    <span>Architecture</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../concept/overview.html">Overview</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../concept/ozonemanager.html">
                                 
                                 <span>Ozone Manager</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../concept/volumesbucketskeys.html">Volumes, Buckets, and Keys</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/storagecontainermanager.html">Storage Container Manager</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/containers.html">Containers</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/datanodes.html">Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/ozones3gateway.html">Ozone S3 Gateway</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/recon.html">Recon</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/networkports.html">Network Ports</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/comparison.html">Comparison with Other Storage Technologies</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../feature.html">
                    
                    <span>Features</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../feature/decommission.html">Decommissioning</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/om-ha.html">OM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/erasurecoding.html">Ozone Erasure Coding</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/snapshot.html">Ozone Snapshot</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/scm-ha.html">SCM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/streaming-write-pipeline.html">Streaming Write Pipeline</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/dn-merge-rocksdb.html">Merge Container RocksDB in DN</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/prefixfso.html">Prefix based File System Optimization</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/topology.html">Topology awareness</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/quota.html">Quota in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/recon.html">Recon Server</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/observability.html">Observability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/nonrolling-upgrade.html">Non-Rolling Upgrades and Downgrades</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../feature/s3-multi-tenancy.html">
                                 
                                 <span>S3 Multi-Tenancy</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-setup.html">Setup</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-tenant-commands.html">Tenant commands</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-access-control.html">Access Control</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/reconfigurability.html">Reconfigurability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/multi-raft-support.html">Multi-Raft Support in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/trash.html">Trash</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../integration.html">
                    
                    <span>Application Integrations</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../integration/distcp.html">Hadoop DistCp</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/hive.html">Hive</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/impala.html">Impala</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../interface.html">
                    
                    <span>Client Interfaces</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../interface/ofs.html">Ofs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/o3fs.html">O3fs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../interface/s3.html">
                                 
                                 <span>S3 Protocol</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../interface/cyberduckozones3.html">Accessing Ozone S3 via CyberDuck</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/cli.html">Command Line Interface</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/reconapi.html">Recon API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/javaapi.html">Java API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/python.html">Accessing Apache Ozone from Python</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/csi.html">CSI Protocol</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/httpfs.html">HttpFS Gateway</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/native-cpp.html">Native C/C&#43;&#43; Client Access to Ozone</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../security.html">
                    
                    <span>Security</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../security/secureozone.html">Securing Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingtde.html">Transparent Data Encryption</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/gdpr.html">GDPR in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingdatanodes.html">Securing Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingozonehttp.html">Securing HTTP</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securings3.html">Securing S3</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securityacls.html">Ozone ACLs</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/protect-in-transit-traffic.html">Protect In-Transit Traffic</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securitywithranger.html">Apache Ranger</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                
                   <a href="../tools.html">
                

                    
                    <span>Tools</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../recipe.html">
                

                    
                    <span>Recipes</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../troubleshooting.html">
                

                    
                    <span>Troubleshooting</span>
                </a>
            </li>
        
    
    <li><a href="../design.html"><span><b>Design docs</b></span></a></li>
    <li class="visible-xs"><a href="#">References</a>
    <ul class="nav">
        <li><a href="https://github.com/apache/ozone"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Source</a></li>
        <li><a href="https://ozone.apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Apache Ozone</a></li>
        <li><a href="https://apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> ASF</a></li>
    </ul></li>
  </ul>

</div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main-content">
            <div class="col-md-9">
                <h1><a href="https://issues.apache.org/jira/browse/HDDS-12929">[HDDS-12929]</a> Full Volume Handling (implemented) </h1>
                <div><i>Authors: Siddhant Sangwan, Sumit Agrawal</i><div class="pull-right">2025-05-12</div></div>
                <p>&nbsp</p>

                <div class="panel panel-success">
                    <div class="panel-heading">Summary</div>
                    <div class="panel-body">
                        Immediately trigger Datanode heartbeat on detecting full volume
                    </div>
                </div>

              <!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->
<blockquote>
<p><strong>Note</strong>: The feature described here was implemented in <a href="https://github.com/apache/ozone/pull/8590">pull request #8590</a>. This document reflects the final, merged design.</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>Trigger datanode heartbeat immediately when the container being written to is (close) to full, or volume is full,
or container is unhealthy, while handling a write request. The immediate heartbeat will contain close container action.
The overall objective is to avoid Datanode disks from getting completely full and preventing degradation of write
performance.</p>
<h2 id="problem">Problem</h2>
<p>When a Datanode volume is close to full, the SCM may not be immediately aware of this because storage reports are only
sent to it every one minute (<code>HDDS_NODE_REPORT_INTERVAL_DEFAULT = &quot;60s&quot;</code>). Additionally, SCM only has stale
information about the current size of a container because container size is only updated when an Incremental Container
Report (event based, for example when a container transitions from open to closing state) is received or a Full
Container Report (<code>HDDS_CONTAINER_REPORT_INTERVAL_DEFAULT = &quot;60m&quot;</code>) is received. This can lead to the SCM
over-allocating blocks to containers on a Datanode volume that has already reached the min free space boundary.</p>
<p>In the future, in <a href="https://issues.apache.org/jira/browse/HDDS-12151">https://issues.apache.org/jira/browse/HDDS-12151</a> we plan to fail writes for containers on a volume
that has reached the min free space boundary.
So, in the future, when the Datanode fails writes for such a volume, overall write performance will drop because the
client will have to request for a different set of blocks.</p>
<p>Before this change, a close container action was queued to be sent in the next heartbeat, when:</p>
<ol>
<li>Container was at 90% capacity.</li>
<li>Volume was full, <strong>counting committed space</strong>. That is <code>available - reserved - committed - min free space &lt;= 0</code>.</li>
<li>Container was <code>UNHEALTHY</code>.</li>
</ol>
<p>But since the next heartbeat could be sent up to 30 seconds later in the worst case, this reaction time was too slow.
This design proposes sending Datanode heartbeat immediately so SCM can get the close container action
immediately. This will help in reducing performance drop because of write failures when
<a href="https://issues.apache.org/jira/browse/HDDS-12151">https://issues.apache.org/jira/browse/HDDS-12151</a> is implemented in the future.</p>
<h3 id="the-definition-of-a-full-volume">The definition of a full volume</h3>
<p>Previously, a volume was considered full if the following method returned true. It accounts for available space,
committed space, min free space and reserved space (<code>available</code> already considers <code>reserved</code> space):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getUsableSpace</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">long</span> available, <span style="color:#66d9ef">long</span> committed, <span style="color:#66d9ef">long</span> minFreeSpace) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> available <span style="color:#f92672">-</span> committed <span style="color:#f92672">-</span> minFreeSpace;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Counting committed space here, <em>when sending close container action</em>, is a bug - we only want to close the container if
<code>available - reserved - minFreeSpace &lt;= 0</code>.</p>
<h2 id="non-goals">Non Goals</h2>
<p>Failing the write if it exceeds the min free space boundary (<a href="https://issues.apache.org/jira/browse/HDDS-12151">https://issues.apache.org/jira/browse/HDDS-12151</a>) is not
discussed here.</p>
<h2 id="proposed-solution">Proposed Solution</h2>
<h3 id="proposal-for-immediately-triggering-datanode-heartbeat">Proposal for immediately triggering Datanode heartbeat</h3>
<p>We will immediately trigger the heartbeat when:</p>
<ol>
<li>The container is (close) to full (this is existing behaviour, the container full check already exists).</li>
<li>The volume is <strong>full EXCLUDING committed space</strong> (<code>available - reserved available - min free &lt;= 0</code>). This is because
when a volume
is full INCLUDING committed space (<code>available - reserved available - committed - min free &lt;= 0</code>), open containers
can still accept writes. So the current behaviour of sending a close container action when volume is full including
committed space is a bug.</li>
<li>The container is unhealthy (this is existing behaviour).</li>
</ol>
<p>Logic to trigger a heartbeat immediately already exists - we just need to call the method when needed. So, in
<code>HddsDispatcher</code>, when handling a request:</p>
<ol>
<li>For every write request:
<ol>
<li>Check the above three conditions
<ol>
<li>If true, queue the <code>ContainerAction</code> to the context as before, then immediately trigger the heartbeat using:</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre tabindex="0"><code>context.getParent().triggerHeartbeat();
</code></pre><h4 id="throttling">Throttling</h4>
<p>Throttling is required so the Datanode doesn&rsquo;t send multiple immediate heartbeats for the same container. We can have
per-container throttling, where we trigger an immediate heartbeat once for a particular container, and after that
container actions for that container can only be sent in the regular, scheduled heartbeats. Meanwhile, immediate
heartbeats can still be triggered for different containers.</p>
<p>Here&rsquo;s a visualisation to show this. The letters (A, B, C etc.) denote events and timestamp is the time at which
an event occurs.</p>
<pre tabindex="0"><code>Write Call 1:
/ A, timestamp: 0/-------------/B, timestamp: 5/

Write Call 2, in-parallel with 1:
------------------------------ /C, timestamp: 5/

Write Call 3, in-parallel with 1 and 2:
---------------------------------------/D, timestamp: 7/

Write Call 4:
------------------------------------------------------------------------/E, timestamp: 30/

Events:
A: Last, regular heartbeat
B: Volume 1 detected as full while writing to Container 1, heartbeat triggered
C: Volume 1 again detected as full while writing to Container 2, heartbeat triggered
D: Container 1 detected as full, heartbeat throttled
E: Volume 1 detected as full while writing to Container 2, Container Action sent in regular heartbeat 
</code></pre><p>A simple and thread safe way to implement this is to have an <code>AtomicBoolean</code> for each container in the <code>ContainerData</code>
class that can be used to check if an immediate heartbeat has already been triggered for that container. The memory
impact of introducing a new member variable in <code>ContainerData</code> for each container is quite small. Consider:</p>
<ul>
<li>A Datanode with 600 TB disk space.</li>
<li>Container size is 5 GB.</li>
<li>Number of containers = 600 TB / 5 GB = 120,000.</li>
<li>For each container, we&rsquo;ll have an <code>AtomicBoolean</code>, which just has one field that counts: <code>private volatile int value</code>.
<ul>
<li>Static fields don&rsquo;t count.</li>
</ul>
</li>
<li>An int is 4 bytes in Java. Assuming that other overhead for a Java object brings the size of the object to ~20 bytes.</li>
<li>20 bytes * 120,000 = ~2.4 MB.</li>
</ul>
<p>For code implementation, see <a href="https://github.com/apache/ozone/pull/8590">https://github.com/apache/ozone/pull/8590</a>.</p>
<h2 id="alternatives">Alternatives</h2>
<h3 id="preventing-over-allocation-of-blocks-in-the-scm">Preventing over allocation of blocks in the SCM</h3>
<p>The other part of the problem is that SCM has stale information about the size of the container and ends up
over-allocating blocks (beyond the container&rsquo;s 5 GB size) to the same container. Solving this problem is complicated.
We could track how much space we&rsquo;ve allocated to a container in the SCM - this is doable on the surface but won&rsquo;t
actually work well. That&rsquo;s because SCM is asked for a block (256 MB), but SCM doesn&rsquo;t know how much data a client will
actually write to that block file. The client may only write 1 MB, for example. So SCM could track that it has already
allocated 5 GB to a container, and will open another container for incoming requests, but the client may actually only
write 1GB. This would lead to a lot of open containers when we have 10k requests/second.</p>
<p>At this point, we&rsquo;ve decided not to do anything about this.</p>
<h3 id="regularly-sending-open-container-reports">Regularly sending open container reports</h3>
<p>Sending open container reports regularly (every 30 seconds for example) can help a little bit, but won&rsquo;t solve the
problem. We won&rsquo;t take this approach for now.</p>
<h3 id="sending-storage-reports-in-immediate-heartbeats">Sending storage reports in immediate heartbeats</h3>
<p>We considered triggering an immediate heartbeat every time the Datanode detects a volume is full
while handling a write request, with per volume throttling. To each immediate heartbeat, we would the storage
reports of all volumes in the Datanode + Close Container Action for the particular container being written to. While
this would update the storage stats of a volume in the SCM faster, which the SCM can subsequently use to decide
whether to include that Datanode in a new pipeline, the per volume throttling has a drawback. It wouldn&rsquo;t let us
send close container actions for other containers. We decided not to take this approach.</p>
<h2 id="implementation-plan">Implementation Plan</h2>
<ol>
<li>HDDS-13045: For triggering immediate heartbeat. Already merged - <a href="https://github.com/apache/ozone/pull/8590">https://github.com/apache/ozone/pull/8590</a>.</li>
<li>HDDS-12151: Fail a write call if it exceeds min free space boundary (not the focus of this doc, just mentioned
here).</li>
</ol>

            </div>

        </div>
      </div>
    </div>



<footer class="footer">
  <div class="container">
    <span class="small text-muted">
      Version: 2.1.0-SNAPSHOT, Last Modified: July 7, 2025 <a class="hide-child link primary-color" href="https://github.com/apache/ozone/commit/f7270513a5f848f7e43c6d33acfeb2d238393311">f7270513a5</a>
    </span>
  </div>
</footer>



<script src="../js/jquery-3.5.1.min.js"></script>
<script src="../js/ozonedoc.js"></script>
<script src="../js/bootstrap.min.js"></script>


  </body>
</html>
