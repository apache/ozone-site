

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Apache Ozone Documentation">

    <title>Documentation for Apache Ozone</title>

    
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    
    <link href="../css/ozonedoc.css" rel="stylesheet">

    
    
    <link href="../swagger-resources/swagger-ui.css" rel="stylesheet">

    
    <script>
      var _paq = window._paq = window._paq || [];
      

       
      _paq.push(['disableCookies']);
      

      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '34']);
        var d=document, g=d.createElement('script'),
s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    

  </head>


  <body>

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="../index.html" class="navbar-left ozone-logo">
        <img src="../ozone-logo-small.png"/>
      </a>
      <a class="navbar-brand hidden-xs" href="../index.html">
        Apache Ozone/HDDS Documentation
      </a>
      <a class="navbar-brand visible-xs-inline" href="#">Apache Ozone</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/apache/ozone">Source</a></li>
        <li><a href="https://ozone.apache.org">Apache Ozone</a></li>
        <li><a href="https://apache.org">ASF</a></li>
      </ul>
    </div>
  </div>
</nav>

    <div class="container-fluid">
      <div class="row">
        
<div class="col-sm-2 col-md-2 sidebar" id="sidebar">
  <ul class="nav nav-sidebar">
    
    
        
            <li class="">
                
                   <a href="../index.html">
                

                    
                    <span>An Introduction to Apache Ozone</span>
                </a>
            </li>
        
    
        
            <li class="">
                <a href="../start/index.html">
                    
                    <span>Getting Started</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../start/productiondeployment.html">Production Deployment</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../concept/index.html">
                    
                    <span>Architecture</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../concept/overview.html">Overview</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../concept/ozonemanager.html">
                                 
                                 <span>Ozone Manager</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../concept/volumesbucketskeys.html">Volumes, Buckets, and Keys</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/storagecontainermanager.html">Storage Container Manager</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/containers.html">Containers</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/datanodes.html">Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../concept/ozones3gateway.html">
                                 
                                 <span>Ozone S3 Gateway</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../concept/s3-gateway-load-balancing.html">S3 Gateway Load Balancing</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/recon.html">Recon</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/networkports.html">Network Ports</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/comparison.html">Comparison with Other Storage Technologies</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/rocksdb.html">RocksDB in Apache Ozone</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../feature/index.html">
                    
                    <span>Features</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../feature/decommission.html">Decommissioning</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/diskbalancer.html">DiskBalancer</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/snapshotdefragmentation.html">Improve Ozone Snapshot Scale with Snapshot Defragmentation</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/om-ha.html">OM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/erasurecoding.html">Ozone Erasure Coding</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../feature/snapshot.html">
                                 
                                 <span>Ozone Snapshot</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../feature/snapshot-configuration-properties.html">Snapshot Configuration Properties</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/scm-ha.html">SCM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/streaming-write-pipeline.html">Streaming Write Pipeline</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/dn-merge-rocksdb.html">Merge Container RocksDB in DN</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/prefixfso.html">Prefix based File System Optimization</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/topology.html">Topology awareness</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/quota.html">Quota in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/recon.html">Recon Server</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/observability.html">Observability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/nonrolling-upgrade.html">Non-Rolling Upgrades and Downgrades</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../feature/s3-multi-tenancy.html">
                                 
                                 <span>S3 Multi-Tenancy</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-setup.html">Setup</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-tenant-commands.html">Tenant commands</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-access-control.html">Access Control</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/reconfigurability.html">Dynamic Property Reload</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/containerbalancer.html">Container Balancer</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/maintenance.html">Maintenance Mode</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/multi-raft-support.html">Multi-Raft Support in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/trash.html">Trash</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../integration/index.html">
                    
                    <span>Application Integrations</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../integration/distcp.html">Hadoop DistCp</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/hive.html">Hive</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/impala.html">Impala</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../interface/index.html">
                    
                    <span>Client Interfaces</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../interface/ofs.html">Ofs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/o3fs.html">O3fs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../interface/s3.html">
                                 
                                 <span>S3 Protocol</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../interface/cyberduckozones3.html">Accessing Ozone S3 via CyberDuck</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/cli.html">Command Line Interface</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/reconapi.html">Recon API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/javaapi.html">Java API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/python.html">Accessing Apache Ozone from Python</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/csi.html">CSI Protocol</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/httpfs.html">HttpFS Gateway</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/native-cpp.html">Native C/C&#43;&#43; Client Access to Ozone</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../security/index.html">
                    
                    <span>Security</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../security/secureozone.html">Securing Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingtde.html">Transparent Data Encryption</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/gdpr.html">GDPR in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingdatanodes.html">Securing Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingozonehttp.html">Securing HTTP</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securings3.html">Securing S3</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securityacls.html">Ozone ACLs</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/protect-in-transit-traffic.html">Protect In-Transit Traffic</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securitywithranger.html">Apache Ranger</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                
                   <a href="../tools/index.html">
                

                    
                    <span>Tools</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../recipe/index.html">
                

                    
                    <span>Recipes</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../troubleshooting/index.html">
                

                    
                    <span>Troubleshooting</span>
                </a>
            </li>
        
    
    <li><a href="../design.html"><span><b>Design docs</b></span></a></li>
    <li class="visible-xs"><a href="#">References</a>
    <ul class="nav">
        <li><a href="https://github.com/apache/ozone"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Source</a></li>
        <li><a href="https://ozone.apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Apache Ozone</a></li>
        <li><a href="https://apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> ASF</a></li>
    </ul></li>
  </ul>

</div>

        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main-content">
            <div class="col-md-9">
                <h1><a href="https://issues.apache.org/jira/browse/HDDS-13117">[HDDS-13117]</a> S3 Conditional Requests (draft) </h1>
                <div><i>Authors: Chu Cheng Li</i><div class="pull-right">2025-11-20</div></div>
                <p>&nbsp</p>

                <div class="panel panel-success">
                    <div class="panel-heading">Summary</div>
                    <div class="panel-body">
                        Design to support S3 conditional requests for atomic operations.
                    </div>
                </div>

              <!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->
<h1 id="s3-conditional-requests-design">S3 Conditional Requests Design</h1>
<h2 id="background">Background</h2>
<p>AWS S3 supports conditional requests using HTTP conditional headers, enabling atomic operations, cache optimization, and preventing race conditions. This includes:</p>
<ul>
<li><strong>Conditional Writes</strong> (PutObject): <code>If-Match</code> and <code>If-None-Match</code> headers for atomic operations</li>
<li><strong>Conditional Reads</strong> (GetObject, HeadObject): <code>If-Match</code>, <code>If-None-Match</code>, <code>If-Modified-Since</code>, <code>If-Unmodified-Since</code> for cache validation</li>
<li><strong>Conditional Copy</strong> (CopyObject): Conditions on both source and destination objects</li>
</ul>
<h3 id="current-state">Current State</h3>
<ul>
<li>HDDS-10656 implemented atomic rewrite using <code>expectedDataGeneration</code></li>
<li>OM HA uses single Raft group with single applier thread (Ratis StateMachineUpdater)</li>
<li>S3 gateway doesn&rsquo;t expose conditional headers to OM layer</li>
</ul>
<h2 id="use-cases">Use Cases</h2>
<h3 id="conditional-writes">Conditional Writes</h3>
<ul>
<li><strong>Atomic key rewrites</strong>: Prevent race conditions when updating existing objects</li>
<li><strong>Create-only semantics</strong>: Prevent accidental overwrites (<code>If-None-Match: *</code>)</li>
<li><strong>Optimistic locking</strong>: Enable concurrent access with conflict detection</li>
<li><strong>Leader election</strong>: Implement distributed coordination using S3 as backing store</li>
</ul>
<h3 id="conditional-reads">Conditional Reads</h3>
<ul>
<li><strong>Bandwidth optimization</strong>: Avoid downloading unchanged objects (304 Not Modified)</li>
<li><strong>HTTP caching</strong>: Support standard browser/CDN caching semantics</li>
<li><strong>Conditional processing</strong>: Only process objects that meet specific criteria</li>
</ul>
<h3 id="conditional-copy">Conditional Copy</h3>
<ul>
<li><strong>Atomic copy operations</strong>: Copy only if source/destination meets specific conditions</li>
<li><strong>Prevent overwrite</strong>: Copy only if destination doesn&rsquo;t exist</li>
</ul>
<h2 id="specification">Specification</h2>
<h3 id="aws-s3-conditional-write-specification">AWS S3 Conditional Write Specification</h3>
<h4 id="if-none-match-header">If-None-Match Header</h4>
<pre tabindex="0"><code>If-None-Match: &#34;*&#34;
</code></pre><ul>
<li>Succeeds only if object does NOT exist</li>
<li>Returns <code>412 Precondition Failed</code> if object exists</li>
<li>Primary use case: Create-only semantics</li>
</ul>
<h4 id="if-match-header">If-Match Header</h4>
<pre tabindex="0"><code>If-Match: &#34;&lt;etag&gt;&#34;
</code></pre><ul>
<li>Succeeds only if object EXISTS and ETag matches</li>
<li>Returns <code>412 Precondition Failed</code> if object doesn&rsquo;t exist or ETag mismatches</li>
<li>Primary use case: Atomic updates (compare-and-swap)</li>
</ul>
<h4 id="restrictions">Restrictions</h4>
<ul>
<li>Cannot use both headers together in same request</li>
<li>No additional charges for failed conditional requests</li>
</ul>
<h3 id="aws-s3-conditional-read-specification">AWS S3 Conditional Read Specification</h3>
<p>TODO</p>
<h3 id="aws-s3-conditional-copy-specification">AWS S3 Conditional Copy Specification</h3>
<p>TODO</p>
<h2 id="implementation">Implementation</h2>
<h3 id="aws-s3-conditional-write-implementation">AWS S3 Conditional Write Implementation</h3>
<p>The implementation aims to minimize Redundant RPCs (RTT) while ensuring strict atomicity for conditional operations.</p>
<ul>
<li><strong>If-None-Match</strong> utilizes the atomic &ldquo;Create-If-Not-Exists&rdquo; capability (<a href="https://issues.apache.org/jira/browse/HDDS-13963" title="null">HDDS-13963</a>).</li>
<li><strong>If-Match</strong> optimizes the happy path by pushing ETag validation directly into the Ozone Manager&rsquo;s write path, avoiding preliminary read operations.</li>
</ul>
<h4 id="if-none-match-implementation">If-None-Match Implementation</h4>
<p>This implementation ensures strict create-only semantics by utilizing a specific generation ID marker.</p>
<p>In <code>OzoneConsts.java</code>, add the <code>-1</code> as a constant for readability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Special value for expectedDataGeneration to indicate &#34;Create-If-Not-Exists&#34; semantics.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * When used with If-None-Match conditional requests, this ensures atomicity:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * if a concurrent write commits between Create and Commit phases, the commit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * fails the validation check, preserving strict create-if-not-exists semantics.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> EXPECTED_DATA_GENERATION_CREATE_IF_NOT_EXISTS <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1L;
</span></span></code></pre></div><h5 id="s3-gateway-layer">S3 Gateway Layer</h5>
<ol>
<li>Parse <code>If-None-Match: *</code>.</li>
<li>Set <code>existingKeyGeneration = OzoneConsts.EXPECTED_DATA_GENERATION_CREATE_IF_NOT_EXISTS</code>.</li>
<li>Call <code>RpcClient.rewriteKey()</code>.</li>
</ol>
<h5 id="om-create-phase">OM Create Phase</h5>
<ol>
<li>OM receives request with <code>expectedDataGeneration == OzoneConsts.EXPECTED_DATA_GENERATION_CREATE_IF_NOT_EXISTS</code>.</li>
<li><strong>Pre-check</strong>: If key is already in the OpenKeyTable or KeyTable, throw <code>KEY_ALREADY_EXISTS</code>.</li>
<li>If not exists, proceed to create the open key entry.</li>
</ol>
<h5 id="om-commit-phase-atomicity">OM Commit Phase (Atomicity)</h5>
<ol>
<li>During the commit phase (or strict atomic create), the OM validates that the key still does not exist.</li>
<li>If a concurrent client created the key between the Create and Commit phases, the transaction fails with <code>KET_GENERATION_MISMATCH</code>.</li>
</ol>
<h5 id="race-condition-handling">Race Condition Handling</h5>
<p>Using <code>OzoneConsts.EXPECTED_DATA_GENERATION_CREATE_IF_NOT_EXISTS = -1</code> ensures atomicity. If a concurrent write (Client B) commits between Client A&rsquo;s Create and Commit,
Client A&rsquo;s commit fails the <code>CREATE IF NOT EXISTS</code> validation check, preserving strict create-if-not-exists semantics.</p>
<blockquote>
<p><strong>Note</strong>: This ability will be added along with <a href="https://issues.apache.org/jira/browse/HDDS-13963">HDDS-13963</a> (Atomic Create-If-Not-Exists).</p>
</blockquote>
<h4 id="if-match-implementation">If-Match Implementation</h4>
<p>To optimize performance and reduce latency, we avoid a pre-flight check (GetS3KeyDetails) and instead validate the ETag during the OM Write operation.
This requires adding an optional <code>expectedETag</code> field to <code>KeyArgs</code>. This approach optimizes the &ldquo;happy path&rdquo; (successful match) by removing an extra network round trip.
For failing requests, they still incur the cost of a write RPC and Raft log entry, but this is acceptable under optimistic concurrency control assumptions.</p>
<h5 id="s3-gateway-layer-1">S3 Gateway Layer</h5>
<ol>
<li>Parse <code>If-Match: &quot;&lt;etag&gt;&quot;</code> header.</li>
<li>Populate <code>KeyArgs</code> with the parsed <code>expectedETag</code>.</li>
<li>Send the write request (CreateKey) to OM.</li>
</ol>
<h5 id="om-create-phase-1">OM Create Phase</h5>
<p>Validation is performed within the <code>validateAndUpdateCache</code> method to ensure atomicity within the Ratis state machine application.</p>
<ol>
<li><strong>Locking</strong>: The OM acquires the write lock for the bucket/key.</li>
<li><strong>Key Lookup</strong>: Retrieve the existing key from <code>KeyTable</code>.</li>
<li><strong>Validation</strong>:
<ul>
<li><strong>Key Not Found</strong>: If the key does not exist, throw <code>KEY_NOT_FOUND</code> (maps to S3 412).</li>
<li><strong>No ETag Metadata</strong>: If the existing key (e.g., uploaded via OFS) does not have an ETag property, throw <code>ETAG_NOT_AVAILABLE</code> (maps to S3 412). The precondition cannot be evaluated, so we must fail rather than silently proceed.</li>
<li><strong>ETag Mismatch</strong>: Compare <code>existingKey.ETag</code> with <code>expectedETag</code>. If they do not match, throw <code>ETAG_MISMATCH</code> (maps to S3 412).</li>
</ul>
</li>
<li><strong>Extract Generation</strong>: If ETag matches, extract <code>existingKey.updateID</code>.</li>
<li><strong>Create Open Key</strong>: Create open key entry with <code>expectedDataGeneration = existingKey.updateID</code>.</li>
</ol>
<h5 id="om-commit-phase">OM Commit Phase</h5>
<p>The commit phase reuses the existing atomic-rewrite validation logic from HDDS-10656:</p>
<ol>
<li>Read open key entry (contains <code>expectedDataGeneration</code> set during create phase).</li>
<li>Read current committed key from <code>KeyTable</code>.</li>
<li>Validate <code>currentKey.updateID == openKey.expectedDataGeneration</code>.</li>
<li>If match, commit succeeds. If mismatch (concurrent modification), throw <code>KEY_NOT_FOUND</code> (maps to S3 412).</li>
</ol>
<p>This approach ensures end-to-end atomicity: even if another client modifies the key between Create and Commit phases, the commit will fail.</p>
<h4 id="error-mapping">Error Mapping</h4>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>OM Error</strong></td>
          <td><strong>S3 Status</strong></td>
          <td><strong>S3 Error Code</strong></td>
          <td><strong>Scenario</strong></td>
      </tr>
      <tr>
          <td><code>KEY_ALREADY_EXISTS</code></td>
          <td>412</td>
          <td>PreconditionFailed</td>
          <td>If-None-Match failed (key exists)</td>
      </tr>
      <tr>
          <td><code>KEY_NOT_FOUND</code></td>
          <td>412</td>
          <td>PreconditionFailed</td>
          <td>If-Match failed (key missing or concurrent modification)</td>
      </tr>
      <tr>
          <td><code>ETAG_NOT_AVAILABLE</code></td>
          <td>412</td>
          <td>PreconditionFailed</td>
          <td>If-Match failed (key has no ETag, e.g., created via OFS)</td>
      </tr>
      <tr>
          <td><code>ETAG_MISMATCH</code></td>
          <td>412</td>
          <td>PreconditionFailed</td>
          <td>If-Match failed (ETag mismatch)</td>
      </tr>
  </tbody>
</table>
<h2 id="aws-s3-conditional-read-implementation">AWS S3 Conditional Read Implementation</h2>
<p>TODO</p>
<h2 id="aws-s3-conditional-copy-implementation">AWS S3 Conditional Copy Implementation</h2>
<p>TODO</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/conditional-requests.html">AWS S3 Conditional Requests</a></li>
<li><a href="https://tools.ietf.org/html/rfc7232">RFC 7232 - HTTP Conditional Requests</a></li>
<li><a href="https://issues.apache.org/jira/browse/HDDS-10656">HDDS-10656 - Atomic Rewrite Key</a></li>
<li><a href="https://issues.apache.org/jira/browse/HDDS-13963">HDDS-13963 - Atomic Create-If-Not-Exists</a></li>
<li><a href="https://www.morling.dev/blog/leader-election-with-s3-conditional-writes/">Leader Election with S3 Conditional Writes</a></li>
<li><a href="https://simonwillison.net/2025/Oct/11/mvcc-s3/">An MVCC-like columnar table on S3 with constant-time deletes</a></li>
</ul>

            </div>

        </div>
      </div>
    </div>



<footer class="footer">
  <div class="container">
    <span class="small text-muted">
      Version: 2.2.0-SNAPSHOT, Last Modified: January 15, 2026 <a class="hide-child link primary-color" href="https://github.com/apache/ozone/commit/4b90304b0a731274c0d4f8fe38dcc38676ff647c">4b90304b0a</a>
    </span>
  </div>
</footer>



<script src="../js/jquery-3.5.1.min.js"></script>
<script src="../js/ozonedoc.js"></script>
<script src="../js/bootstrap.min.js"></script>


  </body>
</html>
