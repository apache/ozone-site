

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Apache Ozone Documentation">

    <title>Documentation for Apache Ozone</title>

    
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    
    <link href="../css/ozonedoc.css" rel="stylesheet">

    
    
    <link href="../swagger-resources/swagger-ui.css" rel="stylesheet">

    
    <script>
      var _paq = window._paq = window._paq || [];
      

       
      _paq.push(['disableCookies']);
      

      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//analytics.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '34']);
        var d=document, g=d.createElement('script'),
s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    

  </head>


<body>

  
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sidebar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="../index.html" class="navbar-left ozone-logo">
        <img src="../ozone-logo-small.png"/>
      </a>
      <a class="navbar-brand hidden-xs" href="../index.html">
        Apache Ozone/HDDS Documentation
      </a>
      <a class="navbar-brand visible-xs-inline" href="#">Apache Ozone</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/apache/ozone">Source</a></li>
        <li><a href="https://ozone.apache.org">Apache Ozone</a></li>
        <li><a href="https://apache.org">ASF</a></li>
      </ul>
    </div>
  </div>
</nav>


  <div class="wrapper">
  <div class="container-fluid">
    <div class="row">
      
<div class="col-sm-2 col-md-2 sidebar" id="sidebar">
  <ul class="nav nav-sidebar">
    
    
        
            <li class="">
                
                   <a href="../index.html">
                

                    
                    <span>An Introduction to Apache Ozone</span>
                </a>
            </li>
        
    
        
            <li class="">
                <a href="../start.html">
                    
                    <span>Getting Started</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../start/productiondeployment.html">Production Deployment</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../concept.html">
                    
                    <span>Architecture</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../concept/overview.html">Overview</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../concept/ozonemanager.html">
                                 
                                 <span>Ozone Manager</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../concept/volumesbucketskeys.html">Volumes, Buckets, and Keys</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/storagecontainermanager.html">Storage Container Manager</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/containers.html">Containers</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/datanodes.html">Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/ozones3gateway.html">Ozone S3 Gateway</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/recon.html">Recon</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/networkports.html">Network Ports</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../concept/comparison.html">Comparison with Other Storage Technologies</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../feature.html">
                    
                    <span>Features</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../feature/decommission.html">Decommissioning</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/om-ha.html">OM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/erasurecoding.html">Ozone Erasure Coding</a>
                           
                        </li>
                    
                        <li class="active">
                           
                           <a href="../feature/snapshot.html">Ozone Snapshot</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/scm-ha.html">SCM High Availability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/streaming-write-pipeline.html">Streaming Write Pipeline</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/dn-merge-rocksdb.html">Merge Container RocksDB in DN</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/prefixfso.html">Prefix based File System Optimization</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/topology.html">Topology awareness</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/quota.html">Quota in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/recon.html">Recon Server</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/observability.html">Observability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/nonrolling-upgrade.html">Non-Rolling Upgrades and Downgrades</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../feature/s3-multi-tenancy.html">
                                 
                                 <span>S3 Multi-Tenancy</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-setup.html">Setup</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-tenant-commands.html">Tenant commands</a>
                                  </li>
                               
                                  <li class="">
                                     <a href="../feature/s3-multi-tenancy-access-control.html">Access Control</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/reconfigurability.html">Reconfigurability</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/containerbalancer.html">Container Balancer</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/maintenance.html">Maintenance Mode</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/multi-raft-support.html">Multi-Raft Support in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../feature/trash.html">Trash</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../integration.html">
                    
                    <span>Application Integrations</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../integration/distcp.html">Hadoop DistCp</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/hive.html">Hive</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../integration/impala.html">Impala</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../interface.html">
                    
                    <span>Client Interfaces</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../interface/ofs.html">Ofs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/o3fs.html">O3fs (Hadoop compatible)</a>
                           
                        </li>
                    
                        <li class="">
                           
                               <a href="../interface/s3.html">
                                 
                                 <span>S3 Protocol</span>
                               </a>
                               <ul class="nav">
                               
                                  <li class="">
                                     <a href="../interface/cyberduckozones3.html">Accessing Ozone S3 via CyberDuck</a>
                                  </li>
                               
                               </ul>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/cli.html">Command Line Interface</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/reconapi.html">Recon API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/javaapi.html">Java API</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/python.html">Accessing Apache Ozone from Python</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/csi.html">CSI Protocol</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/httpfs.html">HttpFS Gateway</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../interface/native-cpp.html">Native C/C&#43;&#43; Client Access to Ozone</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                <a href="../security.html">
                    
                    <span>Security</span>
                </a>
                <ul class="nav">
                    
                        <li class="">
                           
                           <a href="../security/secureozone.html">Securing Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingtde.html">Transparent Data Encryption</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/gdpr.html">GDPR in Ozone</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingdatanodes.html">Securing Datanodes</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securingozonehttp.html">Securing HTTP</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securings3.html">Securing S3</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securityacls.html">Ozone ACLs</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/protect-in-transit-traffic.html">Protect In-Transit Traffic</a>
                           
                        </li>
                    
                        <li class="">
                           
                           <a href="../security/securitywithranger.html">Apache Ranger</a>
                           
                        </li>
                    
                </ul>
            </li>
        
    
        
            <li class="">
                
                   <a href="../tools.html">
                

                    
                    <span>Tools</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../recipe.html">
                

                    
                    <span>Recipes</span>
                </a>
            </li>
        
    
        
            <li class="">
                
                   <a href="../troubleshooting.html">
                

                    
                    <span>Troubleshooting</span>
                </a>
            </li>
        
    
    <li><a href="../design.html"><span><b>Design docs</b></span></a></li>
    <li class="visible-xs"><a href="#">References</a>
    <ul class="nav">
        <li><a href="https://github.com/apache/ozone"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Source</a></li>
        <li><a href="https://ozone.apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Apache Ozone</a></li>
        <li><a href="https://apache.org"><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> ASF</a></li>
    </ul></li>
  </ul>

</div>

      <div class="col-sm-10 col-sm-offset-2 col-md-10 col-md-offset-2 main-content">



        <div class="col-md-9">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="../index.html">Home</a></li>
                  <li class="breadcrumb-item" aria-current="page"><a href="../feature.html">Features</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Ozone Snapshot</li>
                </ol>
              </nav>

          

<div class="pull-right">
    
    
    
</div>


          <div class="col-md-9">
            <h1>Ozone Snapshot</h1>

            <!---
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<h2 id="introduction">Introduction</h2>
<p>Ozone Snapshots let you create point-in-time, consistent, read-only images of a bucket. Key uses include:</p>
<ul>
<li><strong>Backup and Restore</strong>: For regular data protection and recovery.</li>
<li><strong>Archival and Compliance</strong>: For long-term data retention.</li>
<li><strong>Replication and Disaster Recovery (DR)</strong>: For copying bucket images to remote DR sites.</li>
<li><strong>Incremental Replication</strong>: <code>DistCp</code> with <code>SnapshotDiff</code> efficiently syncs buckets.</li>
</ul>
<h2 id="architecture">Architecture</h2>
<p>Ozone Snapshots provide point-in-time, read-only copies of buckets. This relies on Ozone&rsquo;s immutable data blocks. When a snapshot is taken, Ozone Manager (OM) copies the bucket&rsquo;s metadata (key namespace) using its RocksDB store. Data blocks aren&rsquo;t duplicated; they are preserved as long as any snapshot or the live bucket references them. Background services reclaim unreferenced blocks.</p>
<p>The SnapshotDiff feature compares two snapshots (or a snapshot and the live bucket) to identify changes like added, deleted, modified, or renamed keys, caching results for speed.</p>
<h2 id="system-architecture-deep-dive">System Architecture Deep Dive</h2>
<p>Ozone snapshots version bucket metadata within the OM. A dedicated snapshot metadata table in RocksDB records the key directory tree at snapshot creation. This is an instant operation as it involves metadata pointers (via RocksDB checkpoints) rather than data copying. Each snapshot has a unique ID and name.</p>
<p>When keys are changed or deleted in the live bucket, their data blocks are retained if a snapshot references them. Deleting a snapshot makes its exclusively referenced blocks reclaimable by background cleanup processes.</p>
<p><strong>SnapshotDiff Implementation:</strong> Differences are computed using RocksDB key comparisons and a compaction DAG for recent changes (default: 30 days). For older snapshots or if DAG data is compacted, a full metadata scan is used. Diff results (<code>+</code> add, <code>-</code> delete, <code>M</code> modify, <code>R</code> rename) are cached.</p>
<p><strong>Snapshot Data Storage:</strong> Snapshot metadata resides in OM&rsquo;s RocksDB. Diff job data is stored in <code>ozone.om.snapshot.diff.db.dir</code> (defaults to OM metadata directory).</p>
<p>For more details, see Prashant Pogdeâ€™s <a href="https://medium.com/@prashantpogde/introducing-apache-ozone-snapshots-af82e976142f">Introducing Apache Ozone Snapshots</a>.</p>
<h2 id="user-tutorial">User Tutorial</h2>
<p>This guide shows how to use Ozone snapshots via CLI and Java.</p>
<h3 id="using-snapshots-via-cli">Using Snapshots via CLI</h3>
<p>Manage snapshots using <code>ozone sh</code> or <code>ozone fs</code> (Hadoop-compatible) commands:</p>
<ul>
<li>
<p><strong>Create Snapshot:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot create /vol1/bucket1 <span style="color:#f92672">[</span>snapshotName<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Or via Hadoop FS interface:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ozone fs -createSnapshot ofs://om-service/vol1/bucket1 [snapshotName]</span>
</span></span></code></pre></div><p>Requires bucket owner or admin privilege. If <code>snapshotName</code> is omitted, it&rsquo;s auto-generated (e.g., <code>s20250530-005848.163</code>). Custom names must be unique, valid DNS names.</p>
</li>
<li>
<p><strong>Delete Snapshot:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot delete /vol1/bucket1 &lt;snapshotName&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Or via Hadoop FS interface:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ozone fs -deleteSnapshot ofs://om-service/vol1/bucket1 &lt;snapshotName&gt;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>List Snapshots:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot list /vol1/bucket1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Or via Hadoop FS interface (list .snapshot directory):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ozone fs -ls /vol1/bucket1/.snapshot</span>
</span></span></code></pre></div><p>Snapshots appear in the bucket&rsquo;s read-only <code>.snapshot</code> directory.</p>
</li>
<li>
<p><strong>Read from Snapshot:</strong>
List keys:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh key list /vol1/bucket1/.snapshot/&lt;snapshotName&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Or: ozone fs -ls /vol1/bucket1/.snapshot/&lt;snapshotName&gt;</span>
</span></span></code></pre></div><p>Get a key:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh key get /vol1/bucket1/.snapshot/&lt;snapshotName&gt;/reports/Q1.csv ./Q1_snapshot.csv
</span></span></code></pre></div><p>Requires read privileges on the bucket.</p>
</li>
<li>
<p><strong>Snapshot Diff:</strong> Shows changes between two snapshots or a snapshot and the live bucket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot diff /vol1/bucket1 &lt;snap1&gt; &lt;snap2_or_live_bucket&gt;
</span></span></code></pre></div><p>Output prefixes: <code>+</code> (add), <code>-</code> (delete), <code>M</code> (modify), <code>R</code> (rename). Use <code>-p</code>, <code>-t</code> for pagination.
Manage diff jobs: <code>ozone sh snapshot listDiff /vol1/bucket1</code>, <code>ozone sh snapshot cancelDiff &lt;jobId&gt;</code>.</p>
</li>
<li>
<p><strong>Rename Snapshot:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot rename /vol1/bucket1 &lt;oldName&gt; &lt;newName&gt;
</span></span></code></pre></div><p>Requires bucket owner or admin.</p>
</li>
<li>
<p><strong>Snapshot Info:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ozone sh snapshot info /vol1/bucket1 &lt;snapshotName&gt;
</span></span></code></pre></div><p>Shows ID, creation time, status, and space usage (Reference and Exclusive Size).</p>
</li>
</ul>
<p>CLI operations call Ozone Manager RPCs and enforce authorization.</p>
<h3 id="programmatic-access-via-java">Programmatic Access via Java</h3>
<p>Manage and access snapshots using Java APIs:</p>
<p><strong>Hadoop Compatible FileSystem (HCFS) Interface:</strong> Use Ozone FileSystem (OFS) API (Hadoop <code>FileSystem</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Example: Create, list, read, rename, delete snapshots</span>
</span></span><span style="display:flex;"><span>Configuration conf <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> OzoneConfiguration();
</span></span><span style="display:flex;"><span>FileSystem fs <span style="color:#f92672">=</span> FileSystem.<span style="color:#a6e22e">get</span>(<span style="color:#66d9ef">new</span> Path(<span style="color:#e6db74">&#34;ofs://om-service/vol1/bucket1&#34;</span>).<span style="color:#a6e22e">toUri</span>(), conf);
</span></span><span style="display:flex;"><span>Path bucketPath <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Path(<span style="color:#e6db74">&#34;/vol1/bucket1&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fs.createSnapshot(bucketPath, &#34;snapshotName&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fs.listStatus(new Path(bucketPath, &#34;.snapshot&#34;));</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fs.open(new Path(bucketPath, &#34;.snapshot/snapshotName/key&#34;));</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fs.rename(new Path(bucketPath, &#34;.snapshot/oldName&#34;), new Path(bucketPath, &#34;.snapshot/newName&#34;));</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// fs.deleteSnapshot(bucketPath, &#34;snapshotName&#34;);</span>
</span></span></code></pre></div><p>Handle <code>OMException</code> or <code>IOException</code>. Snapshots are in the bucket&rsquo;s <code>.snapshot</code> directory.
Refer to the <a href="https://ozone.apache.org/docs/edge/interface/ofs.html">Ozone File System API guide</a>.</p>
<p><strong>Ozone ObjectStore Client API:</strong> Use <code>OzoneClient</code> and <code>ObjectStore</code> API.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#75715e">// Example: Create, list, get info, rename, delete snapshots</span>
</span></span><span style="display:flex;"><span>OzoneClient ozClient <span style="color:#f92672">=</span> OzoneClientFactory.<span style="color:#a6e22e">getRpcClient</span>(conf);
</span></span><span style="display:flex;"><span>ObjectStore store <span style="color:#f92672">=</span> ozClient.<span style="color:#a6e22e">getObjectStore</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// store.createSnapshot(&#34;vol1&#34;, &#34;bucket1&#34;, &#34;snapshotName&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// store.listSnapshot(&#34;vol1&#34;, &#34;bucket1&#34;, null, null);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// store.getSnapshotInfo(&#34;vol1&#34;, &#34;bucket1&#34;, &#34;snapshotName&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// store.renameSnapshot(&#34;vol1&#34;, &#34;bucket1&#34;, &#34;oldName&#34;, &#34;newName&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// store.deleteSnapshot(&#34;vol1&#34;, &#34;bucket1&#34;, &#34;snapshotName&#34;);</span>
</span></span></code></pre></div><p>Handle exceptions for privilege or non-existent snapshot issues.</p>
<p><strong>HTTP REST API Access:</strong> Use HttpFS Gateway (WebHDFS-compatible REST API) for filesystem operations on snapshots (e.g., reading from <code>.snapshot</code> paths). Create/delete/rename are supported; <code>getSnapshotDiff</code> is not yet.</p>
<h2 id="system-administration-how-to">System Administration How-To</h2>
<p>This section covers key configurations and monitoring for Ozone snapshots. Tune these in <strong>ozone-site.xml</strong>.</p>
<p><strong>Snapshot-Related Configuration Parameters:</strong></p>
<ul>
<li>
<p><strong>General Snapshot Management</strong></p>
<ul>
<li><code>ozone.om.fs.snapshot.max.limit</code>: Max snapshots per bucket (Default: 10000). Safety limit.</li>
<li><code>ozone.om.ratis.snapshot.dir</code>: The directory where OM Ratis snapshots are stored (Default: ratis-snapshot under OM DB dir).</li>
<li><code>ozone.om.ratis.snapshot.max.total.sst.size</code>: The maximum total size of SST files to be included in a Ratis snapshot (Default: 100000000).</li>
<li><code>ozone.om.snapshot.load.native.lib</code>: Use native RocksDB library for snapshot operations (Default: true). Set to false as a workaround for native library issues.</li>
<li><code>ozone.om.snapshot.checkpoint.dir.creation.poll.timeout</code>: Timeout for polling the creation of the snapshot checkpoint directory (Default: 20s).</li>
</ul>
</li>
<li>
<p><strong>SnapshotDiff Service</strong></p>
<ul>
<li><code>ozone.om.snapshot.diff.db.dir</code>: Directory for SnapshotDiff job data. Defaults to OM metadata dir. Use a spacious location for large diffs.</li>
<li><code>ozone.om.snapshot.force.full.diff</code>: Force a full diff for all snapshot diff jobs (Default: false).</li>
<li><code>ozone.om.snapshot.diff.disable.native.libs</code>: Disable native libraries for snapshot diff (Default: false).</li>
<li><code>ozone.om.snapshot.diff.max.page.size</code>: Maximum page size for snapshot diff (Default: 1000).</li>
<li><code>ozone.om.snapshot.diff.thread.pool.size</code>: Thread pool size for snapshot diff (Default: 10).</li>
<li><code>ozone.om.snapshot.diff.job.default.wait.time</code>: Default wait time for a snapshot diff job (Default: 1m).</li>
<li><code>ozone.om.snapshot.diff.max.allowed.keys.changed.per.job</code>: Maximum number of keys allowed to be changed per snapshot diff job (Default: 10000000).</li>
</ul>
</li>
<li>
<p><strong>Snapshot Compaction and Cleanup</strong></p>
<ul>
<li><code>ozone.snapshot.key.deleting.limit.per.task</code>: The maximum number of keys scanned by the snapshot deleting service in a single run (Default: 20000).</li>
<li><code>ozone.om.snapshot.compact.non.snapshot.diff.tables</code>: When enabled, allows compaction of tables not tracked by snapshot diffs after snapshots are evicted from the cache (Default: false).</li>
<li><code>ozone.om.snapshot.compaction.dag.max.time.allowed</code>: Window for efficient SnapshotDiff (Default: 30 days). Older diffs may be slower.</li>
<li><code>ozone.om.snapshot.prune.compaction.backup.batch.size</code>: Batch size for pruning compaction backups (Default: 2000).</li>
<li><code>ozone.om.snapshot.compaction.dag.prune.daemon.run.interval</code>: Interval for the compaction DAG pruning daemon (Default: 1h).</li>
<li><code>ozone.om.snapshot.diff.max.jobs.purge.per.task</code>: Maximum number of snapshot diff jobs to purge per task (Default: 100).</li>
<li><code>ozone.om.snapshot.diff.job.report.persistent.time</code>: Persistence time for snapshot diff job reports (Default: 7d).</li>
<li><code>ozone.om.snapshot.diff.cleanup.service.run.interval</code>: Interval for the snapshot diff cleanup service (Default: 1m).</li>
<li><code>ozone.om.snapshot.diff.cleanup.service.timeout</code>: Timeout for the snapshot diff cleanup service (Default: 5m).</li>
<li><code>ozone.om.snapshot.cache.cleanup.service.run.interval</code>: Interval for the snapshot cache cleanup service (Default: 1m).</li>
<li><code>ozone.snapshot.filtering.limit.per.task</code>: The maximum number of snapshots to be filtered in a single run of the snapshot filtering service (Default: 2).</li>
<li><code>ozone.snapshot.deleting.limit.per.task</code>: The maximum number of snapshots to be deleted in a single run of the snapshot deleting service (Default: 10).</li>
<li><code>ozone.snapshot.filtering.service.interval</code>: Interval for the snapshot filtering service (Default: 60s).</li>
<li><code>ozone.snapshot.deleting.service.timeout</code>: Timeout for the snapshot deleting service (Default: 300s).</li>
<li><code>ozone.snapshot.deleting.service.interval</code>: Interval for the snapshot deleting service (Default: 30s).</li>
<li><code>ozone.snapshot.deep.cleaning.enabled</code>: Enable deep cleaning of snapshots (Default: false).</li>
</ul>
</li>
<li>
<p><strong>Performance and Resource Management</strong></p>
<ul>
<li><code>ozone.om.snapshot.rocksdb.metrics.enabled</code>: Enable detailed RocksDB metrics for snapshots (Default: false). Use for debugging/monitoring.</li>
<li><code>ozone.om.snapshot.cache.max.size</code>: Maximum size of the snapshot cache soft limit (Default: 10).</li>
<li><code>ozone.om.snapshot.db.max.open.files</code>: Maximum number of open files for the snapshot database (Default: 100).</li>
</ul>
</li>
<li>
<p><strong>Snapshot Provider (Internal)</strong></p>
<ul>
<li><code>ozone.om.snapshot.provider.socket.timeout</code>: Socket timeout for the snapshot provider (Default: 5s).</li>
<li><code>ozone.om.snapshot.provider.connection.timeout</code>: Connection timeout for the snapshot provider (Default: 5s).</li>
<li><code>ozone.om.snapshot.provider.request.timeout</code>: Request timeout for the snapshot provider (Default: 5m).</li>
</ul>
</li>
</ul>
<h3 id="recon-specific-settings">Recon-Specific Settings</h3>
<p>These settings, defined in <code>ozone-default.xml</code>, apply specifically to Recon.</p>
<ul>
<li><code>ozone.recon.om.snapshot.task.initial.delay</code>: Initial delay for the OM snapshot task in Recon (Default: 1m).</li>
<li><code>ozone.recon.om.snapshot.task.interval.delay</code>: Interval for the OM snapshot task in Recon (Default: 5s).</li>
<li><code>ozone.recon.om.snapshot.task.flush.param</code>: Flush parameter for the OM snapshot task in Recon (Default: false).</li>
</ul>
<p>Monitor OM heap usage with many snapshots or large diffs. Enable Ozone Native ACLs or Ranger for access control.</p>
<p><strong>Monitoring Snapshots:</strong> Use OM metrics (Prometheus, RPC) for snapshot counts, diff operations, etc. Check OM logs for snapshot-related messages.</p>
<h2 id="authorization">Authorization</h2>
<p>Snapshot operations require specific privileges:</p>
<ul>
<li><strong>Create, Delete, Rename Snapshot:</strong> Require admin or bucket owner privileges. Access is denied otherwise.</li>
<li><strong>List Snapshots, Get Snapshot Info:</strong> Require read/list access to the bucket. Users who can list bucket contents can typically list its snapshots.</li>
<li><strong>SnapshotDiff, Cancel/List SnapshotDiff Jobs:</strong> Require read access to the bucket, as diffs reveal key information.</li>
</ul>
<p>Ozone supports native ACLs and optional Ranger policies for snapshot authorization. The behavior described assumes native ACLs. If using Ranger, ensure appropriate permissions are configured for snapshot operations.</p>
<h2 id="comparison-to-hdfs-snapshots">Comparison to HDFS Snapshots</h2>
<p>Ozone and HDFS snapshots are conceptually similar but differ in key aspects:</p>
<ul>
<li><strong>Granularity:</strong> Ozone snapshots are bucket-level; HDFS snapshots can be taken at any directory level (if snapshottable).</li>
<li><strong>Metadata vs. Data Changes:</strong> Both track key/file changes. Ozone snapshots don&rsquo;t version bucket metadata changes (e.g., quotas, ACLs).</li>
<li><strong>Access and Restore:</strong> Both use a <code>.snapshot</code> path for read-only access. Restoring in Ozone is a manual copy process (e.g., using DistCp); no automatic rollback.</li>
<li><strong>Implementation:</strong> Ozone uses OM&rsquo;s key-value store (RocksDB) for O(1) metadata-pointer-based snapshots. HDFS also uses metadata manipulation but Ozone&rsquo;s object-store nature means no DataNode-level block tracking for snapshots; all intelligence is in OM.</li>
</ul>
<h2 id="known-issues-and-limitations">Known Issues and Limitations</h2>
<p>Key limitations for Ozone snapshots include:</p>
<ul>
<li><strong>S3 Interface Support:</strong> Snapshot operations (create, list, delete) are not available via the S3 API or <code>s3a</code> connector. Manage snapshots using Ozone RPC (shell, <code>ozone fs</code>, Java API). Snapshotted data can be read via S3 using the <code>.snapshot/snapshotName/keyName</code> path.</li>
<li><strong>Ratis &amp; EC Buckets:</strong> Snapshots work for both Ratis and EC buckets, managed via Ozone interfaces.</li>
<li><strong>Snapshots During Ongoing Deletes:</strong> Taking a snapshot during a large delete operation will prevent space reclamation for the deleted keys until the snapshot is removed.</li>
<li><strong>Reserved Namespace Name <code>.snapshot</code>:</strong> <code>.snapshot</code> is a reserved name at the root of a bucket and cannot be used for user-created keys or directories.</li>
<li><strong>Snapshot Performance and Scale:</strong> While creating snapshots is fast, a very large number of snapshots per bucket (thousands) can increase OM metadata size and potentially slow down listing operations. Snapshot diff performance is generally not affected by the number of snapshots but by concurrent diff operations.</li>
<li><strong>Space Utilization Reporting:</strong> Space used by snapshots (data no longer in the active bucket but retained by snapshots) is reported in <code>ozone sh snapshot info</code>. Deleting a snapshot frees space asynchronously.</li>
<li><strong>Hard Link Upper Limit:</strong> RocksDB checkpoints use hard links, limited to 65,535 per file by the filesystem. This restricts the number of snapshots per bucket.</li>
</ul>
<p>Refer to project release notes for updates on these limitations.</p>
<h2 id="linux-system-configuration">Linux System Configuration</h2>
<p>For optimal performance and stability when using Ozone snapshots, especially in production, consider the following system configurations:</p>
<ul>
<li><strong>Open File Descriptors:</strong> Increase the <code>nofile</code> ulimit (e.g., to 64,000 or higher) for the Ozone Manager (OM) process to handle numerous RocksDB files and snapshot operations.</li>
<li><strong>Metadata Storage:</strong> Use high-performance storage like NVMe SSDs for OM metadata directories (<code>ozone.metadata.dirs</code>) to improve I/O for snapshot and diff operations.</li>
<li><strong>OM Resources:</strong> Allocate sufficient RAM (e.g., 16-32GB+, monitor GC) and CPU to the Ozone Manager, particularly for clusters with many snapshots or concurrent diff jobs.</li>
<li><strong>DataNode Disk Space:</strong> Account for increased disk usage on DataNodes, as snapshots retain data blocks that would otherwise be deleted. Plan capacity based on snapshot retention policies and change rates.</li>
<li><strong>Filesystem &amp; Kernel:</strong> Use filesystems like ext4 or xfs (often preferred for RocksDB) for OM metadata. Ensure disk schedulers and RAID configurations are optimized for low latency.</li>
<li><strong>Networking:</strong> Ensure robust network connectivity to the OM, as snapshot diffs or HttpFS access can involve significant data transfer.</li>
</ul>
<p>Always test snapshot operations under your expected load to fine-tune these configurations.</p>


          
          <a class="btn  btn-success btn-lg" href="../feature/scm-ha.html">Next >></a>
          
          </div>

        </div>
      </div>
    </div>
  </div>
    <div class="push"></div>
  </div>

  

<footer class="footer">
  <div class="container">
    <span class="small text-muted">
      Version: 2.1.0-SNAPSHOT, Last Modified: September 16, 2025 <a class="hide-child link primary-color" href="https://github.com/apache/ozone/commit/9a377483cdc228e7f6d84dd4cceeec898a01d6c9">9a377483cd</a>
    </span>
  </div>
</footer>



<script src="../js/jquery-3.5.1.min.js"></script>
<script src="../js/ozonedoc.js"></script>
<script src="../js/bootstrap.min.js"></script>


</body>

</html>