"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[2351],{49855:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"troubleshooting/om-ha-snapshot-installation-issues","title":"Troubleshooting OM HA snapshot installation issues","description":"When a new Ozone Manager (OM) is added to an existing OM HA cluster, it needs to obtain the latest OM DB snapshot from the leader OM.","source":"@site/docs/06-troubleshooting/16-om-ha-snapshot-installation-issues.md","sourceDirName":"06-troubleshooting","slug":"/troubleshooting/om-ha-snapshot-installation-issues","permalink":"/docs/troubleshooting/om-ha-snapshot-installation-issues","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/06-troubleshooting/16-om-ha-snapshot-installation-issues.md","tags":[],"version":"current","sidebarPosition":16,"frontMatter":{"sidebar_label":"OM HA snapshot installation"},"sidebar":"defaultSidebar","previous":{"title":"Docker","permalink":"/docs/troubleshooting/docker"},"next":{"title":"System Internals","permalink":"/docs/system-internals/"}}');var n=o(86070),i=o(62392);const a={sidebar_label:"OM HA snapshot installation"},r="Troubleshooting OM HA snapshot installation issues",l={},h=[];function d(e){const t={admonition:"admonition",code:"code",h1:"h1",header:"header",li:"li",ol:"ol",p:"p",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"troubleshooting-om-ha-snapshot-installation-issues",children:"Troubleshooting OM HA snapshot installation issues"})}),"\n",(0,n.jsx)(t.p,{children:"When a new Ozone Manager (OM) is added to an existing OM HA cluster, it needs to obtain the latest OM DB snapshot from the leader OM.\nIn cases where the OM DB is very large, the new OM may get stuck in a loop trying to download the snapshot.\nThis can happen if the leader OM purges the Raft logs associated with the snapshot before the new OM can finish downloading it.\nWhen this happens, the new OM will have to restart the snapshot download, and the process can repeat indefinitely."}),"\n",(0,n.jsx)(t.p,{children:"To avoid this issue, you can configure the following properties on the leader OM:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["Set ",(0,n.jsx)(t.code,{children:"ozone.om.ratis.log.purge.preservation.log.num"})," to a high value (e.g. 1000000).\nThis property controls how many Raft logs are preserved on the leader OM.\nBy setting it to a high value, you can prevent the leader from purging the logs that the new OM needs to catch up. This is a more balanced approach to ensure that some logs are preserved so that they can be replicated to the slow follower (instead of installing snapshot), but if the number of logs exceeded this amount, OM leader will purge the logs to prevent disk to be full."]}),"\n",(0,n.jsxs)(t.li,{children:["Set ",(0,n.jsx)(t.code,{children:"ozone.om.ratis.log.purge.upto.snapshot.index"})," to ",(0,n.jsx)(t.code,{children:"false"}),".\nThis property prevents the leader OM from purging any logs until all followers have installed the latest snapshot.\nThis ensures that the new OM will have enough time to download and install the snapshot without the logs being purged. This is a more risky approach since it might cause the Raft logs to increase indefinitely when the OM follower is down for a long time, which can cause OM metadata dir to be full."]}),"\n"]}),"\n",(0,n.jsxs)(t.admonition,{type:"note",children:[(0,n.jsxs)(t.p,{children:["If ",(0,n.jsx)(t.code,{children:"ozone.om.ratis.log.purge.preservation.log.num"})," is set to a non-zero number, it is recommended to keep ",(0,n.jsx)(t.code,{children:"ozone.om.ratis.log.purge.upto.snapshot.index"})," to ",(0,n.jsx)(t.code,{children:"true"})," (default value) since ",(0,n.jsx)(t.code,{children:"ozone.om.ratis.log.purge.upto.snapshot.index"})," will override the preservation configuration. Therefore, these two properties should not be set together."]}),(0,n.jsx)(t.p,{children:"By tuning these two parameters, you can avoid the OM snapshot installation loop and successfully add new OMs to your HA cluster."})]})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},62392:(e,t,o)=>{o.d(t,{R:()=>a,x:()=>r});var s=o(30758);const n={},i=s.createContext(n);function a(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);