"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[573],{52866:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"administrator-guide/operations/disk-replacement/ozone-manager","title":"Replacing Ozone Manager Disks","description":"Audience: Cluster Administrators","source":"@site/versioned_docs/version-2.1.0/05-administrator-guide/03-operations/04-disk-replacement/01-ozone-manager.md","sourceDirName":"05-administrator-guide/03-operations/04-disk-replacement","slug":"/administrator-guide/operations/disk-replacement/ozone-manager","permalink":"/docs/administrator-guide/operations/disk-replacement/ozone-manager","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/versioned_docs/version-2.1.0/05-administrator-guide/03-operations/04-disk-replacement/01-ozone-manager.md","tags":[],"version":"2.1.0","sidebarPosition":1,"frontMatter":{"sidebar_label":"Ozone Manager"},"sidebar":"defaultSidebar","previous":{"title":"Disk Replacement","permalink":"/docs/administrator-guide/operations/disk-replacement/"},"next":{"title":"Storage Container Manager","permalink":"/docs/administrator-guide/operations/disk-replacement/storage-container-manager"}}');var r=s(86070),t=s(62392);const o={sidebar_label:"Ozone Manager"},a="Replacing Ozone Manager Disks",d={},l=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Pre-flight Checks",id:"2-pre-flight-checks",level:2},{value:"3. Procedure for a Standalone (Non-HA) Ozone Manager",id:"3-procedure-for-a-standalone-non-ha-ozone-manager",level:2},{value:"4. Procedure for an HA (Ratis-based) Ozone Manager",id:"4-procedure-for-an-ha-ratis-based-ozone-manager",level:2},{value:"Bootstrap Procedure",id:"bootstrap-procedure",level:3},{value:"5. Additional Considerations",id:"5-additional-considerations",level:2}];function c(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"replacing-ozone-manager-disks",children:"Replacing Ozone Manager Disks"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Audience:"})," Cluster Administrators"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Prerequisites:"})," Familiarity with Ozone cluster administration and Linux system administration."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,r.jsx)(n.p,{children:"When a disk containing the Ozone Manager (OM) metadata directory fails, proper recovery procedures are critical to maintain cluster availability and prevent data loss. This document provides comprehensive, step-by-step guidance for safely replacing failed disks on OM nodes, with distinct procedures for standalone and High-Availability (HA) configurations. Following these procedures correctly ensures minimal downtime and maintains the integrity of your Ozone cluster's metadata."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),"\nThis guide provides the steps required to safely replace a failed disk on an Ozone Manager (OM) node."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Impact of OM Disk Failure"}),"\nThe OM disk is critical as it stores the RocksDB database containing the entire object store namespace (volumes, buckets, keys) and block locations. A failure of this disk can lead to metadata loss if not handled correctly."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Crucial Distinction: HA vs. Non-HA"}),"\nThe recovery procedure depends entirely on whether your OM is a single, standalone instance or part of a High-Availability (HA) Ratis-based quorum. The HA procedure is significantly safer and results in no cluster downtime. Running a standalone OM is not recommended for production environments."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-pre-flight-checks",children:"2. Pre-flight Checks"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Important:"})," The following steps assume Ozone configuration files are intact. If the configuration files are corrupt, they need to be restored from a backup (if applicable) before proceeding with the disk replacement procedure."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Before starting, the administrator should:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Identify the Failed Disk:"})," Use system tools (",(0,r.jsx)(n.code,{children:"dmesg"}),", ",(0,r.jsx)(n.code,{children:"smartctl"}),", etc.) to confirm which disk has failed and its mount point."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Identify OM Directories:"})," Check your ",(0,r.jsx)(n.code,{children:"ozone-site.xml"})," to confirm which Ozone directories are on the failed disk. The most important ones are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ozone.om.db.dirs"}),": The primary OM metadata database (RocksDB). This directory stores the entire object store namespace."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ozone.om.ratis.storage.dir"}),": The Ratis storage directory (if configured on a separate disk). This directory stores Ratis metadata like logs. If not explicitly configured, it falls back to ",(0,r.jsx)(n.code,{children:"ozone.metadata.dirs"}),". For production environments, it is recommended to configure this on a separate, fast disk (preferably SSD) for better performance."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Prepare the Replacement Disk:"})," Have a new, healthy disk physically installed, formatted, and mounted on the system at the same path as the failed disk. Ensure it has the correct ownership and permissions for the user that runs the OM process. The default permissions for OM metadata directories are ",(0,r.jsx)(n.strong,{children:"750"})," (configurable via ",(0,r.jsx)(n.code,{children:"ozone.om.db.dirs.permissions"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-procedure-for-a-standalone-non-ha-ozone-manager",children:"3. Procedure for a Standalone (Non-HA) Ozone Manager"}),"\n",(0,r.jsx)(n.p,{children:"This is a high-risk, manual disaster recovery process that will require cluster downtime."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STOP THE ENTIRE CLUSTER:"})," Shut down all clients, Datanodes, SCM, and the Ozone Manager to prevent any further state changes."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Attempt Data Recovery:"})," If the failed disk is still partially readable, make a best-effort attempt to copy the contents of the ",(0,r.jsx)(n.code,{children:"ozone.om.db.dirs"})," directory to a safe, temporary location."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"If Recovery Fails, Restore from Backup:"})," If the OM database files are unrecoverable, you must restore from your most recent backup. This document does not cover the backup process itself, but it is the only path to recovery in this scenario."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replace and Configure Disk:"})," Physically replace the hardware and ensure the new, empty disk is mounted at the correct path defined in ",(0,r.jsx)(n.code,{children:"ozone.om.db.dirs"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Restore Metadata:"})," Copy the recovered data ",(0,r.jsx)(n.strong,{children:"(from Step 2)"})," or the restored backup data ",(0,r.jsx)(n.strong,{children:"(from Step 3)"})," to the ",(0,r.jsx)(n.code,{children:"ozone.om.db.dirs"})," path on the new disk."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Restart and Verify:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Start the SCM and Ozone Manager services."}),"\n",(0,r.jsx)(n.li,{children:"Once the OM is running, start the Datanodes."}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"ozone sh volume list"})," and other basic commands to verify that the namespace is intact and the cluster is operational."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-procedure-for-an-ha-ratis-based-ozone-manager",children:"4. Procedure for an HA (Ratis-based) Ozone Manager"}),"\n",(0,r.jsx)(n.p,{children:"This procedure is much safer, leverages the built-in redundancy of the OM HA cluster, and does not require full cluster downtime."}),"\n",(0,r.jsx)(n.h3,{id:"bootstrap-procedure",children:"Bootstrap Procedure"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STOP THE FAILED OM INSTANCE:"})," On the node with the failed disk, stop only the Ozone Manager process. The other OMs will continue operating, and one of them will remain the leader, serving client requests."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replace and Configure Disk:"})," Physically replace the hardware. Mount the new, empty disk at the path defined in ",(0,r.jsx)(n.code,{children:"ozone.om.db.dirs"})," and ensure it has the correct ownership and permissions. If ",(0,r.jsx)(n.code,{children:"ozone.om.ratis.storage.dir"})," was also on the failed disk, ensure it is properly configured on the new disk as well."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Verify Configuration:"})," Before proceeding, ensure that all existing OMs have their ",(0,r.jsx)(n.code,{children:"ozone-site.xml"})," configuration files updated with the configuration details of the OM being recovered (nodeId, address, port, etc.). The bootstrap process will verify this by checking all OMs' on-disk configurations. If an existing OM does not have updated configs, it can crash when bootstrap is initiated."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"RE-INITIALIZE THE OM:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'This is the key step. Since the local database is gone, the OM needs to be "reborn" by getting a complete copy of the latest state from the current OM leader.'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Run the OM with the ",(0,r.jsx)(n.code,{children:"--bootstrap"})," parameter to trigger this process. For example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ozone om --bootstrap\n"})}),"\n",(0,r.jsx)(n.p,{children:"This command will detect that the OM belongs to an existing Ratis ring but has no local state."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"START THE OM AND MONITOR:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Start the Ozone Manager service on the repaired node (if not already started by the bootstrap command)."}),"\n",(0,r.jsxs)(n.li,{children:["Tail the OM's log file (",(0,r.jsx)(n.code,{children:".log"})," and ",(0,r.jsx)(n.code,{children:".out"}),'). You should see messages indicating that it is connecting to the OM HA ring and that a "snapshot" is being installed. This means the current OM leader is streaming the entire metadata database to this new follower.']}),"\n",(0,r.jsx)(n.li,{children:"This process can take some time, depending on the size of your metadata."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"VERIFY:"})," Once the snapshot installation is complete, the OM will finish starting, join the Ratis ring as a follower, and begin receiving live updates."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You can check the OM Web UI on any of the OM nodes. The list of peers should now show all OMs as healthy."}),"\n",(0,r.jsxs)(n.li,{children:["Alternatively, use the command ",(0,r.jsx)(n.code,{children:"ozone admin om roles -id <OM_SERVICE_ID>"})," to verify that all OMs are showing as LEADER or FOLLOWER."]}),"\n",(0,r.jsx)(n.li,{children:"The cluster is now back at full redundancy and the procedure is complete."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-additional-considerations",children:"5. Additional Considerations"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Disk Space Requirements for Snapshots"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Critical:"})," When an Ozone Manager (OM) acts as a follower in an HA setup, it downloads snapshot tarballs from the leader to its local metadata directory."]}),"\n",(0,r.jsxs)(n.li,{children:["Always ensure your OM disks have ",(0,r.jsx)(n.strong,{children:"at least 2x the current OM database size"})," to accommodate the existing data and incoming snapshots."]}),"\n",(0,r.jsx)(n.li,{children:"This prevents disk space issues and maintains cluster stability during recovery operations."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Separating Ratis Logs"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If you have configured ",(0,r.jsx)(n.code,{children:"ozone.om.ratis.storage.dir"})," on a separate, dedicated disk (recommended for performance), a failure of that disk would follow the same HA recovery procedure."]}),"\n",(0,r.jsx)(n.li,{children:"The OM would automatically rebuild its Ratis logs from the other members of the ring when it starts."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Disk Monitoring"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["This procedure highlights the importance of actively monitoring disk health (",(0,r.jsx)(n.code,{children:"smartd"}),", etc.) to replace disks proactively before a catastrophic failure."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},62392:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(30758);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);