"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[1977],{20048:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"system-internals/components/ozone-manager/high-availability","title":"Ozone Manager High Availability","description":"Ozone has two metadata-manager nodes (Ozone Manager for key space management and Storage Container Manager for block space management) and multiple storage nodes (Datanode). Data is replicated between Datanodes with the help of RAFT consensus algorithm.","source":"@site/docs/07-system-internals/01-components/01-ozone-manager/08-high-availability.md","sourceDirName":"07-system-internals/01-components/01-ozone-manager","slug":"/system-internals/components/ozone-manager/high-availability","permalink":"/docs/system-internals/components/ozone-manager/high-availability","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/07-system-internals/01-components/01-ozone-manager/08-high-availability.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_label":"High Availability"},"sidebar":"defaultSidebar","previous":{"title":"Read Request Flow","permalink":"/docs/system-internals/components/ozone-manager/read-request-flow"},"next":{"title":"Storage Container Manager","permalink":"/docs/system-internals/components/storage-container-manager/"}}');var o=n(86070),s=n(62392);const i={sidebar_label:"High Availability"},r="Ozone Manager High Availability",l={},h=[{value:"Ozone Manager HA",id:"ozone-manager-ha",level:2},{value:"Implementation details",id:"implementation-details",level:2},{value:"Automatic Snapshot Installation for Stale Ozone Managers",id:"automatic-snapshot-installation-for-stale-ozone-managers",level:2},{value:"Important Note on Ozone Manager (OM) Disk Space for Snapshots",id:"important-note-on-ozone-manager-om-disk-space-for-snapshots",level:3},{value:"References",id:"references",level:2}];function c(e){const a={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(a.header,{children:(0,o.jsx)(a.h1,{id:"ozone-manager-high-availability",children:"Ozone Manager High Availability"})}),"\n",(0,o.jsxs)(a.p,{children:["Ozone has two metadata-manager nodes (",(0,o.jsx)(a.em,{children:"Ozone Manager"})," for key space management and ",(0,o.jsx)(a.em,{children:"Storage Container Manager"})," for block space management) and multiple storage nodes (Datanode). Data is replicated between Datanodes with the help of RAFT consensus algorithm."]}),"\n",(0,o.jsx)(a.p,{children:"To avoid any single point of failure the metadata-manager nodes also should have a HA setup."}),"\n",(0,o.jsx)(a.p,{children:"Both Ozone Manager and Storage Container Manager supports HA. In this mode the internal state is replicated via RAFT (with Apache Ratis)"}),"\n",(0,o.jsxs)(a.p,{children:["This document explains the HA setup of Ozone Manager (OM) HA, please check the ",(0,o.jsx)(a.a,{href:"/docs/core-concepts/high-availability/scm-ha",children:"SCM HA documentation"})," for SCM HA. While they can be setup for HA independently, a reliable, full HA setup requires enabling HA for both services."]}),"\n",(0,o.jsx)(a.h2,{id:"ozone-manager-ha",children:"Ozone Manager HA"}),"\n",(0,o.jsxs)(a.p,{children:["A single Ozone Manager uses ",(0,o.jsx)(a.a,{href:"https://github.com/facebook/rocksdb/",children:"RocksDB"})," to persist metadata (volumes, buckets, keys) locally. HA version of Ozone Manager does exactly the same but all the data is replicated with the help of the RAFT consensus algorithm to follower Ozone Manager instances."]}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"HA OM",src:n(95074).A+"",width:"643",height:"256"})}),"\n",(0,o.jsx)(a.p,{children:"Client connects to the Leader Ozone Manager which process the request and schedule the replication with RAFT. When the request is replicated to all the followers the leader can return with the response."}),"\n",(0,o.jsx)(a.h2,{id:"implementation-details",children:"Implementation details"}),"\n",(0,o.jsx)(a.p,{children:"Raft can guarantee the replication of any request if the request is persisted to the RAFT log on the majority of the nodes. To achieve high throughput with Ozone Manager, it returns with the response even if the request is persisted only to the RAFT logs."}),"\n",(0,o.jsx)(a.p,{children:'RocksDB instance are updated by a background thread with batching transactions (so called "double buffer" as when one of the buffers is used to commit the data the other one collects all the new requests for the next commit.) To make all data available for the next request even if the background process has not yet written them, the key data is cached in the memory.'}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"HA - OM Double Buffer",src:n(71228).A+"",width:"1010",height:"644"})}),"\n",(0,o.jsx)(a.p,{children:"The details of this approach are discussed in a separate design doc but it's an integral part of the OM HA design."}),"\n",(0,o.jsx)(a.h2,{id:"automatic-snapshot-installation-for-stale-ozone-managers",children:"Automatic Snapshot Installation for Stale Ozone Managers"}),"\n",(0,o.jsx)(a.p,{children:"Sometimes an OM follower node may be offline or fall far behind the OM leader's raft log.\nThen, it cannot easily catch up by replaying individual log entries.\nThe OM HA implementation includes an automatic snapshot installation\nand recovery process for such cases."}),"\n",(0,o.jsx)(a.p,{children:"How it works:"}),"\n",(0,o.jsxs)(a.ol,{children:["\n",(0,o.jsx)(a.li,{children:"Leader determines that the follower is too far behind."}),"\n",(0,o.jsx)(a.li,{children:"Leader notifies the follower to install a snapshot."}),"\n",(0,o.jsx)(a.li,{children:"The follower downloads and installs the latest snapshot from the leader."}),"\n",(0,o.jsx)(a.li,{children:"After installing the snapshot, the follower OM resumes normal operation and log replication from the new state."}),"\n"]}),"\n",(0,o.jsxs)(a.p,{children:["This logic is implemented in the ",(0,o.jsx)(a.code,{children:"OzoneManagerStateMachine.notifyInstallSnapshotFromLeader()"}),";\nsee the ",(0,o.jsx)(a.a,{href:"https://github.com/apache/ozone/blob/ozone-2.0.0/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java#L520-L531",children:"code"}),"\nin Release 2.0.0."]}),"\n",(0,o.jsxs)(a.p,{children:["Note that this ",(0,o.jsx)(a.code,{children:"Raft Snapshot"}),", used for OM HA state synchronization, is distinct from ",(0,o.jsx)(a.code,{children:"Ozone Snapshot"}),", which is used for data backup and recovery purposes."]}),"\n",(0,o.jsxs)(a.p,{children:["In most scenarios, stale OMs will recover automatically, even if they have missed a large number of operations.\nManual intervention (such as running ",(0,o.jsx)(a.code,{children:"ozone om --bootstrap"}),") is only required when adding a new OM node to the cluster."]}),"\n",(0,o.jsx)(a.h3,{id:"important-note-on-ozone-manager-om-disk-space-for-snapshots",children:"Important Note on Ozone Manager (OM) Disk Space for Snapshots"}),"\n",(0,o.jsx)(a.p,{children:"When an Ozone Manager (OM) acts as a follower in an HA setup, it downloads snapshot tarballs from the leader to its\nlocal metadata directory. Therefore, always ensure your OM disks have at least 2x the current OM database size to\naccommodate the existing data and incoming snapshots, preventing disk space issues and maintaining cluster stability."}),"\n",(0,o.jsx)(a.h2,{id:"references",children:"References"}),"\n",(0,o.jsxs)(a.ul,{children:["\n",(0,o.jsxs)(a.li,{children:["Design doc ",(0,o.jsx)(a.a,{href:"https://ozone.apache.org/docs/edge/design/omha.html",children:"HDDS-505 Ozone Manager HA"})]}),"\n",(0,o.jsx)(a.li,{children:"For troubleshooting OM HA snapshot installation issues, see the troubleshooting documentation."}),"\n",(0,o.jsxs)(a.li,{children:["Ozone distribution contains an example OM HA configuration, under the ",(0,o.jsx)(a.code,{children:"compose/ozone-om-ha"})," directory which can be tested with the help of ",(0,o.jsx)(a.a,{href:"/docs/developer-guide/run/docker-compose",children:"Docker Compose"}),"."]}),"\n",(0,o.jsx)(a.li,{children:(0,o.jsx)(a.a,{href:"https://github.com/apache/ratis/blob/ratis-3.1.3/ratis-server-api/src/main/java/org/apache/ratis/statemachine/StateMachine.java",children:"Apache Ratis State Machine API documentation"})}),"\n"]})]})}function d(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,o.jsx)(a,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},62392:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>r});var t=n(30758);const o={},s=t.createContext(o);function i(e){const a=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(s.Provider,{value:a},e.children)}},71228:(e,a,n)=>{n.d(a,{A:()=>t});const t=n.p+"assets/images/HA-OM-doublebuffer-83220301aa67e3310bc6063364abeea7.png"},95074:(e,a,n)=>{n.d(a,{A:()=>t});const t=n.p+"assets/images/HA-OM-30dfa9edace3c770b0294a885d9b5207.png"}}]);