"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[5756],{40913:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var i=a(66086),s=a(86070),t=a(62392);const o={title:"No More Hotspots: Introducing the Automatic Disk Balancer in Apache Ozone",authors:["apache-ozone-community","jojochuang","0lai0","Gargi-jais11","ChenSammi"],date:new Date("2026-01-29T00:00:00.000Z"),tags:["Ozone","Disk Balancer","Ozone 2.2","Datanode"]},r=void 0,d={authorsImageUrls:[void 0,void 0,void 0,void 0,void 0]},l=[{value:"Why Disk Balancer?",id:"why-disk-balancer",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"How DiskBalancer Decides What to Move",id:"how-diskbalancer-decides-what-to-move",level:2},{value:"Container Move Process",id:"container-move-process",level:3},{value:"Using Disk Balancer",id:"using-disk-balancer",level:2},{value:"Configuration Parameters",id:"configuration-parameters",level:3},{value:"Benefits for operators",id:"benefits-for-operators",level:2},{value:"Closing Thoughts",id:"closing-thoughts",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Ever replaced a drive on a Datanode only to watch it become an I/O hotspot?\nOr seen one disk hit 95% usage while others on the same machine sit idle?\nThese imbalances create performance bottlenecks and increase failure risk.\nApache Ozone's new intra-node Disk Balancer is designed to fix this\u2014automatically."}),"\n",(0,s.jsx)(n.p,{children:"Cluster-wide balancing in Ozone already ensures replicas are evenly spread across Datanodes. But inside a single Datanode, disks can still drift out of balance over time \u2014 for example after adding new disks, replacing hardware, or performing large deletions. This leads to I/O hotspots and uneven wear."}),"\n",(0,s.jsx)(n.p,{children:"Disk Balancer closes that gap."}),"\n",(0,s.jsx)(n.h2,{id:"why-disk-balancer",children:"Why Disk Balancer?"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Disks fill unevenly"})," when nodes gain or lose volumes."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Large deletes"})," can empty some disks disproportionately."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Hot disks degrade performance"})," and become failure risks."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Even if the cluster is balanced, the node itself may not be. Disk Balancer fixes this automatically."}),"\n",(0,s.jsx)(n.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,s.jsxs)(n.p,{children:["The design (",(0,s.jsx)(n.a,{href:"https://issues.apache.org/jira/browse/HDDS-5713",children:"HDDS-5713"}),") introduces a simple metric: ",(0,s.jsx)(n.strong,{children:"Volume Data Density"})," \u2014 how much a disk's utilization deviates from the node's average. If the deviation exceeds a threshold, the node begins balancing."]}),"\n",(0,s.jsx)(n.p,{children:"Balancing is local and safe:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Only ",(0,s.jsx)(n.strong,{children:"closed containers"})," are moved."]}),"\n",(0,s.jsxs)(n.li,{children:["Moves happen entirely ",(0,s.jsx)(n.strong,{children:"within the same Datanode."})]}),"\n",(0,s.jsx)(n.li,{children:"A scheduler periodically checks for imbalance and dispatches copy-and-import tasks."}),"\n",(0,s.jsxs)(n.li,{children:["Bandwidth and concurrency are ",(0,s.jsx)(n.strong,{children:"operator-tunable"})," to avoid interfering with production I/O."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["This runs independently on each Datanode. To use it, first enable the feature by setting ",(0,s.jsx)(n.code,{children:"hdds.datanode.disk.balancer.enabled = true"})," in ",(0,s.jsx)(n.code,{children:"ozone-site.xml"})," on your Datanodes. Once enabled, clients use ",(0,s.jsx)(n.code,{children:"ozone admin datanode diskbalancer"})," commands to talk directly to Datanodes, with SCM only used to discover IN_SERVICE Datanodes when running batch operations with ",(0,s.jsx)(n.code,{children:"--in-service-datanodes"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"how-diskbalancer-decides-what-to-move",children:"How DiskBalancer Decides What to Move"}),"\n",(0,s.jsxs)(n.p,{children:["DiskBalancer uses simple but robust policies to decide ",(0,s.jsx)(n.strong,{children:"which disks to balance"})," and ",(0,s.jsx)(n.strong,{children:"which containers to move"})," (see the design doc for details: ",(0,s.jsx)(n.code,{children:"diskbalancer.md"})," in ",(0,s.jsx)(n.a,{href:"https://issues.apache.org/jira/browse/HDDS-5713",children:"HDDS-5713"}),")."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Default Volume Choosing Policy"}),": Picks the most over\u2011utilized volume as the source and the most under\u2011utilized volume as the destination, based on each disk\u2019s ",(0,s.jsx)(n.strong,{children:"Volume Data Density"})," and the Datanode\u2019s average utilization."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Default Container Choosing Policy"}),": Scans containers on the source volume and moves only ",(0,s.jsx)(n.strong,{children:"CLOSED"})," containers that are not already being moved. To avoid repeatedly scanning the same list, it caches container metadata with automatic expiry."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These defaults aim to make safe, incremental moves that converge the disks toward an even utilization state."}),"\n",(0,s.jsx)(n.h3,{id:"container-move-process",children:"Container Move Process"}),"\n",(0,s.jsxs)(n.p,{children:["When DiskBalancer moves a container from one disk to another on the ",(0,s.jsx)(n.strong,{children:"same Datanode"}),", it follows a careful ",(0,s.jsx)(n.strong,{children:'"Copy-Validate-Replace"'})," flow (summarized from the design doc for ",(0,s.jsx)(n.a,{href:"https://issues.apache.org/jira/browse/HDDS-5713",children:"HDDS-5713"}),"):"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create a temporary copy of the CLOSED container on the destination disk."}),"\n",(0,s.jsxs)(n.li,{children:["Transition that copy into a ",(0,s.jsx)(n.strong,{children:"RECOVERING"})," state and import it as a new container on the destination."]}),"\n",(0,s.jsx)(n.li,{children:"Once import and metadata updates succeed, delete the original CLOSED container from the source disk."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This ensures that data is always consistent: the destination copy is fully validated before the original is removed, minimizing risk during balancing."}),"\n",(0,s.jsx)(n.h2,{id:"using-disk-balancer",children:"Using Disk Balancer"}),"\n",(0,s.jsxs)(n.p,{children:["First, enable the Disk Balancer feature on each Datanode by setting the following in ",(0,s.jsx)(n.code,{children:"ozone-site.xml"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.balancer.enabled = true"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The Disk Balancer CLI supports two command patterns:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ozone admin datanode diskbalancer <command> --in-service-datanodes"})," - Operate on all ",(0,s.jsx)(n.strong,{children:"IN_SERVICE and HEALTHY"})," Datanodes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ozone admin datanode diskbalancer <command> <dn-hostname/dn-ipaddress:port>"})," - Operate on a specific Datanode"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Available commands:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"start"})," - Start the Disk Balancer on the target Datanode(s)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"stop"})," - Stop the Disk Balancer on the target Datanode(s)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"status"})," - Check the current Disk Balancer status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"report"})," - Get a volume density report showing imbalance across disks"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"update"})," - Update Disk Balancer configuration settings"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Examples:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Start Disk Balancer\nozone admin datanode diskbalancer start --in-service-datanodes\nor\nozone admin datanode diskbalancer start ozone-datanode-1 ozone-datanode-5\n\n# user can also specifiy configuration parameters during start\nozone admin datanode diskbalancer start -t <value> -b <value> -p <value> -s <value> --in-service-datanodes\nor\nozone admin datanode diskbalancer start -t <value> -b <value> -p <value> -s <value> ozone-datanode-1\n\n# Stop Disk Balancer\nozone admin datanode diskbalancer stop --in-service-datanodes\nor\nozone admin datanode diskbalancer stop 192.168.1.100:9860\n\n# Check status\nozone admin datanode diskbalancer status --in-service-datanodes\nor\nozone admin datanode diskbalancer status ozone-datanode-1\n\n# Get volume density report\nozone admin datanode diskbalancer report --in-service-datanodes\nor\nozone admin datanode diskbalancer report 192.168.1.100:9860\n\n# Update configuration\nozone admin datanode diskbalancer update -t <value> -b <value> -p <value> -s <value> --in-service-datanodes\nor\nozone admin datanode diskbalancer update -t <value> -b <value> -p <value> -s <value> ozone-datanode-1\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configuration-parameters",children:"Configuration Parameters"}),"\n",(0,s.jsxs)(n.p,{children:["The following parameters can be specified during ",(0,s.jsx)(n.strong,{children:"start"})," or ",(0,s.jsx)(n.strong,{children:"update configuration"})," Disk Balancer:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Short Flag"}),(0,s.jsx)(n.th,{children:"Default Value"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--threshold"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-t"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10.0"})}),(0,s.jsx)(n.td,{children:"Percentage deviation from average utilization of the disks after which a Datanode will be rebalanced."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--bandwidth-in-mb"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-b"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10"})}),(0,s.jsx)(n.td,{children:"Maximum bandwidth for DiskBalancer per second."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--parallel-thread"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-p"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"5"})}),(0,s.jsx)(n.td,{children:"Max parallel thread count for DiskBalancer."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"--stop-after-disk-even"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-s"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"true"})}),(0,s.jsx)(n.td,{children:"Stop DiskBalancer automatically after disk utilization is even."})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"benefits-for-operators",children:"Benefits for operators"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Even I/O load"})," across disks \u2192 more stable performance."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Smooth ops after hardware changes"})," (new or replaced disks)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Hands-off balancing"})," once enabled."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Clear metrics"})," for observability and troubleshooting."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"It complements the existing Container Balancer: one works across nodes, the other within nodes."}),"\n",(0,s.jsx)(n.h2,{id:"closing-thoughts",children:"Closing Thoughts"}),"\n",(0,s.jsx)(n.p,{children:"Disk Balancer is small but impactful. It brings Ozone closer to being a fully self-healing, self-balancing object store \u2014 reducing hotspots, simplifying maintenance, and improving cluster longevity."}),"\n",(0,s.jsx)(n.p,{children:"Ozone 2.2 will ship with this feature available via simple CLI controls and safe defaults. If you run long-lived clusters, this is a feature to watch."}),"\n",(0,s.jsxs)(n.p,{children:["For more information, check out ",(0,s.jsx)(n.a,{href:"https://issues.apache.org/jira/browse/HDDS-5713",children:"HDDS-5713"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},62392:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>r});var i=a(30758);const s={},t=i.createContext(s);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(t.Provider,{value:n},e.children)}},66086:e=>{e.exports=JSON.parse('{"permalink":"/blog/2026/01/29/disk-balancer-preview","editUrl":"https://github.com/apache/ozone-site/tree/master/blog/2026-01-29-disk-balancer-preview.md","source":"@site/blog/2026-01-29-disk-balancer-preview.md","title":"No More Hotspots: Introducing the Automatic Disk Balancer in Apache Ozone","description":"Ever replaced a drive on a Datanode only to watch it become an I/O hotspot?","date":"2026-01-29T00:00:00.000Z","tags":[{"inline":true,"label":"Ozone","permalink":"/blog/tags/ozone"},{"inline":true,"label":"Disk Balancer","permalink":"/blog/tags/disk-balancer"},{"inline":true,"label":"Ozone 2.2","permalink":"/blog/tags/ozone-2-2"},{"inline":true,"label":"Datanode","permalink":"/blog/tags/datanode"}],"readingTime":4.835,"hasTruncateMarker":true,"authors":[{"name":"The Apache Ozone Community","title":"Apache Ozone Project","url":"https://ozone.apache.org","imageURL":"/img/ozone-logo.svg","key":"apache-ozone-community","page":null},{"name":"Wei-Chiu Chuang","title":"Apache Ozone PMC","url":"https://github.com/jojochuang","imageURL":"https://github.com/jojochuang.png","key":"jojochuang","page":null},{"name":"Yu-Chen Lai","title":"Apache Ozone Contributor","url":"https://github.com/0lai0","imageURL":"https://github.com/0lai0.png","key":"0lai0","page":null},{"name":"Gargi Jaiswal","title":"Apache Ozone Contributor","url":"https://github.com/Gargi-jais11","imageURL":"https://github.com/Gargi-jais11.png","key":"Gargi-jais11","page":null},{"name":"Sammi Chen","title":"Apache Ozone Contributor","url":"https://github.com/ChenSammi","imageURL":"https://github.com/ChenSammi.png","key":"ChenSammi","page":null}],"frontMatter":{"title":"No More Hotspots: Introducing the Automatic Disk Balancer in Apache Ozone","authors":["apache-ozone-community","jojochuang","0lai0","Gargi-jais11","ChenSammi"],"date":"2026-01-29T00:00:00.000Z","tags":["Ozone","Disk Balancer","Ozone 2.2","Datanode"]},"unlisted":false,"prevItem":{"title":"Apache Ozone Best Practices at Didi: Scaling to Tens of Billions of Files","permalink":"/blog/2026/01/30/apache-ozone-best-practices-at-didi"},"nextItem":{"title":"Accessing Ozone S3 via CyberDuck","permalink":"/blog/2025/07/02/access-ozone-via-cyberduck"}}')}}]);