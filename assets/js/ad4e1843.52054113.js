"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[52113],{21483:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/ReconHighLevelDesign-2616251c073fa1d9c9e8ec7d07c9da5b.png"},38790:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"core-concepts/architecture/recon","title":"Recon","description":"Recon serves as a management and monitoring console for Ozone. It gives a bird\'s-eye view of Ozone and helps users troubleshoot any issues by presenting the current state of the cluster through REST based APIs and rich web UI.","source":"@site/docs/03-core-concepts/01-architecture/06-recon.md","sourceDirName":"03-core-concepts/01-architecture","slug":"/core-concepts/architecture/recon","permalink":"/docs/next/core-concepts/architecture/recon","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/docs/03-core-concepts/01-architecture/06-recon.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_label":"Recon"},"sidebar":"defaultSidebar","previous":{"title":"Datanodes","permalink":"/docs/next/core-concepts/architecture/datanodes"},"next":{"title":"Replication","permalink":"/docs/next/core-concepts/replication/"}}');var r=s(86070),o=s(62392);const i={sidebar_label:"Recon"},a="Recon",c={},d=[{value:"High Level Design",id:"high-level-design",level:2},{value:"Recon and Ozone Manager",id:"recon-and-ozone-manager",level:2},{value:"Recon and Storage Container Manager",id:"recon-and-storage-container-manager",level:2},{value:"Task Framework",id:"task-framework",level:2},{value:"Recon and Prometheus",id:"recon-and-prometheus",level:2},{value:"API Reference",id:"api-reference",level:2},{value:"Persisted state",id:"persisted-state",level:2},{value:"Notable configurations",id:"notable-configurations",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"recon",children:"Recon"})}),"\n",(0,r.jsx)(n.p,{children:"Recon serves as a management and monitoring console for Ozone. It gives a bird's-eye view of Ozone and helps users troubleshoot any issues by presenting the current state of the cluster through REST based APIs and rich web UI."}),"\n",(0,r.jsx)(n.h2,{id:"high-level-design",children:"High Level Design"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Recon High Level Design",src:s(21483).A+"",width:"1930",height:"1018"})}),"\n",(0,r.jsx)(n.p,{children:"On a high level, Recon collects and aggregates metadata from Ozone Manager (OM), Storage Container Manager (SCM) and Datanodes (DN) and acts as a central management and monitoring console. Ozone administrators can use Recon to query the current state of the system without overloading OM or SCM."}),"\n",(0,r.jsx)(n.p,{children:"Recon maintains multiple databases to enable batch processing, faster querying and to persist aggregate information. It maintains a local copy of OM db and SCM db along with a SQL database for persisting aggregate information."}),"\n",(0,r.jsx)(n.p,{children:"Recon also integrates with Prometheus to provide a HTTP endpoint to query Prometheus for Ozone metrics and also to display a few crucial point in time metrics in the web UI."}),"\n",(0,r.jsx)(n.h2,{id:"recon-and-ozone-manager",children:"Recon and Ozone Manager"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Recon OM Design",src:s(59029).A+"",width:"2131",height:"958"})}),"\n",(0,r.jsx)(n.p,{children:"Recon gets a full snapshot of OM rocks db initially from the leader OM's HTTP endpoint, untars the file and initializes RocksDB for querying locally. The database is kept in sync by periodically requesting delta updates from the leader OM via RPC calls from the last applied sequence id. If for any reason, the delta updates could not be retrieved or applied to the local db, a full snapshot is requested again to keep the local db in sync with OM db. Due to this, Recon can show stale information since the local db will not always be in sync."}),"\n",(0,r.jsxs)(n.p,{children:["The db updates retrieved from OM is then converted into a batch of events for further processing by OM db tasks via ",(0,r.jsx)(n.a,{href:"#task-framework",children:"Recon Task Framework"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"recon-and-storage-container-manager",children:"Recon and Storage Container Manager"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Recon SCM Design",src:s(74542).A+"",width:"2038",height:"942"})}),"\n",(0,r.jsx)(n.p,{children:"Recon also acts as a passive SCM for Datanodes. When Recon is configured in the cluster, all the Datanodes register with Recon and send heartbeats, container reports, incremental container reports etc. to Recon similar to SCM. Recon uses all the information it gets from Datanodes to construct its own copy of SCM rocks db locally. Recon never sends any command to Datanodes in response and just acts as a passive SCM for faster lookup of SCM metadata."}),"\n",(0,r.jsx)(n.h2,{id:"task-framework",children:"Task Framework"}),"\n",(0,r.jsxs)(n.p,{children:["Recon has its own Task framework to enable batch processing of data obtained from OM and SCM. A task can listen to and act upon db events such as ",(0,r.jsx)(n.code,{children:"PUT"}),", ",(0,r.jsx)(n.code,{children:"DELETE"}),", ",(0,r.jsx)(n.code,{children:"UPDATE"}),", etc. on either OM db or SCM db. Based on this, a task either implements ",(0,r.jsx)(n.code,{children:"org.apache.hadoop.ozone.recon.tasks.ReconOmTask"})," or extends ",(0,r.jsx)(n.code,{children:"org.apache.hadoop.ozone.recon.scm.ReconScmTask"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["An example ",(0,r.jsx)(n.code,{children:"ReconOmTask"})," is ",(0,r.jsx)(n.code,{children:"ContainerKeyMapperTask"})," that persists the container -> key mapping in RocksDB. This is useful to understand which keys were part\nof the container when the container is reported missing or is in a bad health state. Another example is FileSizeCountTask which keeps track of count of\nfiles within a given file size range in a SQL database. These tasks have implementations for two scenarios:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Full snapshot (",(0,r.jsx)(n.code,{children:"reprocess()"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Delta updates (",(0,r.jsx)(n.code,{children:"process()"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["When a full snapshot of OM db is obtained from the leader OM, the ",(0,r.jsx)(n.code,{children:"reprocess()"})," is called on all the registered OM tasks. On subsequent delta updates, ",(0,r.jsx)(n.code,{children:"process()"})," is called on these OM tasks."]}),"\n",(0,r.jsxs)(n.p,{children:["An example ",(0,r.jsx)(n.code,{children:"ReconScmTask"})," is ",(0,r.jsx)(n.code,{children:"ContainerHealthTask"})," that runs in configurable intervals to scan the list of all the containers and to persist the state of unhealthy containers (",(0,r.jsx)(n.code,{children:"MISSING"}),", ",(0,r.jsx)(n.code,{children:"MIS_REPLICATED"}),", ",(0,r.jsx)(n.code,{children:"UNDER_REPLICATED"}),", ",(0,r.jsx)(n.code,{children:"OVER_REPLICATED"}),") in a SQL table. This information is used to determine if there are any missing containers in the cluster."]}),"\n",(0,r.jsx)(n.h2,{id:"recon-and-prometheus",children:"Recon and Prometheus"}),"\n",(0,r.jsxs)(n.p,{children:["Recon can integrate with any Prometheus instance configured to collected metrics and can display useful information in Recon UI in Datanodes and Pipelines pages. Recon also exposes a proxy endpoint\n(",(0,r.jsx)(n.a,{href:"https://ozone.apache.org/docs/edge/interface/reconapi.html#metrics",children:"/metrics"}),") to query Prometheus. This integration can be enabled by setting this configuration ",(0,r.jsx)(n.code,{children:"ozone.recon.prometheus.http.endpoint"})," to the Prometheus endpoint like ",(0,r.jsx)(n.code,{children:"ozone.recon.prometheus.http.endpoint=http://prometheus:9090"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"../../administrator-guide/operations/observability/recon/recon-rest-api",children:"Link to complete API Reference"})}),"\n",(0,r.jsx)(n.h2,{id:"persisted-state",children:"Persisted state"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A local copy of ",(0,r.jsx)(n.a,{href:"./ozone-manager#persisted-state",children:"OM database"})]}),"\n",(0,r.jsxs)(n.li,{children:["A local copy of ",(0,r.jsx)(n.a,{href:"./storage-container-manager#persisted-state",children:"SCM database"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The following data is persisted in Recon in the specified RocksDB directory:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ContainerKey table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Stores the mapping (container, key) -> count"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ContainerKeyCount table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Stores containerID -> no. of keys count within the container"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The following data is stored in the configured SQL database (",(0,r.jsx)(n.strong,{children:"default is Derby"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"GlobalStats table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A Key -> Value table to store aggregate information like total number of volumes / buckets / keys present in the cluster"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"FileCountBySize table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Keeps track of the number of files present within a file size range in the cluster"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ReconTaskStatus table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Keeps track of the status and last run timestamp of the registered OM and SCM db tasks in the ",(0,r.jsx)(n.a,{href:"#task-framework",children:"Recon Task Framework"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"ContainerHistory table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Stores ContainerReplica -> Datanode mapping with last known timestamp. This is used to determine the last known Datanodes when a container is reported missing"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"UnhealthyContainers table"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Keeps track of all the Unhealthy Containers (MISSING, UNDER_REPLICATED, OVER_REPLICATED, MIS_REPLICATED) in the cluster at any given time"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"notable-configurations",children:"Notable configurations"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Key"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.http-address"})}),(0,r.jsx)(n.td,{children:"0.0.0.0:9888"}),(0,r.jsx)(n.td,{children:"The address and the base port where the Recon web UI will listen on."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.address"})}),(0,r.jsx)(n.td,{children:"0.0.0.0:9891"}),(0,r.jsx)(n.td,{children:"RPC address of the Recon."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.heatmap.provider"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"HeatMapProvider for Recon."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.db.dir"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Directory where the Recon Server stores its metadata."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.om.db.dir"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Directory where the Recon Server stores its OM snapshot DB."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.om.snapshot.task.interval.delay"})}),(0,r.jsx)(n.td,{children:"10m"}),(0,r.jsx)(n.td,{children:"Interval in MINUTES by Recon to request OM DB Snapshot / delta updates."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.task.missingcontainer.interval"})}),(0,r.jsx)(n.td,{children:"300s"}),(0,r.jsx)(n.td,{children:"Time interval of the periodic check for Unhealthy Containers in the cluster."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.task.safemode.wait.threshold"})}),(0,r.jsx)(n.td,{children:"300s"}),(0,r.jsx)(n.td,{children:"Max time for Recon to wait before it exits out of safe or warmup mode."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.sql.db.jooq.dialect"})}),(0,r.jsx)(n.td,{children:"DERBY"}),(0,r.jsxs)(n.td,{children:["Please refer to ",(0,r.jsx)(n.a,{href:"https://www.jooq.org/javadoc/latest/org.jooq/org/jooq/SQLDialect.html",children:"SQL Dialect"})," to specify a different dialect."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.sql.db.jdbc.url"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"jdbc:derby:$&#123;ozone.recon.db.dir&#125;"}),(0,r.jsx)("br",{}),(0,r.jsx)(n.code,{children:"/ozone_recon_derby.db"})]}),(0,r.jsx)(n.td,{children:"Recon SQL database jdbc url."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.sql.db.username"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Recon SQL database username."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.sql.db.password"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Recon SQL database password."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.sql.db.driver"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"org.apache.derby.jdbc.EmbeddedDriver"})}),(0,r.jsx)(n.td,{children:"Recon SQL database jdbc driver."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.prometheus.http.endpoint"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsxs)(n.td,{children:["Prometheus HTTP endpoint URL for Recon to integrate with Prometheus. Enables display of metrics in Recon UI and exposes a proxy endpoint to query Prometheus. Example: ",(0,r.jsx)(n.code,{children:"http://prometheus:9090"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.scmconfig"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Prefix for SCM configuration."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.db.dirs.permissions"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"750"})}),(0,r.jsx)(n.td,{children:"Permissions for the metadata directories for Recon. The permissions can either be octal or symbolic. If the default permissions are not set then the default value of 750 will be used."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.datanode.address"})}),(0,r.jsx)(n.td,{children:"none"}),(0,r.jsx)(n.td,{children:"Datanode address for Recon."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.heatmap.enable"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"false"})}),(0,r.jsxs)(n.td,{children:["To enable/disable Recon heatmap feature. Along with this config, user must also provide the implementation of ",(0,r.jsx)(n.code,{children:"org.apache.hadoop.ozone.recon.heatmap.IHeatMapProvider"})," interface and configure in ",(0,r.jsx)(n.code,{children:"ozone.recon.heatmap.provider"})," configuration."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.https-address"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"0.0.0.0:9889"})}),(0,r.jsx)(n.td,{children:"The address and the base port where the Recon web UI will listen on using HTTPS. If the port is 0 then the server will start on a free port."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ozone.recon.datanode.bind.host"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"0.0.0.0"})}),(0,r.jsx)(n.td,{children:"Bind host for Datanode address."})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},59029:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/ReconOmDesign-0027b37ae6de87428bb247838100eb75.png"},62392:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(30758);const r={},o=t.createContext(r);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:n},e.children)}},74542:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/ReconScmDesign-0821f5808e438bc50c2770e8ec4a3c3c.png"}}]);