"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[9167],{17029:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"administrator-guide/operations/disk-replacement/storage-container-manager","title":"Replacing Storage Container Manager Disks","description":"Audience: Cluster Administrators","source":"@site/versioned_docs/version-2.1.0/05-administrator-guide/03-operations/04-disk-replacement/02-storage-container-manager.md","sourceDirName":"05-administrator-guide/03-operations/04-disk-replacement","slug":"/administrator-guide/operations/disk-replacement/storage-container-manager","permalink":"/docs/administrator-guide/operations/disk-replacement/storage-container-manager","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/versioned_docs/version-2.1.0/05-administrator-guide/03-operations/04-disk-replacement/02-storage-container-manager.md","tags":[],"version":"2.1.0","sidebarPosition":2,"frontMatter":{"sidebar_label":"Storage Container Manager"},"sidebar":"defaultSidebar","previous":{"title":"Ozone Manager","permalink":"/docs/administrator-guide/operations/disk-replacement/ozone-manager"},"next":{"title":"Datanodes","permalink":"/docs/administrator-guide/operations/disk-replacement/datanodes"}}');var r=s(86070),t=s(62392);const o={sidebar_label:"Storage Container Manager"},a="Replacing Storage Container Manager Disks",d={},l=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Pre-flight Checks",id:"2-pre-flight-checks",level:2},{value:"3. Procedure for a Standalone (Non-HA) SCM",id:"3-procedure-for-a-standalone-non-ha-scm",level:2},{value:"4. Procedure for an HA (Ratis-based) SCM",id:"4-procedure-for-an-ha-ratis-based-scm",level:2},{value:"Bootstrap Procedure",id:"bootstrap-procedure",level:3},{value:"5. Additional Considerations",id:"5-additional-considerations",level:2},{value:"5.1 Primordial SCM Node",id:"51-primordial-scm-node",level:3},{value:"5.2 Disk Space Requirements for Snapshots",id:"52-disk-space-requirements-for-snapshots",level:3},{value:"5.3 Backups are Still Essential",id:"53-backups-are-still-essential",level:3},{value:"5.4 Bootstrap vs. Init",id:"54-bootstrap-vs-init",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"replacing-storage-container-manager-disks",children:"Replacing Storage Container Manager Disks"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Audience:"})," Cluster Administrators"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Prerequisites:"})," Familiarity with Ozone cluster administration, especially SCM and its HA configuration."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,r.jsx)(n.p,{children:"When a disk containing the Storage Container Manager (SCM) metadata directory fails, proper recovery procedures are critical to maintain cluster availability and prevent data loss."}),"\n",(0,r.jsxs)(n.p,{children:["If the disk containing SCM metadata directory (",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"}),") needs to be replaced for whatever reason, the SCM metadata directory will need to be reconstructed by running ",(0,r.jsx)(n.code,{children:"ozone scm --bootstrap"})," (assuming SCM HA is configured)."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose :"}),"\nThis guide details the procedure for replacing a failed disk on an SCM node."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Impact of SCM Disk Failure :"}),"\nThe SCM disk is critical, as it stores the RocksDB database containing the state of the entire cluster's physical storage, including:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Datanode registration and heartbeat status."}),"\n",(0,r.jsx)(n.li,{children:"Pipeline information and states."}),"\n",(0,r.jsx)(n.li,{children:"Container locations and replica information."}),"\n",(0,r.jsx)(n.li,{children:"A failure of this disk without a proper recovery plan can render the cluster unable to manage storage or allocate new blocks."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Crucial Distinction: HA vs. Non-HA :"}),"\nThe procedure depends entirely on whether your SCM is a single, standalone instance or part of a High-Availability (HA) Ratis-based quorum. Running a standalone SCM is a single point of failure and is not recommended for production environments."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-pre-flight-checks",children:"2. Pre-flight Checks"}),"\n",(0,r.jsx)(n.p,{children:"Before starting, the administrator should:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Identify the Failed Disk:"})," Use system tools (",(0,r.jsx)(n.code,{children:"dmesg"}),", ",(0,r.jsx)(n.code,{children:"smartctl"}),", etc.) to confirm which disk has failed and its mount point."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Identify SCM Directories:"})," Check your ",(0,r.jsx)(n.code,{children:"ozone-site.xml"})," to confirm which Ozone directories are on the failed disk. The most important properties are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"}),": The primary SCM metadata database (RocksDB). This directory stores the entire cluster's block management metadata."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ozone.scm.ha.ratis.storage.dir"}),": The location for SCM's internal HA Ratis logs (in an HA setup). This directory stores Ratis metadata like logs. If not explicitly configured, it falls back to ",(0,r.jsx)(n.code,{children:"ozone.metadata.dirs"}),". For production environments, it is recommended to configure this on a separate, fast disk (preferably SSD) for better performance."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ozone.scm.ha.ratis.snapshot.dir"}),": The directory where SCM stores snapshot tarballs downloaded from the leader during recovery. If not explicitly configured, it defaults to a component-specific location under ",(0,r.jsx)(n.code,{children:"ozone.metadata.dirs"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Prepare the Replacement Disk:"})," Physically install a new, healthy disk. Format it and mount it at the same path as the failed disk. Ensure it has the correct ownership and permissions for the user that runs the SCM process. The default permissions for SCM metadata directories are ",(0,r.jsx)(n.strong,{children:"750"})," (configurable via ",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs.permissions"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-procedure-for-a-standalone-non-ha-scm",children:"3. Procedure for a Standalone (Non-HA) SCM"}),"\n",(0,r.jsx)(n.p,{children:"This procedure is a critical disaster recovery event that requires full cluster downtime and a valid backup."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STOP THE ENTIRE CLUSTER:"})," Shut down all clients, Datanodes, OMs, and the SCM. Without a functional SCM, Datanodes cannot heartbeat and new block allocations will fail."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Attempt Data Recovery:"})," If possible, make a best-effort attempt to copy the contents of the ",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"})," directory from the failing disk to a safe, temporary location."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"If Recovery Fails, Restore from Backup:"})," If the SCM database is unrecoverable, you must restore it from your most recent backup. Without a backup, you risk permanent data loss or a lengthy, complex, and potentially incomplete state reconstruction from Datanode reports. If Recon is deployed, its local SCM copy (from Datanode reports) may be usable as a recovery source\u2014see ",(0,r.jsx)(n.a,{href:"/docs/core-concepts/architecture/recon",children:"Recon"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replace and Configure Disk:"})," Physically replace the hardware and ensure the new, empty disk is mounted at the correct path defined in ",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Restore Metadata:"})," Copy the recovered data ",(0,r.jsx)(n.strong,{children:"(from Step 2)"})," or the restored backup data ",(0,r.jsx)(n.strong,{children:"(from Step 3)"})," to the ",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"})," path on the new disk."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Restart and Verify:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Start the SCM service first."}),"\n",(0,r.jsx)(n.li,{children:"Once the SCM is fully initialized and running, start the OMs and then the Datanodes."}),"\n",(0,r.jsx)(n.li,{children:"Check the SCM Web UI to confirm that Datanodes are sending heartbeats and that pipelines are healthy. Run client I/O tests to ensure the cluster is fully operational."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-procedure-for-an-ha-ratis-based-scm",children:"4. Procedure for an HA (Ratis-based) SCM"}),"\n",(0,r.jsx)(n.p,{children:"This is the recommended production procedure. It leverages the HA quorum for recovery, requires no cluster downtime, and is much safer."}),"\n",(0,r.jsx)(n.h3,{id:"bootstrap-procedure",children:"Bootstrap Procedure"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"STOP THE FAILED SCM INSTANCE:"})," On the node with the failed disk, stop only the SCM process. The other SCMs will continue to operate, and one of them will remain the leader, managing the cluster."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replace and Configure Disk:"})," Physically replace the hardware. Mount the new, empty disk at the path(s) defined in ",(0,r.jsx)(n.code,{children:"ozone.scm.db.dirs"})," and ",(0,r.jsx)(n.code,{children:"ozone.scm.ha.ratis.storage.dir"}),". Ensure correct ownership and permissions. If ",(0,r.jsx)(n.code,{children:"ozone.scm.ha.ratis.snapshot.dir"})," was also on the failed disk, ensure it is properly configured on the new disk as well."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Verify Configuration:"})," Before proceeding, ensure that all existing SCMs have their ",(0,r.jsx)(n.code,{children:"ozone-site.xml"})," configuration files updated with the configuration details of the SCM being recovered (nodeId, address, ports, etc.). The bootstrap process will verify connectivity to existing SCM instances."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"RE-INITIALIZE THE SCM VIA BOOTSTRAP:"})," The failed SCM has lost its state and must rejoin the HA cluster by getting a full copy of the latest state from the current leader. This is done using the ",(0,r.jsx)(n.code,{children:"scm --bootstrap"})," command."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Run the bootstrap command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"bin/ozone scm --bootstrap\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The bootstrap command will:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Connect to the existing SCM HA ring."}),"\n",(0,r.jsx)(n.li,{children:"Fetch the cluster ID from the current leader."}),"\n",(0,r.jsx)(n.li,{children:"Initialize the local SCM storage configuration with the cluster ID."}),"\n",(0,r.jsx)(n.li,{children:"Set up security certificates if security is enabled."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"The bootstrap command does NOT start the SCM daemon. It only prepares the configuration and storage state. You must start the SCM service separately after bootstrap completes."})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"START THE SCM AND MONITOR:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start the SCM service on the repaired node:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"ozone --daemon start scm\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Monitor the console output and the SCM's log files (",(0,r.jsx)(n.code,{children:".log"})," and ",(0,r.jsx)(n.code,{children:".out"}),"). You will see messages indicating that:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"The SCM is connecting to the existing SCM HA ring."}),"\n",(0,r.jsx)(n.li,{children:"The leader SCM is creating a database checkpoint (snapshot)."}),"\n",(0,r.jsx)(n.li,{children:"The checkpoint is being downloaded and installed locally."}),"\n",(0,r.jsx)(n.li,{children:"The SCM is joining the Ratis ring as a follower."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"This process can take some time, depending on the size of your metadata and network bandwidth."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"VERIFY:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Once the snapshot installation is complete and the SCM has joined the ring, check the ",(0,r.jsx)(n.strong,{children:"SCM Web UI"})," from any of the SCM nodes. The list of peers should now show all SCMs as healthy."]}),"\n",(0,r.jsxs)(n.li,{children:["Alternatively, use the command ",(0,r.jsx)(n.code,{children:"ozone admin scm roles -id <SCM_SERVICE_ID>"})," to verify that all SCMs are showing as LEADER or FOLLOWER."]}),"\n",(0,r.jsx)(n.li,{children:"The cluster is back at full redundancy and the procedure is complete."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-additional-considerations",children:"5. Additional Considerations"}),"\n",(0,r.jsx)(n.h3,{id:"51-primordial-scm-node",children:"5.1 Primordial SCM Node"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In an HA setup, the first SCM started with ",(0,r.jsx)(n.code,{children:"scm --init"}),' is the "primordial" node, which generates the cluster\'s unique ID and (in secure clusters) the root CA for SCM certificates.']}),"\n",(0,r.jsx)(n.li,{children:"The primordial node is only required during initial SCM HA establishment. After the cluster is running, the primordial SCM can fail or be decommissioned with no impact to the cluster; the leader SCM's sub-CA issues certificates to OM and Datanodes."}),"\n",(0,r.jsx)(n.li,{children:"The cluster ID is preserved by the surviving SCMs and will be replicated to the repaired node when that node successfully runs bootstrap."}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"ozone.scm.primordial.node.id"})," is set, bootstrap ",(0,r.jsx)(n.strong,{children:"skips"})," on that node (no cluster ID fetch, no storage init). So on a repaired primordial node, ",(0,r.jsx)(n.code,{children:"scm --bootstrap"})," alone does ",(0,r.jsx)(n.strong,{children:"not"})," recover from other SCMs."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Primordial disk replaced:"})," On the repaired node, temporarily set ",(0,r.jsx)(n.code,{children:"ozone.scm.primordial.node.id"})," to another SCM (or unset it), then run ",(0,r.jsx)(n.code,{children:"scm --bootstrap"})," and ",(0,r.jsx)(n.code,{children:"ozone --daemon start scm"}),". Optionally set the property back after the node rejoins the ring."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"52-disk-space-requirements-for-snapshots",children:"5.2 Disk Space Requirements for Snapshots"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Critical:"})," When an SCM acts as a follower in an HA setup and needs to recover, it downloads snapshot tarballs from the leader to its local snapshot directory (",(0,r.jsx)(n.code,{children:"ozone.scm.ha.ratis.snapshot.dir"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Always ensure your SCM disks have ",(0,r.jsx)(n.strong,{children:"at least 2x the current SCM database size"})," to accommodate the existing data and incoming snapshots."]}),"\n",(0,r.jsx)(n.li,{children:"This prevents disk space issues and maintains cluster stability."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"53-backups-are-still-essential",children:"5.3 Backups are Still Essential"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Even in a robust HA configuration, maintaining regular, off-site backups of the SCM database is a critical best practice."}),"\n",(0,r.jsx)(n.li,{children:"Backups are essential for recovering from catastrophic multi-node failures or logical data corruption."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"54-bootstrap-vs-init",children:"5.4 Bootstrap vs. Init"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"scm --bootstrap"})," command is different from ",(0,r.jsx)(n.code,{children:"scm --init"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"scm --init"}),": Used only for the first SCM node (primordial node) to initialize a new cluster. Creates a new cluster ID."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"scm --bootstrap"}),": Used for additional SCM nodes joining an existing HA cluster, or for recovering a failed SCM node. Fetches the cluster ID from existing SCM instances."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["After a disk replacement on a ",(0,r.jsx)(n.strong,{children:"non-primordial"})," SCM node, use ",(0,r.jsx)(n.code,{children:"scm --bootstrap"})," then start the SCM. If the disk was replaced on the ",(0,r.jsx)(n.strong,{children:"primordial"})," node, see ",(0,r.jsx)(n.a,{href:"#51-primordial-scm-node",children:"\xa75.1 Primordial SCM Node"})," for the required temporary configuration change before running bootstrap."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},62392:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(30758);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);