"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[1749],{40336:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"administrator-guide/configuration/high-availability/scm-ha","title":"SCM High Availability Configuration","description":"Configuration","source":"@site/docs/05-administrator-guide/02-configuration/06-high-availability/01-scm-ha.md","sourceDirName":"05-administrator-guide/02-configuration/06-high-availability","slug":"/administrator-guide/configuration/high-availability/scm-ha","permalink":"/docs/administrator-guide/configuration/high-availability/scm-ha","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/05-administrator-guide/02-configuration/06-high-availability/01-scm-ha.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"SCM HA Configuration"},"sidebar":"defaultSidebar","previous":{"title":"High Availability","permalink":"/docs/administrator-guide/configuration/high-availability/"},"next":{"title":"Operations","permalink":"/docs/administrator-guide/operations/"}}');var s=i(86070),o=i(62392);const r={sidebar_label:"SCM HA Configuration"},a="SCM High Availability Configuration",d={},l=[{value:"Configuration",id:"configuration",level:2},{value:"Bootstrap",id:"bootstrap",level:2},{value:"SCM Leader Transfer",id:"scm-leader-transfer",level:2},{value:"Auto-bootstrap",id:"auto-bootstrap",level:2},{value:"SCM HA Security",id:"scm-ha-security",level:2},{value:"How to enable security",id:"how-to-enable-security",level:3},{value:"Primordial SCM",id:"primordial-scm",level:3},{value:"Bootstrap SCM",id:"bootstrap-scm",level:3},{value:"Current SCM HA Security limitation",id:"current-scm-ha-security-limitation",level:3},{value:"Implementation details",id:"implementation-details",level:2},{value:"Verify SCM HA setup",id:"verify-scm-ha-setup",level:2},{value:"Migrating from Non-HA to HA SCM",id:"migrating-from-non-ha-to-ha-scm",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"scm-high-availability-configuration",children:"SCM High Availability Configuration"})}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["One Ozone configuration (",(0,s.jsx)(n.code,{children:"ozone-site.xml"}),") can support multiple SCM HA node set, multiple Ozone clusters. To select between the available SCM nodes a logical name is required for each of the clusters which can be resolved to the IP addresses (and domain names) of the Storage Container Managers."]}),"\n",(0,s.jsxs)(n.p,{children:["This logical name is called ",(0,s.jsx)(n.code,{children:"serviceId"})," and can be configured in the ",(0,s.jsx)(n.code,{children:"ozone-site.xml"})]}),"\n",(0,s.jsx)(n.p,{children:"Most of the time you need to set only the values of your current cluster:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n   <name>ozone.scm.service.ids</name>\n   <value>cluster1</value>\n</property>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For each of the defined ",(0,s.jsx)(n.code,{children:"serviceId"})," a logical configuration name should be defined for each of the servers"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n   <name>ozone.scm.nodes.cluster1</name>\n   <value>scm1,scm2,scm3</value>\n</property>\n"})}),"\n",(0,s.jsx)(n.p,{children:"The defined prefixes can be used to define the address of each of the SCM services:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n   <name>ozone.scm.address.cluster1.scm1</name>\n   <value>host1</value>\n</property>\n<property>\n   <name>ozone.scm.address.cluster1.scm2</name>\n   <value>host2</value>\n</property>\n<property>\n   <name>ozone.scm.address.cluster1.scm3</name>\n   <value>host3</value>\n</property>\n"})}),"\n",(0,s.jsx)(n.p,{children:"For reliable HA support choose 3 independent nodes to form a quorum."}),"\n",(0,s.jsx)(n.h2,{id:"bootstrap",children:"Bootstrap"}),"\n",(0,s.jsxs)(n.p,{children:["The initialization of the ",(0,s.jsx)(n.strong,{children:"first"})," SCM-HA node is the same as a non-HA SCM:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ozone scm --init\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Second and third nodes should be ",(0,s.jsx)(n.em,{children:"bootstrapped"})," instead of init. These clusters will join to the configured RAFT quorum. The id of the current server is identified by DNS name or can be set explicitly by ",(0,s.jsx)(n.code,{children:"ozone.scm.node.id"}),". Most of the time you don't need to set it as DNS based id detection can work well."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ozone scm --bootstrap\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note: both commands perform one-time initialization.  SCM still needs to be started by running ",(0,s.jsx)(n.code,{children:"ozone --daemon start scm"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"scm-leader-transfer",children:"SCM Leader Transfer"}),"\n",(0,s.jsxs)(n.p,{children:["For information on manually transferring SCM leadership, refer to the ",(0,s.jsx)(n.a,{href:"/docs/administrator-guide/operations/leader-transfer/storage-container-manager",children:"Storage Container Manager Leader Transfer"})," documentation."]}),"\n",(0,s.jsx)(n.h2,{id:"auto-bootstrap",children:"Auto-bootstrap"}),"\n",(0,s.jsx)(n.p,{children:"In some environments (e.g. Kubernetes) we need to have a common, unified way to initialize SCM HA quorum. As a reminder, the standard initialization flow is the following:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:['On the first, "primordial" node: ',(0,s.jsx)(n.code,{children:"ozone scm --init"})]}),"\n",(0,s.jsxs)(n.li,{children:["On second/third nodes: ",(0,s.jsx)(n.code,{children:"ozone scm --bootstrap"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["This can be improved: primordial SCM can be configured by setting ",(0,s.jsx)(n.code,{children:"ozone.scm.primordial.node.id"})," in the config to one of the nodes."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n   <name>ozone.scm.primordial.node.id</name>\n   <value>scm1</value>\n</property>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["With this configuration both ",(0,s.jsx)(n.code,{children:"scm --init"})," and ",(0,s.jsx)(n.code,{children:"scm --bootstrap"})," can be safely executed on ",(0,s.jsx)(n.strong,{children:"all"})," SCM nodes.  Each node will only perform the action applicable to it based on the ",(0,s.jsx)(n.code,{children:"ozone.scm.primordial.node.id"})," and its own node ID."]}),"\n",(0,s.jsx)(n.p,{children:"Note: SCM still needs to be started after the init/bootstrap process."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ozone scm --init\nozone scm --bootstrap\nozone --daemon start scm\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For Docker/Kubernetes, use ",(0,s.jsx)(n.code,{children:"ozone scm"})," to start it in the foreground."]}),"\n",(0,s.jsx)(n.h2,{id:"scm-ha-security",children:"SCM HA Security"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"SCM Secure HA",src:i(85856).A+"",width:"781",height:"568"})}),"\n",(0,s.jsx)(n.p,{children:"In a secure SCM HA cluster on the SCM where we perform init, we call this SCM as a primordial SCM.\nPrimordial SCM starts root-CA with self-signed certificates and is used to issue a signed certificate\nto itself and other bootstrapped SCM's. Only primordial SCM can issue signed certificates for other SCM's.\nSo, primordial SCM has a special role in the SCM HA cluster, as it is the only one that can issue certificates to SCM's."}),"\n",(0,s.jsx)(n.p,{children:"The primordial SCM takes a root-CA role, which signs all SCM instances with a sub-CA certificate.\nThe sub-CA certificates are used by SCM to sign certificates for OM/Datanodes."}),"\n",(0,s.jsx)(n.p,{children:"When bootstrapping a SCM, it gets a signed certificate from the primary SCM and starts sub-CA."}),"\n",(0,s.jsx)(n.p,{children:"Sub-CA on the SCM's are used to issue signed certificates for OM/DN in the cluster. Only the leader SCM issues a certificate to OM/DN."}),"\n",(0,s.jsx)(n.h3,{id:"how-to-enable-security",children:"How to enable security"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n<name>ozone.security.enable</name>\n<value>true</value>\n</property>\n\n<property>\n<name>hdds.grpc.tls.enabled</name>\n<value>true</value>\n</property>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Above configs are needed in addition to normal SCM HA configuration."}),"\n",(0,s.jsx)(n.h3,{id:"primordial-scm",children:"Primordial SCM"}),"\n",(0,s.jsxs)(n.p,{children:["Primordial SCM is determined from the config ",(0,s.jsx)(n.code,{children:"ozone.scm.primordial.node.id"}),".\nThe value for this can be node id or hostname of the SCM. If the config is\nnot defined, the node where init is run is considered as the primordial SCM."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bin/ozone scm --init\n"})}),"\n",(0,s.jsx)(n.p,{children:"This will set up a public,private key pair and self-signed certificate for root CA\nand also generate public, private key pair and CSR to get a signed certificate for sub-CA from root CA."}),"\n",(0,s.jsx)(n.h3,{id:"bootstrap-scm",children:"Bootstrap SCM"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bin/ozone scm --bootstrap\n"})}),"\n",(0,s.jsx)(n.p,{children:"This will set up a public, private key pair for sub CA and generate CSR to get a\nsigned certificate for sub-CA from root CA."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": Make sure to run ",(0,s.jsx)(n.strong,{children:"--init"})," only on one of the SCM host if\nprimordial SCM is not defined. Bring up other SCM's using ",(0,s.jsx)(n.strong,{children:"--bootstrap"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"current-scm-ha-security-limitation",children:"Current SCM HA Security limitation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Unsecure HA cluster upgrade to secure HA cluster is not supported."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-details",children:"Implementation details"}),"\n",(0,s.jsx)(n.p,{children:"SCM HA uses Apache Ratis to replicate state between the members of the SCM HA quorum. Each node maintains the block management metadata in local RocksDB."}),"\n",(0,s.jsx)(n.p,{children:"This replication process is a simpler version of OM HA replication process as it doesn't use any double buffer (as the overall db thourghput of SCM requests are lower)"}),"\n",(0,s.jsxs)(n.p,{children:["Datanodes are sending all the reports (Container reports, Pipeline reports...) to ",(0,s.jsx)(n.em,{children:"all"})," SCM nodes in parallel. Only the leader node can assign/create new containers, and only the leader node sends commands back to the Datanodes."]}),"\n",(0,s.jsx)(n.h2,{id:"verify-scm-ha-setup",children:"Verify SCM HA setup"}),"\n",(0,s.jsx)(n.p,{children:"After starting an SCM-HA it can be validated if the SCM nodes are forming one single quorum instead of 3 individual SCM nodes."}),"\n",(0,s.jsx)(n.p,{children:"First, check if all the SCM nodes store the same ClusterId metadata:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cat /data/metadata/scm/current/VERSION\n"})}),"\n",(0,s.jsx)(n.p,{children:"ClusterId is included in the VERSION file and should be the same in all the SCM nodes:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#Tue Mar 16 10:19:33 UTC 2021\ncTime=1615889973116\nclusterID=CID-130fb246-1717-4313-9b62-9ddfe1bcb2e7\nnodeType=SCM\nscmUuid=e6877ce5-56cd-4f0b-ad60-4c8ef9000882\nlayoutVersion=0\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can also create data and double check with ",(0,s.jsx)(n.code,{children:"ozone debug"})," tool if all the container metadata is replicated."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bin/ozone freon randomkeys --numOfVolumes=1 --numOfBuckets=1 --numOfKeys=10000 --keySize=524288 --replicationType=RATIS --numOfThreads=8 --factor=THREE --bufferSize=1048576\n\n\n# use debug ldb to check scm.db on all the machines\nbin/ozone debug ldb --db=/tmp/metadata/scm.db ls\n\n\nbin/ozone debug ldb --db=/tmp/metadata/scm.db scan --column-family=containers\n"})}),"\n",(0,s.jsx)(n.h2,{id:"migrating-from-non-ha-to-ha-scm",children:"Migrating from Non-HA to HA SCM"}),"\n",(0,s.jsxs)(n.p,{children:["Add additional SCM nodes and extend the cluster configuration to reflect the newly added nodes.\nBootstrap the newly added SCM nodes with ",(0,s.jsx)(n.code,{children:"scm --bootstrap"})," command and start the SCM service.\nNote: Make sure that the ",(0,s.jsx)(n.code,{children:"ozone.scm.primordial.node.id"})," property is pointed to the existing SCM before you run the ",(0,s.jsx)(n.code,{children:"bootstrap"})," command on the newly added SCM nodes."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},62392:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>a});var t=i(30758);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},85856:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/scm-secure-ha-dfd97a3f493e0fe6e7049dc8f4ddd9f3.png"}}]);