"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[3742],{49378:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"administrator-guide/operations/disk-replacement/datanodes","title":"Replacing Datanode Disks","description":"Overview","source":"@site/docs/05-administrator-guide/03-operations/04-disk-replacement/03-datanodes.md","sourceDirName":"05-administrator-guide/03-operations/04-disk-replacement","slug":"/administrator-guide/operations/disk-replacement/datanodes","permalink":"/docs/next/administrator-guide/operations/disk-replacement/datanodes","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/docs/05-administrator-guide/03-operations/04-disk-replacement/03-datanodes.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_label":"Datanodes"},"sidebar":"defaultSidebar","previous":{"title":"Storage Container Manager","permalink":"/docs/next/administrator-guide/operations/disk-replacement/storage-container-manager"},"next":{"title":"Recon","permalink":"/docs/next/administrator-guide/operations/disk-replacement/recon"}}');var s=i(86070),d=i(62392);const t={sidebar_label:"Datanodes"},l="Replacing Datanode Disks",r={},o=[{value:"Overview",id:"overview",level:2},{value:"Volume Configuration",id:"volume-configuration",level:2},{value:"Data Volumes",id:"data-volumes",level:3},{value:"Metadata Volumes",id:"metadata-volumes",level:3},{value:"Database Volumes",id:"database-volumes",level:3},{value:"Volume Failure Tolerance",id:"volume-failure-tolerance",level:2},{value:"Data Volume Failure Tolerance",id:"data-volume-failure-tolerance",level:3},{value:"Metadata Volume Failure Tolerance",id:"metadata-volume-failure-tolerance",level:3},{value:"Database Volume Failure Tolerance",id:"database-volume-failure-tolerance",level:3},{value:"Volume Failure Detection",id:"volume-failure-detection",level:2},{value:"Startup Checks",id:"startup-checks",level:3},{value:"Periodic Disk Checks",id:"periodic-disk-checks",level:3},{value:"Disk Check Configuration",id:"disk-check-configuration",level:3},{value:"Failed Volume Handling",id:"failed-volume-handling",level:2},{value:"Replacing Failed Disks",id:"replacing-failed-disks",level:2},{value:"Steps to Replace a Failed Disk",id:"steps-to-replace-a-failed-disk",level:3},{value:"Physical Disk Replacement",id:"physical-disk-replacement",level:3},{value:"Monitoring Volume Health",id:"monitoring-volume-health",level:2},{value:"Best Practices",id:"best-practices",level:2}];function c(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"replacing-datanode-disks",children:"Replacing Datanode Disks"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Ozone Datanodes can manage multiple data volumes (disks) simultaneously. This document describes how volume failures are detected, handled, and how to replace failed disks in an Ozone Datanode."}),"\n",(0,s.jsx)(n.h2,{id:"volume-configuration",children:"Volume Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"data-volumes",children:"Data Volumes"}),"\n",(0,s.jsxs)(n.p,{children:["Data volumes are configured using the ",(0,s.jsx)(n.code,{children:"hdds.datanode.dir"})," property. Each directory represents a volume (disk) that the Datanode will manage."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>hdds.datanode.dir</name>\n  <value>/data1,/data2,/data3</value>\n</property>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This configuration tells the Datanode to manage three separate volumes: ",(0,s.jsx)(n.code,{children:"/data1"}),", ",(0,s.jsx)(n.code,{children:"/data2"}),", and ",(0,s.jsx)(n.code,{children:"/data3"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"metadata-volumes",children:"Metadata Volumes"}),"\n",(0,s.jsxs)(n.p,{children:["Metadata volumes store Ratis metadata (logs) and are configured using ",(0,s.jsx)(n.code,{children:"hdds.container.ratis.datanode.storage.dir"}),". If not explicitly configured, metadata is stored in the default metadata directories."]}),"\n",(0,s.jsx)(n.h3,{id:"database-volumes",children:"Database Volumes"}),"\n",(0,s.jsxs)(n.p,{children:["Database volumes store per-volume RocksDB instances and are configured using ",(0,s.jsx)(n.code,{children:"hdds.datanode.container.db.dir"}),". This is optional - if not specified, RocksDB instances are stored on the same disk as HDDS data."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"By default, metadata and database volumes share the same physical disks as data volumes. They can be configured on separate disks (e.g., SSDs) for better performance, but this is optional."})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"volume-failure-tolerance",children:"Volume Failure Tolerance"}),"\n",(0,s.jsx)(n.p,{children:"Ozone Datanodes can tolerate a configurable number of volume failures before stopping service. The following configuration properties control this behavior:"}),"\n",(0,s.jsx)(n.h3,{id:"data-volume-failure-tolerance",children:"Data Volume Failure Tolerance"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Property:"})," ",(0,s.jsx)(n.code,{children:"hdds.datanode.failed.data.volumes.tolerated"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Default:"})," ",(0,s.jsx)(n.code,{children:"-1"})," (unlimited)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Description:"})," The number of data volumes that are allowed to fail before a Datanode stops offering service. When set to ",(0,s.jsx)(n.code,{children:"-1"}),", unlimited failures are tolerated, but ",(0,s.jsx)(n.strong,{children:"at least one good volume must remain"})," for the Datanode to continue operating."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>hdds.datanode.failed.data.volumes.tolerated</name>\n  <value>2</value>\n</property>\n"})}),"\n",(0,s.jsx)(n.p,{children:"This allows up to 2 data volumes to fail before the Datanode stops service."}),"\n",(0,s.jsx)(n.h3,{id:"metadata-volume-failure-tolerance",children:"Metadata Volume Failure Tolerance"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Property:"})," ",(0,s.jsx)(n.code,{children:"hdds.datanode.failed.metadata.volumes.tolerated"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Default:"})," ",(0,s.jsx)(n.code,{children:"-1"})," (unlimited)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Description:"})," The number of metadata volumes that are allowed to fail before a Datanode stops offering service. Similar to data volumes, ",(0,s.jsx)(n.code,{children:"-1"})," means unlimited failures are tolerated, but at least one good metadata volume must remain."]}),"\n",(0,s.jsx)(n.h3,{id:"database-volume-failure-tolerance",children:"Database Volume Failure Tolerance"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Property:"})," ",(0,s.jsx)(n.code,{children:"hdds.datanode.failed.db.volumes.tolerated"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Default:"})," ",(0,s.jsx)(n.code,{children:"-1"})," (unlimited)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Description:"})," The number of database volumes that are allowed to fail before a Datanode stops offering service. When set to ",(0,s.jsx)(n.code,{children:"-1"}),", unlimited failures are tolerated, but at least one good database volume must remain."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"volume-failure-detection",children:"Volume Failure Detection"}),"\n",(0,s.jsx)(n.h3,{id:"startup-checks",children:"Startup Checks"}),"\n",(0,s.jsx)(n.p,{children:"During Datanode startup, the system performs comprehensive checks on all configured volumes to determine if any have failed. The initialization process:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Parses all volume locations from configuration"}),"\n",(0,s.jsx)(n.li,{children:"Attempts to create and access each volume"}),"\n",(0,s.jsx)(n.li,{children:"Performs directory existence and permission checks"}),"\n",(0,s.jsx)(n.li,{children:"Moves failed volumes to a separate failed volume map"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"If a volume fails during initialization:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The volume is immediately marked as failed"}),"\n",(0,s.jsx)(n.li,{children:"It is moved from the active volume map to the failed volume map"}),"\n",(0,s.jsx)(n.li,{children:"The Datanode continues startup if enough volumes remain (based on tolerance settings)"}),"\n",(0,s.jsx)(n.li,{children:"If all volumes fail or tolerance limits are exceeded, the Datanode will abort startup"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"periodic-disk-checks",children:"Periodic Disk Checks"}),"\n",(0,s.jsx)(n.p,{children:"After startup, the Datanode runs periodic disk health checks to detect volumes that fail during runtime."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Property:"})," ",(0,s.jsx)(n.code,{children:"hdds.datanode.periodic.disk.check.interval.minutes"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Default:"})," ",(0,s.jsx)(n.code,{children:"60"})," (minutes)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Description:"})," The interval at which periodic disk checks are performed. These checks verify:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Directory existence and accessibility"}),"\n",(0,s.jsx)(n.li,{children:"Directory permissions"}),"\n",(0,s.jsx)(n.li,{children:"Disk I/O functionality (read/write tests)"}),"\n",(0,s.jsx)(n.li,{children:"For data volumes with RocksDB: database accessibility"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>hdds.datanode.periodic.disk.check.interval.minutes</name>\n  <value>30</value>\n</property>\n"})}),"\n",(0,s.jsx)(n.p,{children:"This configures disk checks to run every 30 minutes instead of the default 60 minutes."}),"\n",(0,s.jsx)(n.h3,{id:"disk-check-configuration",children:"Disk Check Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Additional properties control disk health check behavior:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Property"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.check.io.test.count"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"3"})}),(0,s.jsxs)(n.td,{children:["Number of IO tests required to determine failure. Set to ",(0,s.jsx)(n.code,{children:"0"})," to disable IO checks."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.check.io.failures.tolerated"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"1"})}),(0,s.jsx)(n.td,{children:"IO test failures allowed before marking volume as failed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.check.io.file.size"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"100B"})}),(0,s.jsx)(n.td,{children:"Size of temporary file used for I/O health checks"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.check.min.gap"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10m"})}),(0,s.jsx)(n.td,{children:"Minimum time gap between successive checks of the same volume"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hdds.datanode.disk.check.timeout"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10m"})}),(0,s.jsx)(n.td,{children:"Maximum time allowed for a disk check to complete"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"failed-volume-handling",children:"Failed Volume Handling"}),"\n",(0,s.jsx)(n.p,{children:"When a volume fails, it is:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Immediately removed from the active volume map and added to the failed volume map"}),"\n",(0,s.jsx)(n.li,{children:"Excluded from container allocation (only healthy volumes are considered by volume choosing policies)"}),"\n",(0,s.jsx)(n.li,{children:"Tracked in metrics (healthy count decremented, failed count incremented)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"If failed volumes exceed the tolerance limit, the Datanode triggers fatal failure handling and may stop offering service."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"replacing-failed-disks",children:"Replacing Failed Disks"}),"\n",(0,s.jsxs)(n.admonition,{type:"note",children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Important Limitation: No Hotswap Support"})}),(0,s.jsx)(n.p,{children:"Ozone Datanodes do not currently support hotswap of disks. To update the disk list (add or remove volumes), you must restart the Datanode process."})]}),"\n",(0,s.jsx)(n.h3,{id:"steps-to-replace-a-failed-disk",children:"Steps to Replace a Failed Disk"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Identify Failed Volumes"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Check Datanode logs for volume failure messages"}),"\n",(0,s.jsx)(n.li,{children:"Monitor Datanode Web UI or metrics to see volume states"}),"\n",(0,s.jsx)(n.li,{children:'Failed volumes will show as "FAILED" in the volume state'}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Shut Down the Datanode"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Stop the Datanode service\nozone --daemon stop datanode\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Update Configuration"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Edit the Datanode configuration file (",(0,s.jsx)(n.code,{children:"ozone-site.xml"})," or equivalent)"]}),"\n",(0,s.jsxs)(n.li,{children:["Remove the failed volume directory from ",(0,s.jsx)(n.code,{children:"hdds.datanode.dir"})]}),"\n",(0,s.jsx)(n.li,{children:"If replacing with a new disk, add the new volume directory"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:["Example - Removing ",(0,s.jsx)(n.code,{children:"/data3"})," and adding ",(0,s.jsx)(n.code,{children:"/data4"}),":"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-xml",children:"\x3c!-- Before --\x3e\n<property>\n  <name>hdds.datanode.dir</name>\n  <value>/data1,/data2,/data3</value>\n</property>\n\n\x3c!-- After --\x3e\n<property>\n  <name>hdds.datanode.dir</name>\n  <value>/data1,/data2,/data4</value>\n</property>\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Restart the Datanode"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Start the Datanode service\nozone --daemon start datanode\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Verify Volume Status"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Check Datanode logs to confirm volumes are initialized correctly"}),"\n",(0,s.jsx)(n.li,{children:"Verify in Web UI that the new volume appears as healthy"}),"\n",(0,s.jsx)(n.li,{children:"Monitor metrics to ensure the failed volume is no longer present"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"physical-disk-replacement",children:"Physical Disk Replacement"}),"\n",(0,s.jsx)(n.p,{children:"When physically replacing a disk:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Verify containers have been replicated (handled automatically by Ozone)"}),"\n",(0,s.jsx)(n.li,{children:"Shut down the Datanode cleanly"}),"\n",(0,s.jsx)(n.li,{children:"Physically replace the disk"}),"\n",(0,s.jsx)(n.li,{children:"Format and mount the new disk to the desired path"}),"\n",(0,s.jsxs)(n.li,{children:["Update ",(0,s.jsx)(n.code,{children:"hdds.datanode.dir"})," configuration"]}),"\n",(0,s.jsx)(n.li,{children:"Restart the Datanode"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"monitoring-volume-health",children:"Monitoring Volume Health"}),"\n",(0,s.jsx)(n.p,{children:"Volume status can be viewed via:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Datanode Web UI:"})," ",(0,s.jsx)(n.code,{children:"http://<datanode-host>:<datanode-http-port>"})," - Shows volume directory, type, capacity, usage, and state (HEALTHY/FAILED)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"JMX Metrics:"})," ",(0,s.jsx)(n.code,{children:"http://<datanode-host>:<datanode-http-port>/jmx?qry=Hadoop:service=HddsDatanode,name=VolumeInfoMetrics*"})," - Exposes per-volume metrics including state"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Configure tolerance settings based on redundancy requirements (allow 1-2 failures for production)"}),"\n",(0,s.jsx)(n.li,{children:"Regularly monitor volume health via Web UI and metrics"}),"\n",(0,s.jsx)(n.li,{children:"Plan maintenance windows for disk replacement (hotswap not supported)"}),"\n",(0,s.jsx)(n.li,{children:"Verify container replication before removing failed disks"}),"\n",(0,s.jsx)(n.li,{children:"Adjust periodic disk check interval based on environment needs"}),"\n",(0,s.jsx)(n.li,{children:"Configure tolerance separately for data, metadata, and database volumes"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},62392:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var a=i(30758);const s={},d=a.createContext(s);function t(e){const n=a.useContext(d);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),a.createElement(d.Provider,{value:n},e.children)}}}]);