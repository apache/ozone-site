"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[35650],{55193:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"administrator-guide/operations/tools/ozone-debug/container-replica-debugger-tool","title":"Container Replica Debugger Tool","description":"The tool processes container log files from Ozone Datanodes to track state transitions. It provides CLI commands for querying containers based on different attributes.","source":"@site/docs/05-administrator-guide/03-operations/11-tools/03-ozone-debug/07-container-replica-debugger-tool.md","sourceDirName":"05-administrator-guide/03-operations/11-tools/03-ozone-debug","slug":"/administrator-guide/operations/tools/ozone-debug/container-replica-debugger-tool","permalink":"/docs/next/administrator-guide/operations/tools/ozone-debug/container-replica-debugger-tool","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/docs/05-administrator-guide/03-operations/11-tools/03-ozone-debug/07-container-replica-debugger-tool.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Audit Parser","permalink":"/docs/next/administrator-guide/operations/tools/ozone-debug/audit-parser-exact"},"next":{"title":"Trash","permalink":"/docs/next/administrator-guide/operations/trash"}}');var a=t(86070),o=t(62392);const s={},r="Container Replica Debugger Tool",l={},d=[{value:"Background",id:"background",level:2},{value:"Solution Approach",id:"solution-approach",level:2},{value:"Component 1: Parser",id:"component-1-parser",level:3},{value:"Log File Parsing and Validation",id:"log-file-parsing-and-validation",level:4},{value:"Component 2: Database",id:"component-2-database",level:3},{value:"There are 2 major tables created/maintained by the tool",id:"there-are-2-major-tables-createdmaintained-by-the-tool",level:4},{value:"<strong>Component 3: CLI Commands</strong>",id:"component-3-cli-commands",level:3},{value:"<strong>To List Containers Having Duplicate Open States</strong>",id:"to-list-containers-having-duplicate-open-states",level:4},{value:"<strong>To Display Details of a Single Container Along with Analysis</strong>",id:"to-display-details-of-a-single-container-along-with-analysis",level:4},{value:"<strong>To List Containers Based on Health State</strong>",id:"to-list-containers-based-on-health-state",level:4},{value:"<strong>To List Containers Based on Final State</strong>",id:"to-list-containers-based-on-final-state",level:4},{value:"NOTE",id:"note",level:2}];function c(e){const n={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"container-replica-debugger-tool",children:"Container Replica Debugger Tool"})}),"\n",(0,a.jsx)(n.p,{children:"The tool processes container log files from Ozone Datanodes to track state transitions. It provides CLI commands for querying containers based on different attributes."}),"\n",(0,a.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,a.jsx)(n.p,{children:"Containers are the most important part of Ozone. Most of the Ozone operations happen on them. Containers in Ozone go through different states in their lifecycle.\nIn the past we have seen different issues on container state. To debug problems we always use manual steps and identify problems w.r.t containers and this takes a lot of time. To optimize debugability we can show historical timeline and other information w.r.t containers."}),"\n",(0,a.jsx)(n.h2,{id:"solution-approach",children:"Solution Approach"}),"\n",(0,a.jsx)(n.p,{children:"An offline tool that would analyse the dn-container log files and help us find issues related to the containers across the Datanodes in the cluster."}),"\n",(0,a.jsx)(n.h3,{id:"component-1-parser",children:"Component 1: Parser"}),"\n",(0,a.jsx)(n.p,{children:"This component is responsible for processing log files, extracting relevant log entries, and storing them in batches to be inserted into the database."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"The command is as follows:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> parse --path=<path to logs folder> --thread-count=<n>\n"})}),"\n",(0,a.jsx)(n.h4,{id:"log-file-parsing-and-validation",children:"Log File Parsing and Validation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Directory Traversal"}),": It recursively scans a specified directory for container log files,only files with names matching the pattern ",(0,a.jsx)(n.code,{children:"dn-container-<roll>.log.<datanodeId>"})," are considered.Log files are parsed concurrently using multiple threads for efficient processing."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Line-by-Line Processing"}),": Each log line is split using a pipe delimiter and parsed into key-value components."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Field Extraction"}),": Key fields include:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.strong,{children:"Timestamp"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"logLevel"}),": INFO, WARN, ERROR."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"ID, BCSID, State, and Index"}),": Extracted from key-value pairs."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Error Message Capture"}),": Any remaining unstructured part of the log line is stored as ",(0,a.jsx)(n.code,{children:"errorMessage"}),", especially relevant for WARN or ERROR level logs."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Replication Index Filtering"}),": Only log entries with Index = 0 are processed. This limits current processing to Ratis-replicated containers. Future improvements may support EC replication."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"component-2-database",children:"Component 2: Database"}),"\n",(0,a.jsx)(n.p,{children:"The tool uses a temporary SQLite database to store and manage information extracted from container logs. This helps organize the data so that both the complete history and the latest status of each container replica on a Datanode can be analyzed easily."}),"\n",(0,a.jsx)(n.h4,{id:"there-are-2-major-tables-createdmaintained-by-the-tool",children:"There are 2 major tables created/maintained by the tool"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"DatanodeContainerLogTable \u2014 Detailed Log History"}),(0,a.jsx)(n.br,{}),"\n","This table stores a complete history of state changes for each container replica on every Datanode."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Container ID"}),"\n",(0,a.jsx)(n.li,{children:"Datanode ID"}),"\n",(0,a.jsx)(n.li,{children:"State (such as OPEN, CLOSED, etc.)"}),"\n",(0,a.jsx)(n.li,{children:"BCSID (Block Commit Sequence ID)"}),"\n",(0,a.jsx)(n.li,{children:"Timestamp"}),"\n",(0,a.jsx)(n.li,{children:"Log Level"}),"\n",(0,a.jsx)(n.li,{children:"Error Message (if any)"}),"\n",(0,a.jsx)(n.li,{children:"Index Value"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"The data in this table shows a complete timeline of state transitions and BCSID changes, helping to trace how each container replica evolved over time."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"ContainerLogTable \u2014 Latest Status Summary"}),(0,a.jsx)(n.br,{}),"\n","This table contains only the most recent state and BCSID for each unique container and Datanode pair."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Container ID"}),"\n",(0,a.jsx)(n.li,{children:"Datanode ID"}),"\n",(0,a.jsx)(n.li,{children:"Latest State"}),"\n",(0,a.jsx)(n.li,{children:"Latest BCSID"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This table provides a simplified view of the current state and BCSID of all container replicas, which helps with quick status checks and summaries."}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"component-3-cli-commands",children:(0,a.jsx)(n.strong,{children:"Component 3: CLI Commands"})}),"\n",(0,a.jsx)(n.h4,{id:"to-list-containers-having-duplicate-open-states",children:(0,a.jsx)(n.strong,{children:"To List Containers Having Duplicate Open States"})}),"\n",(0,a.jsx)(n.p,{children:"This Ozone debug CLI command helps to identify containers that were opened more than the required number (for Ratis, it is 3) by tracking the first three \u201cOPEN\u201d states and flagging any subsequent \u201cOPEN\u201d state as problematic if it occurs on the same Datanode or on a different Datanode after the initial events."}),"\n",(0,a.jsxs)(n.p,{children:["This command displays the ",(0,a.jsx)(n.strong,{children:"Container ID"})," along with the count of replicas in the \u2018OPEN\u2019 state for each listed container. It also provides the total number of containers that have duplicate \u2018OPEN\u2019 state entries."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"The command is as follows:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> duplicate-open\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Sample output:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Container ID: 2187256 - OPEN state count: 4\n.\n.\n.\nContainer ID: 12377064 - OPEN state count: 5\nContainer ID: 12377223 - OPEN state count: 5\nContainer ID: 12377631 - OPEN state count: 4\nContainer ID: 12377904 - OPEN state count: 5\nContainer ID: 12378161 - OPEN state count: 4\nContainer ID: 12378352 - OPEN state count: 5\nContainer ID: 12378789 - OPEN state count: 5\nContainer ID: 12379337 - OPEN state count: 5\nContainer ID: 12379489 - OPEN state count: 5\nContainer ID: 12380526 - OPEN state count: 5\nContainer ID: 12380898 - OPEN state count: 5\nContainer ID: 12642718 - OPEN state count: 4\nContainer ID: 12644806 - OPEN state count: 4\nTotal containers that might have duplicate OPEN state : 1579\n"})}),"\n",(0,a.jsx)(n.h4,{id:"to-display-details-of-a-single-container-along-with-analysis",children:(0,a.jsx)(n.strong,{children:"To Display Details of a Single Container Along with Analysis"})}),"\n",(0,a.jsx)(n.p,{children:"This Ozone debug CLI command provides a complete state transition history for each replica of the container whose ID is provided via the command.\nThe command also provides analysis over the container such as if the container has issues like:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Duplicate OPEN states"}),"\n",(0,a.jsx)(n.li,{children:"Mismatched replication"}),"\n",(0,a.jsx)(n.li,{children:"Under-replication or over-replication"}),"\n",(0,a.jsx)(n.li,{children:"Unhealthy replicas"}),"\n",(0,a.jsx)(n.li,{children:"Open-unhealthy"}),"\n",(0,a.jsx)(n.li,{children:"Quasi-closed stuck containers"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"The command provides key details such as:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Datanode id"}),"\n",(0,a.jsx)(n.li,{children:"Container id"}),"\n",(0,a.jsx)(n.li,{children:"BCSID"}),"\n",(0,a.jsx)(n.li,{children:"TimeStamp"}),"\n",(0,a.jsx)(n.li,{children:"Index Value"}),"\n",(0,a.jsx)(n.li,{children:"Message (if any associated with that particular replica)"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"The command is as follows:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to database> info <containerID>\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Sample output:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Timestamp               | Container ID | Datanode ID | Container State  | BCSID   | Message             | Index Value\n----------------------------------------------------------------------------------------------------------------------\n2024-06-04 15:07:55,390 | 700          | 100         | QUASI_CLOSED     | 353807 | No error             | 0\n2024-06-04 14:50:18,177 | 700          | 150         | QUASI_CLOSED     | 353807 | No error             | 0\n2024-04-04 10:32:29,026 | 700          | 250         | OPEN             | 0      | No error             | 0\n2024-06-04 14:44:28,126 | 700          | 250         | CLOSING          | 353807 | No error             | 0\n2024-06-04 14:47:59,893 | 700          | 250         | QUASI_CLOSED     | 353807 | Ratis group removed  | 0\n2024-06-04 14:50:17,038 | 700          | 250         | QUASI_CLOSED     | 353807 | No error             | 0\n2024-06-04 14:50:18,184 | 700          | 250         | QUASI_CLOSED     | 353807 | No error             | 0\n2024-04-04 10:32:29,026 | 700          | 400         | OPEN             | 0      | No error             | 0\nContainer 700 might be QUASI_CLOSED_STUCK.\n"})}),"\n",(0,a.jsx)(n.h4,{id:"to-list-containers-based-on-health-state",children:(0,a.jsx)(n.strong,{children:"To List Containers Based on Health State"})}),"\n",(0,a.jsx)(n.p,{children:"This Ozone debug CLI command lists all the containers which are either UNDER-REPLICATED, OVER-REPLICATED, UNHEALTHY, or QUASI_CLOSED stuck."}),"\n",(0,a.jsxs)(n.p,{children:["This command displays the ",(0,a.jsx)(n.strong,{children:"Container ID"})," along with the count of replicas in the specified health state for each listed container."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"The command options used are:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List containers by health type: this by default provides only 100 rows in the result"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --health=<type>\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List containers by health type with a specified row limit:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --health=<type>  --length=<limit>\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List all containers by health type, overriding the row limit:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --health=<type>  --all\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Sample output:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=path/to/db list --health=UNHEALTHY --all\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Container ID = 6002 - Count = 1\nContainer ID = 6201 - Count = 1\n.\n.\n.\nContainer ID = 136662 - Count = 3\nContainer ID = 136837 - Count = 3\nContainer ID = 199954 - Count = 3\nContainer ID = 237747 - Count = 3\nContainer ID = 2579099 - Count = 1\nContainer ID = 2626888 - Count = 1\nContainer ID = 2627711 - Count = 1\nContainer ID = 2627751 - Count = 2\nNumber of containers listed: 25085\n"})}),"\n",(0,a.jsx)(n.h4,{id:"to-list-containers-based-on-final-state",children:(0,a.jsx)(n.strong,{children:"To List Containers Based on Final State"})}),"\n",(0,a.jsx)(n.p,{children:"This Ozone debug CLI command helps to list replicas of all the containers which have the state provided via the CLI command as their latest state."}),"\n",(0,a.jsx)(n.p,{children:"The command provides key details such as:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Datanode id"}),"\n",(0,a.jsx)(n.li,{children:"Container id"}),"\n",(0,a.jsx)(n.li,{children:"BCSID"}),"\n",(0,a.jsx)(n.li,{children:"TimeStamp - The most recent timestamp associated with the container replica state"}),"\n",(0,a.jsx)(n.li,{children:"Index Value"}),"\n",(0,a.jsx)(n.li,{children:"Message (if any associated with that particular replica)"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"The command options used are:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List containers by state: this by default provides only 100 rows in the result"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --lifecycle=<state>\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List containers by state with a specified row limit:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --lifecycle=<state> --length=<limit>\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"List all containers by state, overriding the row limit:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=<path to db> list --lifecycle=<state> --all\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Sample output:"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"ozone debug log container --db=path/to/db list --lifecycle=CLOSED --all\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Timestamp                 | Datanode ID | Container ID | BCSID  | Message        | Index Value\n---------------------------------------------------------------------------------------------------\n2024-07-23 12:02:12,981   | 360         | 1            | 75654  | No error       | 0\n2024-07-23 11:56:21,106   | 365         | 1            | 75654  | Volume failure | 0\n2024-07-23 11:56:21,106   | 365         | 1            | 75654  | Volume failure | 0\n2024-08-29 14:11:32,879   | 415         | 1            | 30     | No error       | 0\n2024-08-29 14:11:17,533   | 430         | 1            | 30     | No error       | 0\n2024-06-20 11:50:09,496   | 460         | 1            | 75654  | No error       | 0\n2024-07-23 12:02:11,633   | 500         | 1            | 75654  | No error       | 0\n2024-06-20 12:03:24,230   | 505         | 2            | 83751  | No error       | 0\n2024-07-10 04:00:33,131   | 540         | 2            | 83751  | No error       | 0\n2024-07-10 04:00:46,825   | 595         | 2            | 83751  | No error       | 0\n"})}),"\n",(0,a.jsx)(n.h2,{id:"note",children:"NOTE"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"This tool assumes that all dn-container log files are already extracted from the Datanodes and placed into a directory."}),"\n",(0,a.jsxs)(n.li,{children:["For the parsing command, if the DB path is not provided, a new database will be created in the current working directory with the default filename ",(0,a.jsx)(n.code,{children:"container_datanode.db"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["For all other commands, if the DB path is not provided, it will look for a default database (",(0,a.jsx)(n.code,{children:"container_datanode.db"}),") file in the current directory. If it doesn\u2019t exist, it will throw an error asking to provide a valid path."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},62392:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>r});var i=t(30758);const a={},o=i.createContext(a);function s(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);