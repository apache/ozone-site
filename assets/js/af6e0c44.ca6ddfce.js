"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[7958],{10674:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"system-internals/security/kerberos","title":"How Ozone Uses Kerberos","description":"1. Kerberos","source":"@site/docs/07-system-internals/05-security/01-kerberos.md","sourceDirName":"07-system-internals/05-security","slug":"/system-internals/security/kerberos","permalink":"/docs/system-internals/security/kerberos","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/07-system-internals/05-security/01-kerberos.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"Kerberos"},"sidebar":"defaultSidebar","previous":{"title":"Security","permalink":"/docs/system-internals/security/"},"next":{"title":"Symmetric Encryption","permalink":"/docs/system-internals/security/symmetric-encryption"}}');var t=r(86070),i=r(62392);const o={sidebar_label:"Kerberos"},a="How Ozone Uses Kerberos",d={},c=[{value:"1. Kerberos",id:"1-kerberos",level:2},{value:"2. Kerberos and SPNEGO in Apache Ozone",id:"2-kerberos-and-spnego-in-apache-ozone",level:2},{value:"Kerberos Authentication",id:"kerberos-authentication",level:3},{value:"SPNEGO for HTTP Access",id:"spnego-for-http-access",level:3},{value:"3. Securing Datanodes",id:"3-securing-datanodes",level:2},{value:"How a Datanode becomes secure",id:"how-a-datanode-becomes-secure",level:3},{value:"Certificate Approval via Kerberos",id:"certificate-approval-via-kerberos",level:4},{value:"Manual Approval",id:"manual-approval",level:4},{value:"Automatic Approval",id:"automatic-approval",level:4},{value:"4. Kerberos Configurations for SCM, OM, and S3G",id:"4-kerberos-configurations-for-scm-om-and-s3g",level:2},{value:"Storage Container Manager",id:"storage-container-manager",level:3},{value:"Ozone Manager",id:"ozone-manager",level:3},{value:"S3 Gateway",id:"s3-gateway",level:3}];function l(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"how-ozone-uses-kerberos",children:"How Ozone Uses Kerberos"})}),"\n",(0,t.jsx)(s.h2,{id:"1-kerberos",children:"1. Kerberos"}),"\n",(0,t.jsxs)(s.p,{children:["Ozone depends on ",(0,t.jsx)(s.a,{href:"https://web.mit.edu/kerberos/",children:"Kerberos"})," to make the\nclusters secure. Historically, HDFS has supported running in an isolated\nsecure networks where it is possible to deploy without securing the cluster."]}),"\n",(0,t.jsxs)(s.p,{children:["This release of Ozone follows that model, but soon will move to ",(0,t.jsx)(s.em,{children:"secure by\ndefault."}),"  Today to enable security in Ozone cluster, we need to set the\nconfiguration ",(0,t.jsx)(s.code,{children:"ozone.security.enabled"})," to ",(0,t.jsx)(s.code,{children:"true"})," and ",(0,t.jsx)(s.code,{children:"hadoop.security.authentication"}),"\nto ",(0,t.jsx)(s.code,{children:"kerberos"}),"."]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Property"}),(0,t.jsx)(s.th,{children:"Value"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.security.enabled"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"true"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hadoop.security.authentication"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"kerberos"})})]})]})]}),"\n",(0,t.jsx)(s.h2,{id:"2-kerberos-and-spnego-in-apache-ozone",children:"2. Kerberos and SPNEGO in Apache Ozone"}),"\n",(0,t.jsx)(s.p,{children:"Apache Ozone uses Kerberos for strong authentication across its services and clients. This ensures that only authenticated users and services can access Ozone resources."}),"\n",(0,t.jsx)(s.h3,{id:"kerberos-authentication",children:"Kerberos Authentication"}),"\n",(0,t.jsxs)(s.p,{children:["Ozone relies on the ",(0,t.jsx)(s.strong,{children:"Java SASL (Simple Authentication and Security Layer)"})," framework using the ",(0,t.jsx)(s.strong,{children:"GSS-API"})," mechanism for Kerberos authentication."]}),"\n",(0,t.jsx)(s.p,{children:"At startup, each Ozone service role (such as OM, SCM, or Datanode):"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Uses its ",(0,t.jsx)(s.strong,{children:"service principal"})," and ",(0,t.jsx)(s.strong,{children:"keytab"})," to authenticate with the Kerberos Key Distribution Center (KDC)."]}),"\n",(0,t.jsxs)(s.li,{children:["Uses the local Kerberos client configuration in ",(0,t.jsx)(s.code,{children:"/etc/krb5.conf"}),"."]}),"\n",(0,t.jsxs)(s.li,{children:["Assumes that all hosts in the same Ozone cluster typically belong to the same ",(0,t.jsx)(s.strong,{children:"Kerberos realm"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Ozone also supports ",(0,t.jsx)(s.strong,{children:"cross-realm authentication"}),". Applications and services in different Kerberos realms can communicate securely if cross-realm trust is properly configured between the realms."]}),"\n",(0,t.jsx)(s.h3,{id:"spnego-for-http-access",children:"SPNEGO for HTTP Access"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"SPNEGO (Simple and Protected GSS-API Negotiation Mechanism)"})," is the Kerberos-based authentication mechanism used for HTTP access to Ozone services, such as the Ozone Manager (OM) web endpoints."]}),"\n",(0,t.jsx)(s.p,{children:"SPNEGO is widely supported by modern tools and clients, including:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Web browsers (Chrome, Firefox, Safari)"}),"\n",(0,t.jsx)(s.li,{children:"Command-line tools such as curl"}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Example using ",(0,t.jsx)(s.code,{children:"curl"})," with ",(0,t.jsx)(s.strong,{children:"SPNEGO"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"curl --negotiate -u : http://om-host.example.com:9874/\n"})}),"\n",(0,t.jsx)(s.p,{children:"In this mode, the client automatically uses the user's Kerberos credentials to authenticate to the Ozone HTTP service without requiring usernames or passwords."}),"\n",(0,t.jsx)(s.h2,{id:"3-securing-datanodes",children:"3. Securing Datanodes"}),"\n",(0,t.jsx)(s.p,{children:"Datanodes under Hadoop is traditionally secured by creating a Keytab file on the Datanodes. With Ozone, we have moved away to using Datanode certificates. That is, Kerberos on Datanodes is not needed in case of a secure Ozone cluster."}),"\n",(0,t.jsxs)(s.p,{children:["However, we support the legacy Kerberos based Authentication to make it easy for the current set of users. The HDFS configuration keys are the following that is setup in ",(0,t.jsx)(s.code,{children:"hdfs-site.xml"}),"."]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Property"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"dfs.datanode.kerberos.principal"})}),(0,t.jsxs)(s.td,{children:["The Datanode service principal. e.g. ",(0,t.jsx)(s.code,{children:"dn/_HOST@REALM.COM"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"dfs.datanode.kerberos.keytab.file"})}),(0,t.jsx)(s.td,{children:"The keytab file used by Datanode daemon to login as its service principal."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.datanode.http.auth.kerberos.principal"})}),(0,t.jsx)(s.td,{children:"Datanode HTTP server service principal."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.datanode.http.auth.kerberos.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by Datanode HTTP server to login as its service principal."})]})]})]}),"\n",(0,t.jsx)(s.h3,{id:"how-a-datanode-becomes-secure",children:"How a Datanode becomes secure"}),"\n",(0,t.jsx)(s.p,{children:"Under Ozone, when a Datanode boots up and discovers SCM's address, the first thing that Datanode does is to create a private key and send a certificate request to the SCM."}),"\n",(0,t.jsx)(s.h4,{id:"certificate-approval-via-kerberos",children:"Certificate Approval via Kerberos"}),"\n",(0,t.jsx)(s.p,{children:"SCM has a built-in CA, and SCM has to approve this request. If the Datanode already has a Kerberos key tab, then SCM will trust Kerberos credentials and issue a certificate automatically."}),"\n",(0,t.jsx)(s.h4,{id:"manual-approval",children:"Manual Approval"}),"\n",(0,t.jsx)(s.p,{children:"If these are brand new Datanodes and Kerberos key tabs are not present at the Datanodes, then this request for the Datanodes identity certificate is queued up for approval from the administrator (This is work in progress, not committed in Ozone yet). In other words, the chain of trust is established by the administrator of the cluster."}),"\n",(0,t.jsx)(s.h4,{id:"automatic-approval",children:"Automatic Approval"}),"\n",(0,t.jsx)(s.p,{children:"If you are running under a container orchestrator like Kubernetes, we rely on Kubernetes to create a one-time token that will be given to Datanode during boot time to prove the identity of the Datanode container (This is also work in progress.)"}),"\n",(0,t.jsx)(s.p,{children:"Once a certificate is issued, a Datanode is secure and Ozone Manager can issue block tokens. If there is no Datanode certificates or the SCM's root certificate is not present in the Datanode, then Datanode will register itself and download the SCM's root certificate as well get the certificates for itself."}),"\n",(0,t.jsx)(s.h2,{id:"4-kerberos-configurations-for-scm-om-and-s3g",children:"4. Kerberos Configurations for SCM, OM, and S3G"}),"\n",(0,t.jsx)(s.h3,{id:"storage-container-manager",children:"Storage Container Manager"}),"\n",(0,t.jsxs)(s.p,{children:["SCM requires ",(0,t.jsx)(s.strong,{children:"two Kerberos principals"}),", and the corresponding key tab files for both of these principals."]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Property"}),(0,t.jsx)(s.th,{children:"Default Value"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.scm.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"SCM/_HOST@REALM"})}),(0,t.jsxs)(s.td,{children:["The SCM service principal. e.g. ",(0,t.jsx)(s.code,{children:"scm/_HOST@REALM.COM"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.scm.kerberos.keytab.file"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/SCM.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by SCM daemon to login as its service principal."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.scm.http.auth.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"HTTP/_HOST@REALM"})}),(0,t.jsx)(s.td,{children:"SCM HTTP server service principal if SPNEGO is enabled for SCM HTTP server."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"hdds.scm.http.auth.kerberos.keytab"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/HTTP.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by SCM HTTP server to login as its service principal if SPNEGO is enabled for SCM HTTP server."})]})]})]}),"\n",(0,t.jsx)(s.h3,{id:"ozone-manager",children:"Ozone Manager"}),"\n",(0,t.jsxs)(s.p,{children:["Like SCM, OM also requires ",(0,t.jsx)(s.strong,{children:"two Kerberos principals"}),", and the corresponding key tab files for both of these principals."]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Property"}),(0,t.jsx)(s.th,{children:"Default Value"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.om.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"OM/_HOST@REALM"})}),(0,t.jsxs)(s.td,{children:["The OzoneManager service principal. e.g. ",(0,t.jsx)(s.code,{children:"om/_HOST@REALM.COM"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.om.kerberos.keytab.file"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/OM.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by OM daemon to login as its service principal."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.om.http.auth.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"HTTP/_HOST@REALM"})}),(0,t.jsx)(s.td,{children:"Ozone Manager HTTP server service principal if SPNEGO is enabled for OM HTTP server."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.om.http.auth.kerberos.keytab"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/HTTP.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by OM HTTP server to login as its service principal if SPNEGO is enabled for OM HTTP server."})]})]})]}),"\n",(0,t.jsx)(s.h3,{id:"s3-gateway",children:"S3 Gateway"}),"\n",(0,t.jsxs)(s.p,{children:["S3 Gateway requires at least one Kerberos principal for the gateway service (",(0,t.jsx)(s.code,{children:"ozone.s3g.kerberos.principal"})," and ",(0,t.jsx)(s.code,{children:"ozone.s3g.kerberos.keytab.file"}),"). If SPNEGO is enabled for the S3 Gateway HTTP server, configure a second principal and keytab via ",(0,t.jsx)(s.code,{children:"ozone.s3g.http.auth.kerberos.principal"})," and ",(0,t.jsx)(s.code,{children:"ozone.s3g.http.auth.kerberos.keytab"}),". All of these are set in ",(0,t.jsx)(s.code,{children:"ozone-site.xml"}),"."]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Property"}),(0,t.jsx)(s.th,{children:"Default Value"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.s3g.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"s3g/_HOST@REALM"})}),(0,t.jsxs)(s.td,{children:["S3 Gateway principal. e.g. ",(0,t.jsx)(s.code,{children:"s3g/_HOST@REALM"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.s3g.kerberos.keytab.file"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/s3g.keytab"})}),(0,t.jsxs)(s.td,{children:["The keytab file used by S3 Gateway. e.g. ",(0,t.jsx)(s.code,{children:"/etc/security/keytabs/s3g.keytab"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.s3g.http.auth.kerberos.principal"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"HTTP/_HOST@REALM"})}),(0,t.jsxs)(s.td,{children:["S3 Gateway principal if SPNEGO is enabled for S3 Gateway HTTP server. e.g. ",(0,t.jsx)(s.code,{children:"HTTP/_HOST@EXAMPLE.COM"})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"ozone.s3g.http.auth.kerberos.keytab"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"/etc/security/keytabs/HTTP.keytab"})}),(0,t.jsx)(s.td,{children:"The keytab file used by S3 Gateway if SPNEGO is enabled for S3 Gateway HTTP server."})]})]})]}),"\n",(0,t.jsx)(s.admonition,{type:"note",children:(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"_HOST"})," is replaced with the actual hostname at runtime, and ",(0,t.jsx)(s.code,{children:"REALM"})," should be replaced with your Kerberos realm (e.g., ",(0,t.jsx)(s.code,{children:"EXAMPLE.COM"}),")."]})})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},62392:(e,s,r)=>{r.d(s,{R:()=>o,x:()=>a});var n=r(30758);const t={},i=n.createContext(t);function o(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);