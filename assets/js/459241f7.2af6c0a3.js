"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[1299],{58904:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"administrator-guide/operations/tools/ozone-repair","title":"Ozone Repair","description":"Ozone Repair (ozone repair) is an advanced tool to repair Ozone. The nodes being repaired must be stopped before the tool is run.","source":"@site/docs/05-administrator-guide/03-operations/11-tools/01-ozone-repair.md","sourceDirName":"05-administrator-guide/03-operations/11-tools","slug":"/administrator-guide/operations/tools/ozone-repair","permalink":"/docs/administrator-guide/operations/tools/ozone-repair","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/05-administrator-guide/03-operations/11-tools/01-ozone-repair.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Tools","permalink":"/docs/administrator-guide/operations/tools/"},"next":{"title":"Ozone Admin","permalink":"/docs/administrator-guide/operations/tools/ozone-admin"}}');var t=o(86070),i=o(62392);const r={},s="Ozone Repair",d={},l=[{value:"ozone repair Datanode",id:"ozone-repair-datanode",level:2},{value:"upgrade-container-schema",id:"upgrade-container-schema",level:3},{value:"ozone repair ldb",id:"ozone-repair-ldb",level:2},{value:"compact",id:"compact",level:3},{value:"ozone repair OM",id:"ozone-repair-om",level:2},{value:"Subcommands under OM",id:"subcommands-under-om",level:3},{value:"FSO-tree",id:"fso-tree",level:3},{value:"snapshot",id:"snapshot",level:3},{value:"chain",id:"chain",level:4},{value:"update-transaction",id:"update-transaction",level:3},{value:"quota",id:"quota",level:3},{value:"start",id:"start",level:4},{value:"status",id:"status",level:4},{value:"compact",id:"compact-1",level:4},{value:"skip-ratis-transaction, srt",id:"skip-ratis-transaction-srt",level:4},{value:"ozone repair SCM",id:"ozone-repair-scm",level:2},{value:"Subcommands under SCM",id:"subcommands-under-scm",level:3},{value:"cert",id:"cert",level:3},{value:"recover",id:"recover",level:4},{value:"update-transaction",id:"update-transaction-1",level:3}];function c(e){const n={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"ozone-repair",children:"Ozone Repair"})}),"\n",(0,t.jsxs)(n.p,{children:["Ozone Repair (",(0,t.jsx)(n.code,{children:"ozone repair"}),") is an advanced tool to repair Ozone. The nodes being repaired must be stopped before the tool is run."]}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsxs)(n.p,{children:["All repair commands support a ",(0,t.jsx)(n.code,{children:"--dry-run"})," option which allows a user to see what repair the command will be performing without actually making any changes to the cluster."]}),(0,t.jsxs)(n.p,{children:["Use the ",(0,t.jsx)(n.code,{children:"--force"})," flag to override the running service check in false-positive cases."]})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair [-hV] [--verbose] [-conf=<configurationPath>]\n                    [-D=<String=String>]... [COMMAND]\nAdvanced tool to repair Ozone. The nodes being repaired must be stopped before\nthe tool is run.\n      -conf=<configurationPath>\n\n  -D, --set=<String=String>\n\n  -h, --help      Show this help message and exit.\n  -V, --version   Print version information and exit.\n      --verbose   More verbose output. Show the stack trace of the errors.\nCommands:\n  datanode  Tools to repair Datanode\n  ldb       Operational tool to repair ldb.\n  om        Operational tool to repair OM.\n  scm       Operational tool to repair SCM.\n"})}),"\n",(0,t.jsx)(n.p,{children:"For more detailed usage see the output of --help for each of the subcommands."}),"\n",(0,t.jsx)(n.h2,{id:"ozone-repair-datanode",children:"ozone repair Datanode"}),"\n",(0,t.jsx)(n.p,{children:"Operational tool to repair Datanode."}),"\n",(0,t.jsx)(n.h3,{id:"upgrade-container-schema",children:"upgrade-container-schema"}),"\n",(0,t.jsxs)(n.p,{children:["Upgrade all schema V2 containers to schema V3 for a Datanode in offline mode.\nOptionally takes ",(0,t.jsx)(n.code,{children:"--volume"})," option to specify which volume needs the upgrade."]}),"\n",(0,t.jsx)(n.h2,{id:"ozone-repair-ldb",children:"ozone repair ldb"}),"\n",(0,t.jsx)(n.p,{children:"Operational tool to repair ldb."}),"\n",(0,t.jsx)(n.h3,{id:"compact",children:"compact"}),"\n",(0,t.jsx)(n.p,{children:"Compact a column family in the DB to clean up tombstones while the service is offline."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair ldb compact [-hV] [--dry-run] [--force] [--verbose]\n                                --cf=<columnFamilyName> --db=<dbPath>\nCLI to compact a column-family in the DB while the service is offline.\nNote: If om.db is compacted with this tool then it will negatively impact the\nOzone Manager's efficient snapshot diff.\n      --cf, --column-family, --column_family=<columnFamilyName>\n                      Column family name\n      --db=<dbPath>   Database File Path\n"})}),"\n",(0,t.jsx)(n.h2,{id:"ozone-repair-om",children:"ozone repair OM"}),"\n",(0,t.jsx)(n.p,{children:"Operational tool to repair OM."}),"\n",(0,t.jsx)(n.h3,{id:"subcommands-under-om",children:"Subcommands under OM"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"FSO-tree"}),"\n",(0,t.jsx)(n.li,{children:"snapshot"}),"\n",(0,t.jsx)(n.li,{children:"update-transaction"}),"\n",(0,t.jsx)(n.li,{children:"quota"}),"\n",(0,t.jsx)(n.li,{children:"compact"}),"\n",(0,t.jsx)(n.li,{children:"skip-ratis-transaction"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"fso-tree",children:"FSO-tree"}),"\n",(0,t.jsx)(n.p,{children:"Identify and repair a disconnected FSO tree by marking unreferenced entries for deletion.\nReports the reachable, unreachable (pending delete) and unreferenced (orphaned) directories and files.\nOM should be stopped while this tool is run."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om fso-tree [-hV] [--dry-run] [--force] [--verbose]\n                                [-b=<bucketFilter>] --db=<omDBPath>\n                                [-v=<volumeFilter>]\nIdentify and repair a disconnected FSO tree by marking unreferenced entries for\ndeletion. OM should be stopped while this tool is run.\n  -b, --bucket=<bucketFilter>\n                        Filter by bucket name\n      --db=<omDBPath>   Path to OM RocksDB\n  -v, --volume=<volumeFilter>\n                        Filter by volume name. Add '/' before the volume name.\n\n"})}),"\n",(0,t.jsx)(n.h3,{id:"snapshot",children:"snapshot"}),"\n",(0,t.jsx)(n.p,{children:"Subcommand for all snapshot related repairs."}),"\n",(0,t.jsx)(n.h4,{id:"chain",children:"chain"}),"\n",(0,t.jsx)(n.p,{children:"Update global and path previous snapshot for a snapshot in case snapshot chain is corrupted."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om snapshot chain [-hV] [--dry-run] [--force] [--verbose]\n                                      --db=<dbPath>\n                                      --gp=<globalPreviousSnapshotId>\n                                      --pp=<pathPreviousSnapshotId> <value>\n                                      <snapshotName>\nCLI to update global and path previous snapshot for a snapshot in case snapshot\nchain is corrupted.\n      <value>          URI of the bucket (format: volume/bucket).\n      <snapshotName>   Snapshot name to update\n      --db=<dbPath>    Database File Path\n      --gp, --global-previous=<globalPreviousSnapshotId>\n                       Global previous snapshotId to set for the given snapshot\n      --pp, --path-previous=<pathPreviousSnapshotId>\n                       Path previous snapshotId to set for the given snapshot\n"})}),"\n",(0,t.jsx)(n.h3,{id:"update-transaction",children:"update-transaction"}),"\n",(0,t.jsxs)(n.p,{children:["To avoid modifying Ratis logs and only update the latest applied transaction, use ",(0,t.jsx)(n.code,{children:"update-transaction"})," command.",(0,t.jsx)(n.br,{}),"\n","This updates the highest transaction index in the OM transaction info table."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om update-transaction [-hV] [--dry-run] [--force]\n       [--verbose] --db=<dbPath> --index=<highestTransactionIndex>\n       --term=<highestTransactionTerm>\nCLI to update the highest index in transaction info table.\n      --db=<dbPath>   Database File Path\n      --index=<highestTransactionIndex>\n                      Highest index to set. The input should be non-zero long\n                        integer.\n      --term=<highestTransactionTerm>\n                      Highest term to set. The input should be non-zero long\n                        integer.\n\n"})}),"\n",(0,t.jsx)(n.h3,{id:"quota",children:"quota"}),"\n",(0,t.jsx)(n.p,{children:"Operational tool to repair quota in OM DB."}),"\n",(0,t.jsx)(n.h4,{id:"start",children:"start"}),"\n",(0,t.jsxs)(n.p,{children:["To trigger quota repair use the ",(0,t.jsx)(n.code,{children:"start"})," command."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om quota start [-hV] [--dry-run] [--force] [--verbose]\n                                   [--buckets=<buckets>]\n                                   [--service-host=<omHost>]\n                                   [--service-id=<omServiceId>]\nCLI to trigger quota repair.\n      --buckets=<buckets>   start quota repair for specific buckets. Input will\n                              be list of uri separated by comma as\n                              /<volume>/<bucket>[,...]\n      --service-host=<omHost>\n                            Ozone Manager Host. If OM HA is enabled, use\n                              --service-id instead. If you must use\n                              --service-host with OM HA, this must point\n                              directly to the leader OM. This option is\n                              required when --service-id is not provided or\n                              when HA is not enabled.\n      --service-id, --om-service-id=<omServiceId>\n                            Ozone Manager Service ID\n\n"})}),"\n",(0,t.jsx)(n.h4,{id:"status",children:"status"}),"\n",(0,t.jsx)(n.p,{children:"Get the status of last triggered quota repair."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om quota status [-hV] [--verbose]\n                                    [--service-host=<omHost>]\n                                    [--service-id=<omServiceId>]\nCLI to get the status of last trigger quota repair if available.\n      --service-host=<omHost>\n                  Ozone Manager Host. If OM HA is enabled, use --service-id\n                    instead. If you must use --service-host with OM HA, this\n                    must point directly to the leader OM. This option is\n                    required when --service-id is not provided or when HA is\n                    not enabled.\n      --service-id, --om-service-id=<omServiceId>\n                  Ozone Manager Service ID\n\n"})}),"\n",(0,t.jsx)(n.h4,{id:"compact-1",children:"compact"}),"\n",(0,t.jsx)(n.p,{children:"Compact a column family in the OM DB to clean up tombstones. The compaction happens asynchronously. Requires admin privileges."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om compact [-hV] [--dry-run] [--force] [--verbose]\n                               --cf=<columnFamilyName> [--node-id=<nodeId>]\n                               [--service-id=<omServiceId>]\nCLI to compact a column family in the om.db. The compaction happens\nasynchronously. Requires admin privileges.\n      --cf, --column-family, --column_family=<columnFamilyName>\n                           Column family name\n      --node-id=<nodeId>   NodeID of the OM for which db needs to be compacted.\n      --service-id, --om-service-id=<omServiceId>\n                           Ozone Manager Service ID\n\n"})}),"\n",(0,t.jsx)(n.h4,{id:"skip-ratis-transaction-srt",children:"skip-ratis-transaction, srt"}),"\n",(0,t.jsx)(n.p,{children:"Omit a raft log in a Ratis segment file by replacing the specified index with a dummy EchoOM command.\nThis is an offline tool meant to be used only when all 3 OMs crash on the same transaction.\nIf the issue is isolated to one OM, manually copy the DB from a healthy OM instead."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair om skip-ratis-transaction [-hV] [--dry-run] [--force]\n       [--verbose] -b=<backupDir> --index=<index> (-s=<segmentFile> |\n       -d=<logDir>)\nCLI to omit a raft log in a ratis segment file. The raft log at the index\nspecified is replaced with an EchoOM command (which is a dummy command). It is\nan offline command i.e., doesn't require OM to be running. The command should\nbe run for the same transaction on all 3 OMs only when all the OMs are crashing\nwhile applying the same transaction. If only one OM is crashing and the other\nOMs have executed the log successfully, then the DB should be manually copied\nfrom one of the good OMs to the crashing OM instead.\n  -b, --backup=<backupDir>   Directory to put the backup of the original\n                               repaired segment file before the repair.\n  -d, --ratis-log-dir=<logDir>\n                             Path of the ratis log directory\n      --index=<index>        Index of the failing transaction that should be\n                               removed\n  -s, --segment-path=<segmentFile>\n                             Path of the input segment file\n"})}),"\n",(0,t.jsx)(n.h2,{id:"ozone-repair-scm",children:"ozone repair SCM"}),"\n",(0,t.jsx)(n.p,{children:"Operational tool to repair SCM."}),"\n",(0,t.jsx)(n.h3,{id:"subcommands-under-scm",children:"Subcommands under SCM"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"cert"}),"\n",(0,t.jsx)(n.li,{children:"update-transaction"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"cert",children:"cert"}),"\n",(0,t.jsx)(n.p,{children:"Subcommand for all certificate related repairs on SCM."}),"\n",(0,t.jsx)(n.h4,{id:"recover",children:"recover"}),"\n",(0,t.jsx)(n.p,{children:"Recover Deleted SCM Certificate from RocksDB."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair scm cert recover [-hV] [--dry-run] [--force] [--verbose]\n                                     --db=<dbPath>\nRecover Deleted SCM Certificate from RocksDB\n      --db=<dbPath>   SCM DB Path\n"})}),"\n",(0,t.jsx)(n.h3,{id:"update-transaction-1",children:"update-transaction"}),"\n",(0,t.jsx)(n.p,{children:"To avoid modifying Ratis logs and only update the latest applied transaction, use update-transaction command.\nThis updates the highest transaction index in the SCM transaction info table."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"Usage: ozone repair scm update-transaction [-hV] [--dry-run] [--force]\n       [--verbose] --db=<dbPath> --index=<highestTransactionIndex>\n       --term=<highestTransactionTerm>\nCLI to update the highest index in transaction info table.\n      --db=<dbPath>   Database File Path\n      --index=<highestTransactionIndex>\n                      Highest index to set. The input should be non-zero long\n                        integer.\n      --term=<highestTransactionTerm>\n                      Highest term to set. The input should be non-zero long\n                        integer.\n\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},62392:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>s});var a=o(30758);const t={},i=a.createContext(t);function r(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);