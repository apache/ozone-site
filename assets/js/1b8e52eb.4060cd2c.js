"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[6111],{12616:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"system-internals/components/storage-container-manager/disk-layout","title":"Storage Container Manager Disk Layout","description":"Overview","source":"@site/docs/07-system-internals/01-components/02-storage-container-manager/01-disk-layout.md","sourceDirName":"07-system-internals/01-components/02-storage-container-manager","slug":"/system-internals/components/storage-container-manager/disk-layout","permalink":"/docs/system-internals/components/storage-container-manager/disk-layout","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/master/docs/07-system-internals/01-components/02-storage-container-manager/01-disk-layout.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"Disk Layout"},"sidebar":"defaultSidebar","previous":{"title":"Storage Container Manager","permalink":"/docs/system-internals/components/storage-container-manager/"},"next":{"title":"RocksDB Schema","permalink":"/docs/system-internals/components/storage-container-manager/rocksdb-schema"}}');var i=n(86070),r=n(62392);const o={sidebar_label:"Disk Layout"},a="Storage Container Manager Disk Layout",c={},d=[{value:"<strong>Overview</strong>",id:"overview",level:2},{value:"<strong>Core Metadata Configurations</strong>",id:"core-metadata-configurations",level:2},{value:"<strong>On-Disk Directory Structure</strong>",id:"on-disk-directory-structure",level:2},{value:"<strong>Detailed Component Breakdown</strong>",id:"detailed-component-breakdown",level:2},{value:"<strong>1. RocksDB (<code>scm.db</code>)</strong>",id:"1-rocksdb-scmdb",level:3},{value:"<strong>2. The VERSION File</strong>",id:"2-the-version-file",level:3},{value:"<strong>3. Certificate Authority (CA)</strong>",id:"3-certificate-authority-ca",level:3},{value:"<strong>4. Ratis Logs</strong>",id:"4-ratis-logs",level:3},{value:"<strong>5. <code>db.checkpoints</code></strong>",id:"5-dbcheckpoints",level:3},{value:"Recommended Storage Configuration Mapping",id:"recommended-storage-configuration-mapping",level:3},{value:"<strong>Layout Implementation for Different Environments</strong>",id:"layout-implementation-for-different-environments",level:2},{value:"<strong>Development/Test Environments</strong>",id:"developmenttest-environments",level:3},{value:"<strong>Production Environments</strong>",id:"production-environments",level:3}];function l(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"storage-container-manager-disk-layout",children:"Storage Container Manager Disk Layout"})}),"\n",(0,i.jsx)(t.h2,{id:"overview",children:(0,i.jsx)(t.strong,{children:"Overview"})}),"\n",(0,i.jsx)(t.p,{children:"The Storage Container Manager (SCM) is responsible for managing the containers and pipelines. To perform these tasks reliably, SCM persists its state in a set of local directories."}),"\n",(0,i.jsx)(t.h2,{id:"core-metadata-configurations",children:(0,i.jsx)(t.strong,{children:"Core Metadata Configurations"})}),"\n",(0,i.jsx)(t.p,{children:"The following configuration keys define where the Storage Container Manager stores its persistent data. For production environments, it is recommended to host these directories on NVMe/SSDs to ensure high performance."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"ozone.scm.db.dirs"})}),": Specifies the dedicated location for the Storage Container Manager RocksDB."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"ozone.scm.ratis.storage.dir"})}),": Defines the storage location for Ratis (Raft) logs, which are essential for Storage Container Manager High Availability (HA)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"ozone.metadata.dirs"})}),": Serves as the default location for security-related metadata (keys and certificates) and is often used as a fallback if specific DB directories are not defined."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Ozone uses a hierarchical fallback system for configurations. Example the SCM looks for its CA location in this order:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"hdds.scm.ca.location"}),": The most specific: if this is set, it wins."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"hdds.scm.metadata.dirs"}),": SCM-wide metadata path."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"ozone.metadata.dirs"}),": Global fallback for all services."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"on-disk-directory-structure",children:(0,i.jsx)(t.strong,{children:"On-Disk Directory Structure"})}),"\n",(0,i.jsx)(t.p,{children:"A typical SCM metadata directory structure looks like the following:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:"/var/lib/hadoop-ozone/scm/\n\u251c\u2500\u2500 data/                            # Primary Metadata (ozone.scm.db.dirs)\n\u2502   \u251c\u2500\u2500 db.checkpoints/              # Point-in-time snapshots of SCM DB for external tools (e.g., Recon, HA)\n\u2502   \u251c\u2500\u2500 scm/\n\u2502   \u2502   \u2514\u2500\u2500 current/\n\u2502   \u2502       \u2514\u2500\u2500 VERSION              # SCM identity and clusterID\n\u2502   \u251c\u2500\u2500 scm.db/                      # Main RocksDB (Containers, Pipelines, etc.)\n\u2502   \u2502   \u251c\u2500\u2500 *.sst                    # Sorted String Table data files\n\u2502   \u2502   \u251c\u2500\u2500 CURRENT                  # Current manifest pointer\n\u2502   \u2502   \u251c\u2500\u2500 IDENTITY                 # DB Instance ID\n\u2502   \u2502   \u251c\u2500\u2500 MANIFEST-XXXXXX          # Database journal\n\u2502   \u2502   \u2514\u2500\u2500 OPTIONS-XXXXXX           # RocksDB runtime configuration\n\u2502   \u2514\u2500\u2500 snapshot/                    # Ephemeral DB snapshots\n\u251c\u2500\u2500 ozone-metadata/                  # Security Metadata (ozone.metadata.dirs)\n\u2502   \u2514\u2500\u2500 scm/\n\u2502       \u251c\u2500\u2500 ca/                      # Root/Primary CA credentials\n\u2502       \u2502   \u251c\u2500\u2500 certs/\n\u2502       \u2502   \u2502   \u2514\u2500\u2500 certificate.crt  # Primary CA certificate\n\u2502       \u2502   \u2514\u2500\u2500 keys/\n\u2502       \u2502       \u251c\u2500\u2500 private.pem      # CA Private key (keep secure)\n\u2502       \u2502       \u2514\u2500\u2500 public.pem\n\u2502       \u2514\u2500\u2500 sub-ca/                  # Sub-CA credentials for SCM HA\n\u2502           \u251c\u2500\u2500 certs/\n\u2502           \u2502   \u251c\u2500\u2500 <serial>.crt\n\u2502           \u2502   \u2514\u2500\u2500 CA-1.crt         # Linked Primary CA cert\n\u2502           \u2514\u2500\u2500 keys/\n\u2502               \u251c\u2500\u2500 private.pem\n\u2502               \u2514\u2500\u2500 public.pem\n\u2514\u2500\u2500 scm-ha/                          # Raft Logs (ozone.scm.ratis.storage.dir)\n    \u2514\u2500\u2500 <ratis-group-uuid>/          # Unique Ratis Ring ID\n        \u2514\u2500\u2500 current/\n            \u251c\u2500\u2500 log_0-0              # Closed Raft log segments\n            \u251c\u2500\u2500 log_inprogress_271   # Active Raft log segment\n            \u251c\u2500\u2500 raft-meta            # Raft persistence state\n            \u2514\u2500\u2500 raft-meta.conf       # Quorum membership info\n"})}),"\n",(0,i.jsx)(t.h2,{id:"detailed-component-breakdown",children:(0,i.jsx)(t.strong,{children:"Detailed Component Breakdown"})}),"\n",(0,i.jsx)(t.h3,{id:"1-rocksdb-scmdb",children:(0,i.jsxs)(t.strong,{children:["1. RocksDB (",(0,i.jsx)(t.code,{children:"scm.db"}),")"]})}),"\n",(0,i.jsx)(t.p,{children:"SCM uses an embedded RocksDB to store all mapping and state information. This database consists of several column families (tables):"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Pipelines:"})," Maps pipeline IDs to the list of Datanodes forming the pipeline."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Containers:"})," Maps container IDs to their state (Open/Closed), replication type, and owner."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Deleted Blocks:"})," A queue of blocks that have been marked for deletion and need to be cleaned up from Datanodes."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Valid Certificates:"})," Stores certificates issued by the SCM Certificate Authority (CA)."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Datanodes:"})," Tracks the registration and heartbeat status of all Datanodes in the cluster."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"2-the-version-file",children:(0,i.jsx)(t.strong,{children:"2. The VERSION File"})}),"\n",(0,i.jsxs)(t.p,{children:["The VERSION file is created during ",(0,i.jsx)(t.code,{children:"scm --init"}),'. The VERSION file serves as the SCM\'s "identity card" and is used to enforce cluster-wide consistency during the handshake process. When the SCM starts, it reads its ',(0,i.jsx)(t.code,{children:"clusterID"})," and ",(0,i.jsx)(t.code,{children:"scmUuid"})," from this file to verify it is authorized to manage the metadata in its local directory; subsequently, when Datanodes attempt to register, the SCM cross-references its own ",(0,i.jsx)(t.code,{children:"clusterID"})," and ",(0,i.jsx)(t.code,{children:"cTime"})," with the information provided by the Datanodes to prevent nodes from different clusters from accidentally joining and causing data corruption. Furthermore, the layoutVersion inside the file is critical for software upgrades, as it tells the SCM which on-disk metadata features are currently active, ensuring that the service doesn't attempt to process data formats it doesn't recognize or support."]}),"\n",(0,i.jsx)(t.p,{children:"Key fields include:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"nodeType"}),": Always SCM for this component."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"clusterID"}),": The unique identifier for the entire Ozone cluster."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"scmUuid"}),": The unique identifier for the SCM node."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"layoutVersion"}),": The software-specific data layout version."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"cTime"}),": To track when different components were formatted or upgraded. This prevents older versions of the software from accidentally trying to manage data created by a newer version (Layout Versioning)."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"A sample SCM version file looks like this"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-text",children:"#Fri Feb 13 10:58:02 PDT 2020\nnodeType=SCM\nscmUuid=fa1376f0-23ad-4cda-93d6-0c9fd79c7ae3\nclusterID=CID-2a3f36e8-506f-40eb-986e-bb79d188fd55\ncTime=1771013425196\nlayoutVersion=0\n"})}),"\n",(0,i.jsx)(t.h3,{id:"3-certificate-authority-ca",children:(0,i.jsx)(t.strong,{children:"3. Certificate Authority (CA)"})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"ozone-metadata/scm/ca"})," directory contains key and certs sub-directory, which are used to persist the certificate and the public/private key pairs of SCM. The SCM private key is used to sign the issued certificates and tokens. In the context of SCM HA, the SCM can be either Root CA that issues certificates for SCM instances (a.k.a Sub SCM) that issues certificates to Ozone Manager and Datanodes."]}),"\n",(0,i.jsx)(t.p,{children:"The issuing of certificates will be handled by SCM Ratis leader and the persistence of certificates into RocksDB will be replicated to SCM follower instances consistently."}),"\n",(0,i.jsx)(t.p,{children:"Among the SCM CA instances, there will be one designated as Primary SCM which acts as Root CA during SCM init. All the other SCM instances will be running bootstrap to get the Primary SCM issued SCM instance certificate."}),"\n",(0,i.jsxs)(t.p,{children:["The SCM metadata above below use the all-in-one ",(0,i.jsx)(t.code,{children:"ozone.metadata.dirs"})," without metadata DB on different drives.  As a result of that, the Primary SCM will have its metadata saved under ",(0,i.jsx)(t.code,{children:"<The path of ozone.metadata.dirs>/scm/ca"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["All the Sub SCM instances (including the one running on the primary SCM) security metadata are stored at ",(0,i.jsx)(t.code,{children:"<The path of ozone.metadata.dir>/scm/sub-ca"}),", with keys and certs under it, respectively. Here is an example of Sub SCM security metadata layout."]}),"\n",(0,i.jsx)(t.h3,{id:"4-ratis-logs",children:(0,i.jsx)(t.strong,{children:"4. Ratis Logs"})}),"\n",(0,i.jsxs)(t.p,{children:["When SCM High Availability (HA) is enabled, SCM uses ",(0,i.jsx)(t.strong,{children:"Apache Ratis"})," to replicate its state across the SCM quorum."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["The ",(0,i.jsx)(t.code,{children:"ratis/"})," directory contains the Raft log segments."]}),"\n",(0,i.jsxs)(t.li,{children:["Every write request (e.g., container allocation) is first appended to this log and replicated to followers before being applied to the local ",(0,i.jsx)(t.code,{children:"scm.db"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"5-dbcheckpoints",children:(0,i.jsxs)(t.strong,{children:["5. ",(0,i.jsx)(t.code,{children:"db.checkpoints"})]})}),"\n",(0,i.jsx)(t.p,{children:"The db.checkpoints directory serves as a dedicated storage area for point-in-time snapshots of the active SCM RocksDB. These snapshots are primarily used for Recon integration and High Availability (HA) synchronization; when the Recon service or a lagging SCM follower needs to catch up to the current cluster state, SCM creates a consistent checkpoint here using filesystem hard links. This allows the system to export the database state without pausing write operations or duplicating large data files, ensuring that metadata can be transferred across the network while the main service remains online and performant."}),"\n",(0,i.jsx)(t.h3,{id:"recommended-storage-configuration-mapping",children:"Recommended Storage Configuration Mapping"}),"\n",(0,i.jsxs)(t.p,{children:["The following properties in ",(0,i.jsx)(t.code,{children:"ozone-site.xml"})," control the disk layout:"]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Path Description"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Configuration Key"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Storage Type Recommendation"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Purpose"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"SCM Metadata Database"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"ozone.scm.db.dirs"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"NVMe (strongly recommended)"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Primary directory for SCM RocksDB and version files."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"SCM Ratis Logs"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"ozone.scm.ratis.storage.dir"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"NVMe or very fast SSD"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Holds the Raft write-ahead log (WAL) for SCM consensus. Every metadata mutation must be fsynced before commit. Slow disks increase write latency across the entire cluster because clients wait for quorum commit."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"General Ozone Metadata / Security Material"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"ozone.metadata.dirs"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"SSD preferred (HDD acceptable for small clusters)"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["If ",(0,i.jsx)(t.code,{children:"hdds.scm.ca.location"})," or ",(0,i.jsx)(t.code,{children:"hdds.scm.metadata.dirs"})," not configured, it will fallback to this configuration to create SCM CA certificates are stored."]})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"layout-implementation-for-different-environments",children:(0,i.jsx)(t.strong,{children:"Layout Implementation for Different Environments"})}),"\n",(0,i.jsx)(t.h3,{id:"developmenttest-environments",children:(0,i.jsx)(t.strong,{children:"Development/Test Environments"})}),"\n",(0,i.jsxs)(t.p,{children:['For simplicity, a single "All-in-One" location can be used by setting ',(0,i.jsx)(t.code,{children:"ozone.metadata.dirs"}),". All services (OM, SCM, DN) will store their metadata in sub-folders under this single path."]}),"\n",(0,i.jsx)(t.h3,{id:"production-environments",children:(0,i.jsx)(t.strong,{children:"Production Environments"})}),"\n",(0,i.jsxs)(t.p,{children:["It is strictly recommended to separate these directories. The ",(0,i.jsx)(t.code,{children:"scm.db"})," and Ratis logs should reside on high-IOPS storage (SSDs/NVMe) to minimize latency for namespace operations, while security certificates can remain on standard persistent storage."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Storage Type:"})," It is highly recommended to host the ",(0,i.jsx)(t.code,{children:"scm.db"})," and ",(0,i.jsx)(t.code,{children:"ratis/"})," directories on ",(0,i.jsx)(t.strong,{children:"NVMe or SAS SSDs"})," to minimize latency for block and container allocations."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Redundancy:"})," Use ",(0,i.jsx)(t.strong,{children:"RAID 1+0"})," (or ",(0,i.jsx)(t.strong,{children:"RAID 1"}),") (mirroring) for metadata disks to protect against local disk failure, even if SCM HA is enabled at the software layer. (Note: Typically ",(0,i.jsx)(t.strong,{children:"RAID 1+0"})," disks provide better performance compared to ",(0,i.jsx)(t.strong,{children:"RAID 1"}),")"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},62392:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(30758);const i={},r=s.createContext(i);function o(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);