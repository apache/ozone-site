"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[5575],{18826:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"user-guide/integrations/hadoop-distcp","title":"Hadoop DistCp","description":"Hadoop DistCp is a command-line, MapReduce-based tool for bulk data copying.","source":"@site/docs/04-user-guide/03-integrations/08-hadoop-distcp.md","sourceDirName":"04-user-guide/03-integrations","slug":"/user-guide/integrations/hadoop-distcp","permalink":"/docs/user-guide/integrations/hadoop-distcp","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/04-user-guide/03-integrations/08-hadoop-distcp.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_label":"DistCp"},"sidebar":"defaultSidebar","previous":{"title":"Trino","permalink":"/docs/user-guide/integrations/trino"},"next":{"title":"Administrator Guide","permalink":"/docs/administrator-guide/"}}');var t=o(86070),i=o(62392);const r={sidebar_label:"DistCp"},c="Hadoop DistCp",a={},d=[{value:"Basic Usage",id:"basic-usage",level:2},{value:"Copy from HDFS to Ozone",id:"copy-from-hdfs-to-ozone",level:2},{value:"Copy from Ozone to HDFS",id:"copy-from-ozone-to-hdfs",level:2},{value:"Encrypted Data",id:"encrypted-data",level:2},{value:"Troubleshooting Common Issues",id:"troubleshooting-common-issues",level:2},{value:"Delegation Token Issues",id:"delegation-token-issues",level:3},{value:"Cross-Realm Kerberos (Ozone 1.x)",id:"cross-realm-kerberos-ozone-1x",level:3},{value:"Token Renewal Failures in Bidirectional Cross-Realm Trust Environments",id:"token-renewal-failures-in-bidirectional-cross-realm-trust-environments",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"hadoop-distcp",children:"Hadoop DistCp"})}),"\n",(0,t.jsx)(n.p,{children:"Hadoop DistCp is a command-line, MapReduce-based tool for bulk data copying."}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"hadoop distcp"})," command can be used to copy data to and from Ozone and any Hadoop-compatible file systems, such as HDFS or S3A."]}),"\n",(0,t.jsx)(n.h2,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,t.jsx)(n.p,{children:"To copy files from a source Ozone cluster directory to a destination Ozone cluster directory, use the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"hadoop distcp ofs://ozone1/vol1/bucket/dir1 ofs://ozone2/vol2/bucket2/dir2\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You must define the service IDs for both ",(0,t.jsx)(n.code,{children:"ozone1"})," and ",(0,t.jsx)(n.code,{children:"ozone2"})," clusters in the ",(0,t.jsx)(n.code,{children:"ozone-site.xml"})," configuration file. For example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>ozone.om.service.ids</name>\n  <value>ozone1,ozone2</value>\n</property>\n"})}),"\n",(0,t.jsx)(n.p,{children:"Next, define their logical mappings. For more details, refer to the OM High Availability documentation."}),"\n",(0,t.jsx)(n.h2,{id:"copy-from-hdfs-to-ozone",children:"Copy from HDFS to Ozone"}),"\n",(0,t.jsxs)(n.p,{children:["DistCp performs a file checksum check to ensure file integrity. However, since the default checksum type of HDFS (",(0,t.jsx)(n.code,{children:"CRC32C"}),") differs from that of Ozone (",(0,t.jsx)(n.code,{children:"CRC32"}),"), the file checksum check will cause the DistCp job to fail."]}),"\n",(0,t.jsx)(n.p,{children:"To prevent job failures, specify checksum options in the DistCp command to force Ozone to use the same checksum type as HDFS."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"hadoop distcp \\\n  -Ddfs.checksum.combine.mode=COMPOSITE_CRC \\\n  -Dozone.client.checksum.type=CRC32C \\\n  hdfs://ns1/tmp ofs://ozone1/vol1/bucket1/dst\n"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"}),"\nThe parameter ",(0,t.jsx)(n.code,{children:"-Ddfs.checksum.combine.mode=COMPOSITE_CRC"})," is not required if the HDFS cluster is running Hadoop 3.1.1 or later."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Alternatively, you can skip the file checksum check entirely:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"hadoop distcp \\\n  -skipcrccheck \\\n  hdfs://ns1/tmp ofs://ozone1/vol1/bucket1/dst\n"})}),"\n",(0,t.jsx)(n.h2,{id:"copy-from-ozone-to-hdfs",children:"Copy from Ozone to HDFS"}),"\n",(0,t.jsx)(n.p,{children:"When copying files from Ozone to HDFS, similar issues can occur due to differences in checksum types. In this case, you must configure the checksum type for HDFS, as it is the destination system."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"hadoop distcp \\\n  -Ddfs.checksum.combine.mode=COMPOSITE_CRC \\\n  -Ddfs.checksum.type=CRC32 \\\n  ofs://ozone1/vol1/bucket1/src hdfs://ns1/tmp/dst \n"})}),"\n",(0,t.jsx)(n.p,{children:"By specifying the appropriate checksum configuration or skipping the validation, you can ensure that DistCp jobs complete successfully when transferring data between HDFS and Ozone."}),"\n",(0,t.jsx)(n.h2,{id:"encrypted-data",children:"Encrypted Data"}),"\n",(0,t.jsxs)(n.p,{children:["When data resides in an HDFS encryption zone or Ozone encrypted buckets, the file checksum will not match. This is because the underlying block data differs due to the use of a new EDEK (Encryption Data Encryption Key) at the destination. In such cases, specify the ",(0,t.jsx)(n.code,{children:"-skipcrccheck"})," parameter to avoid job failures."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"}),"\nDistCp is supported between encrypted Ozone clusters starting with Ozone 2.0."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For more information about using Hadoop DistCp, consult the ",(0,t.jsx)(n.a,{href:"https://hadoop.apache.org/docs/current/hadoop-distcp/DistCp.html",children:"Hadoop DistCp Guide"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting-common-issues",children:"Troubleshooting Common Issues"}),"\n",(0,t.jsx)(n.h3,{id:"delegation-token-issues",children:"Delegation Token Issues"}),"\n",(0,t.jsx)(n.p,{children:"If a DistCp command fails and the error output contains \u201cOzoneToken\u201d, indicating an issue with retrieving a delegation token from the destination (or source) Ozone cluster, ensure that Ozone\u2019s security is explicitly enabled in the client\u2019s configuration."}),"\n",(0,t.jsxs)(n.p,{children:["Add the following property to ",(0,t.jsx)(n.code,{children:"ozone-site.xml"})," on the node where you run the DistCp command:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>ozone.security.enabled</name>\n  <value>true</value>\n</property>\n"})}),"\n",(0,t.jsx)(n.p,{children:"This helps the client correctly engage in secure communication protocols with Ozone."}),"\n",(0,t.jsx)(n.h3,{id:"cross-realm-kerberos-ozone-1x",children:"Cross-Realm Kerberos (Ozone 1.x)"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Affected Versions:"})," Ozone 1.x"]}),"\n",(0,t.jsxs)(n.p,{children:["When issuing DistCp commands (or other HDFS-compatible commands like ",(0,t.jsx)(n.code,{children:"hdfs dfs -ls"}),") against an Ozone cluster in a different Kerberos realm than the client or source/destination cluster, Ozone 1.x versions may produce an error similar to:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"24/02/07 18:47:36 INFO retry.RetryInvocationHandler: com.google.protobuf.ServiceException: java.io.IOException: DestHost:destPort host1.dst.example.com:9862, LocalHost:localPort host1.src.example.com/10.140.99.144:0. Failed on local exception: java.io.IOException: Couldn't set up IO streams: java.lang.IllegalArgumentException: Server has invalid Kerberos principal: om/host1.dst.example.com@DST.LOCAL, expecting: OM/host1.dst.example.com@REALM, while invoking $Proxy10.submitRequest over nodeId=om26,nodeAddress=host1.dst.example.com:9862 after 3 failover attempts. Trying to failover immediately.\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cause:"}),"\nThis typically occurs because the Ozone Manager\u2019s Kerberos principal (",(0,t.jsx)(n.code,{children:"ozone.om.kerberos.principal"}),") is not defined or interpreted in a way that accommodates cross-realm interactions. The client expects a principal from its own realm or a specifically trusted one, and a mismatch occurs. This issue is addressed in Ozone 2.0."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Workaround (for Ozone 1.x):"}),"\nTo resolve this in Ozone 1.x, add the following property to the ",(0,t.jsx)(n.code,{children:"ozone-site.xml"})," on the client machine running DistCp (and potentially on the Ozone Managers if they also need to inter-communicate across realms):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>ozone.om.kerberos.principal.pattern</name>\n  <value>*</value>\n</property>\n"})}),"\n",(0,t.jsx)(n.p,{children:"This configuration relaxes the principal matching, allowing the client to accept Ozone Manager principals from different realms."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Fix:"}),"\nThis bug is tracked by ",(0,t.jsx)(n.strong,{children:"HDDS-10328"})," and is fixed in Ozone 2.0 and later versions. Upgrading to Ozone 2.0+ is the recommended long-term solution."]}),"\n",(0,t.jsx)(n.h3,{id:"token-renewal-failures-in-bidirectional-cross-realm-trust-environments",children:"Token Renewal Failures in Bidirectional Cross-Realm Trust Environments"}),"\n",(0,t.jsx)(n.p,{children:"In environments with bidirectional cross-realm Kerberos trust, DistCp jobs (which run as MapReduce jobs) may fail during execution due to errors renewing delegation tokens. An example error is:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"24/02/08 00:35:00 ERROR tools.DistCp: Exception encountered\njava.io.IOException: org.apache.hadoop.yarn.exceptions.YarnException: Failed to submit application_1707350431298_0001 to YARN: Failed to renew token: Kind: HDFS_DELEGATION_TOKEN, Service: 10.140.99.144:8020, Ident: (token for systest: HDFS_DELEGATION_TOKEN owner=user1@SRC.EXAMPLE.COM, renewer=yarn, realUser=, issueDate=1707352474394, maxDate=1707957274394, sequenceNumber=44, masterKeyId=14)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This can happen when the MapReduce job attempts to renew a delegation token for a remote HDFS or Ozone filesystem, and the renewal fails due to cross-realm complexities. The ",(0,t.jsx)(n.code,{children:"Service"})," field in the error (e.g., ",(0,t.jsx)(n.code,{children:"10.140.99.144:8020"}),") usually indicates the filesystem whose token renewal failed."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"}),"\nYou can prevent the DistCp MapReduce job from attempting to renew delegation tokens for specific HDFS-compatible filesystems by using the ",(0,t.jsx)(n.code,{children:"-Dmapreduce.job.hdfs-servers.token-renewal.exclude"})," parameter. The value should be the authority (hostname or service ID) of the cluster whose tokens are causing renewal issues."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameter:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"-Dmapreduce.job.hdfs-servers.token-renewal.exclude=<authority_of_filesystem_to_exclude>\n"})}),"\n",(0,t.jsxs)(n.p,{children:["For an HDFS cluster, ",(0,t.jsx)(n.code,{children:"<authority_of_filesystem_to_exclude>"})," would be its NameNode address (e.g., ",(0,t.jsx)(n.code,{children:"namenode.example.com:8020"})," or just ",(0,t.jsx)(n.code,{children:"namenode.example.com"})," if the port is standard). For an Ozone cluster, it would be its service ID (e.g., ",(0,t.jsx)(n.code,{children:"ozoneprod"}),")."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Example:"}),"\nIf you are running the DistCp command on a YARN cluster associated with the destination Ozone cluster (",(0,t.jsx)(n.code,{children:"ofs://ozone1707264383/..."}),") and copying data from a source HDFS cluster (",(0,t.jsx)(n.code,{children:"hdfs://host1.src.example.com:8020/..."}),"), and the token renewal for the source HDFS cluster is failing:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"hadoop distcp \\\n  -Dmapreduce.job.hdfs-servers.token-renewal.exclude=host1.src.example.com \\\n  -Ddfs.checksum.combine.mode=COMPOSITE_CRC \\\n  -Dozone.client.checksum.type=CRC32C \\\n  hdfs://host1.src.example.com:8020/tmp/ \\\n  ofs://ozone1707264383/tmp/dest\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In this example, ",(0,t.jsx)(n.code,{children:"host1.src.example.com"})," is the authority of the source HDFS cluster, and its tokens will not be renewed by the DistCp MapReduce job. Adjust the value based on which cluster\u2019s (source or destination, HDFS or Ozone) token renewals are problematic."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},62392:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>c});var s=o(30758);const t={},i=s.createContext(t);function r(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);