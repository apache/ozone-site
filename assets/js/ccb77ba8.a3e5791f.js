"use strict";(self.webpackChunkdoc_site=self.webpackChunkdoc_site||[]).push([[2816],{62392:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var i=t(30758);const r={},a=i.createContext(r);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(a.Provider,{value:n},e.children)}},93964:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"administrator-guide/configuration/performance/streaming-write-pipeline","title":"Streaming Write Pipeline","description":"This document discusses the Streaming Write Pipeline feature in Ozone. It is implemented with the Ratis Streaming API.","source":"@site/docs/05-administrator-guide/02-configuration/04-performance/04-streaming-write-pipeline.md","sourceDirName":"05-administrator-guide/02-configuration/04-performance","slug":"/administrator-guide/configuration/performance/streaming-write-pipeline","permalink":"/docs/administrator-guide/configuration/performance/streaming-write-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ozone-site/tree/HDDS-9225-website-v2/docs/05-administrator-guide/02-configuration/04-performance/04-streaming-write-pipeline.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_label":"Streaming Write Pipeline"},"sidebar":"defaultSidebar","previous":{"title":"Multi-Raft","permalink":"/docs/administrator-guide/configuration/performance/multi-raft"},"next":{"title":"Appendix","permalink":"/docs/administrator-guide/configuration/appendix"}}');var r=t(86070),a=t(62392);const o={sidebar_label:"Streaming Write Pipeline"},s="Streaming Write Pipeline",l={},c=[{value:"Configuration Properties",id:"configuration-properties",level:2},{value:"Enable Streaming Write Pipeline",id:"enable-streaming-write-pipeline",level:3},{value:"Configure Datastream Port",id:"configure-datastream-port",level:3},{value:"Enable Filesystem Streaming",id:"enable-filesystem-streaming",level:3},{value:"Client APIs",id:"client-apis",level:2},{value:"OzoneDataStreamOutput",id:"ozonedatastreamoutput",level:3},{value:"OzoneBucket",id:"ozonebucket",level:3},{value:"createStreamKey",id:"createstreamkey",level:4},{value:"createMultipartStreamKey",id:"createmultipartstreamkey",level:4},{value:"Example",id:"example",level:3},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"streaming-write-pipeline",children:"Streaming Write Pipeline"})}),"\n",(0,r.jsx)(n.p,{children:"This document discusses the Streaming Write Pipeline feature in Ozone. It is implemented with the Ratis Streaming API."}),"\n",(0,r.jsx)(n.admonition,{title:"Write Pipeline Versions",type:"note",children:(0,r.jsx)(n.p,{children:"Note that the existing Ozone Write Pipeline is implemented with the Ratis Async API. We refer to the new Streaming Write Pipeline as Write Pipeline V2 and the existing Async Write Pipeline as Write Pipeline V1."})}),"\n",(0,r.jsx)(n.p,{children:"The Streaming Write Pipeline V2 increases the performance by providing better network topology awareness and removing the performance bottlenecks in V1. The V2 implementation also avoids unnecessary buffer copying (by Netty zero copy) and has a better utilization of the CPUs and the disks in each Datanode."}),"\n",(0,r.jsxs)(n.p,{children:["For detailed architectural information about write pipelines, see the ",(0,r.jsx)(n.a,{href:"../../../core-concepts/replication/write-pipelines",children:"Write Pipelines documentation"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"configuration-properties",children:"Configuration Properties"}),"\n",(0,r.jsxs)(n.p,{children:["Set the following properties to the Ozone configuration file ",(0,r.jsx)(n.code,{children:"ozone-site.xml"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"enable-streaming-write-pipeline",children:"Enable Streaming Write Pipeline"}),"\n",(0,r.jsxs)(n.p,{children:["To enable the Streaming Write Pipeline feature, set the following property to ",(0,r.jsx)(n.strong,{children:"true"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>hdds.container.ratis.datastream.enabled</name>\n  <value>true</value>\n  <description>Enable data stream of container</description>\n</property>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configure-datastream-port",children:"Configure Datastream Port"}),"\n",(0,r.jsx)(n.p,{children:"Datanodes listen to the following port for the streaming traffic:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>hdds.container.ratis.datastream.port</name>\n  <value>9855</value>\n  <description>The datastream port number of container</description>\n</property>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"enable-filesystem-streaming",children:"Enable Filesystem Streaming"}),"\n",(0,r.jsxs)(n.p,{children:["To use Streaming in FileSystem API, set the following property to ",(0,r.jsx)(n.strong,{children:"true"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<property>\n  <name>ozone.fs.datastream.enabled</name>\n  <value>true</value>\n  <description>\n    Enable filesystem write via ratis streaming.\n  </description>\n</property>\n"})}),"\n",(0,r.jsx)(n.h2,{id:"client-apis",children:"Client APIs"}),"\n",(0,r.jsx)(n.h3,{id:"ozonedatastreamoutput",children:"OzoneDataStreamOutput"}),"\n",(0,r.jsxs)(n.p,{children:["The new ",(0,r.jsx)(n.code,{children:"OzoneDataStreamOutput"})," class is very similar to the existing ",(0,r.jsx)(n.code,{children:"OzoneOutputStream"})," class, except that ",(0,r.jsx)(n.code,{children:"OzoneDataStreamOutput"})," uses ",(0,r.jsx)(n.code,{children:"ByteBuffer"})," as a parameter in the ",(0,r.jsx)(n.code,{children:"write"})," methods while ",(0,r.jsx)(n.code,{children:"OzoneOutputStream"})," uses ",(0,r.jsx)(n.code,{children:"byte[]"}),". The reason of using a ",(0,r.jsx)(n.code,{children:"ByteBuffer"}),", instead of a ",(0,r.jsx)(n.code,{children:"byte[]"}),", is to support zero buffer copying. A typical ",(0,r.jsx)(n.code,{children:"write"})," method is shown below:"]}),"\n",(0,r.jsx)(n.p,{children:"OzoneDataStreamOutput:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public void write(ByteBuffer b, int off, int len) throws IOException;\n"})}),"\n",(0,r.jsx)(n.p,{children:"OzoneOutputStream:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public void write(byte[] b, int off, int len) throws IOException;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Using ",(0,r.jsx)(n.code,{children:"ByteBuffer"})," enables zero-copy operations, reducing CPU overhead and improving throughput."]}),"\n",(0,r.jsx)(n.h3,{id:"ozonebucket",children:"OzoneBucket"}),"\n",(0,r.jsxs)(n.p,{children:["The following new methods are added to ",(0,r.jsx)(n.code,{children:"OzoneBucket"})," for creating keys using the Streaming Write Pipeline."]}),"\n",(0,r.jsx)(n.h4,{id:"createstreamkey",children:"createStreamKey"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public OzoneDataStreamOutput createStreamKey(String key, long size)\n    throws IOException;\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public OzoneDataStreamOutput createStreamKey(String key, long size,\n    ReplicationConfig replicationConfig, Map<String, String> keyMetadata)\n    throws IOException;\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public OzoneDataStreamOutput createStreamKey(String key, long size,\n    ReplicationConfig replicationConfig, Map<String, String> keyMetadata,\n    Map<String, String> tags) throws IOException;\n"})}),"\n",(0,r.jsx)(n.h4,{id:"createmultipartstreamkey",children:"createMultipartStreamKey"}),"\n",(0,r.jsx)(n.p,{children:"For multipart uploads:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public OzoneDataStreamOutput createMultipartStreamKey(String key, long size,\n    int partNumber, String uploadID) throws IOException;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note that the methods above have the same parameter list as the existing ",(0,r.jsx)(n.code,{children:"createKey"})," and ",(0,r.jsx)(n.code,{children:"createMultipartKey"})," methods."]}),"\n",(0,r.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,r.jsx)(n.p,{children:"Below is an example to create a key from a local file using a memory-mapped buffer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"// Create a memory-mapped buffer from a local file:\nfinal FileChannel channel = ...  // local file channel\nfinal long length = ...          // length of the data\nfinal ByteBuffer mapped = channel.map(FileChannel.MapMode.READ_ONLY, 0, length);\n\n// Create an OzoneDataStreamOutput\nfinal OzoneBucket bucket = ...   // an Ozone bucket\nfinal String key = ...           // the key name\nfinal OzoneDataStreamOutput out = bucket.createStreamKey(key, length);\n\n// Write the memory-mapped buffer to the key output\nout.write(mapped);\n\n// close\nout.close();      // In practice, use try-with-resource to close it.\nchannel.close();  // In practice, use try-with-resource to close it.\n"})}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"../../../core-concepts/replication/write-pipelines",children:"Write Pipelines"})," - Architectural overview of V1 and V2 pipelines"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"../../../user-guide/client-interfaces/java-client-api",children:"Java Client API"})," - General Ozone Java client documentation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://www.cloudera.com/blog/technical/ozone-write-pipeline-v2-with-ratis-streaming.html",children:"Ozone Write Pipeline V2 with Ratis Streaming"})," - Technical blog post"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);